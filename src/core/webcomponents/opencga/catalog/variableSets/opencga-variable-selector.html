<!--
  ~ Copyright 2018 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="opencga-variable-selector">

    <style>
        .ovs-list li.selected {
            background-color: #cdcdcd;
        }
    </style>

    <template>
        <div id="{{prefix}}-main-div">
            <template is="dom-if" if="{{variables.length}}">
                    <template is="dom-if" if="{{_config.addResetButton}}">
                        <button type="button" style="float: right; margin: 10px 10px 5px 0px;" class="btn btn-primary" on-click="resetSelection">Reset</button>
                    </template>

                    <label for="{{prefix}}-annotation-picker" style="margin-top: 15px;">{{_config.title}}</label>
                    <select class="selectpicker ovs-list" id="{{prefix}}-annotation-picker" data-live-search="true" data-size="10"
                            on-change="onChangeSelectedVariable" data-width="100%" data-class="btn-sm" multiple$="{{_config.multiSelection}}">
                        <template is="dom-repeat" items="{{variables}}" as="variable" on-dom-change="renderDomRepeat" restamp="true">
                            <option data-tokens="{{variable.tags}}" data-variable="{{variable}}"
                                    style$="padding-left: {{variable.margin}}px; cursor: {{variable.cursor}};"
                                    disabled$="{{variable.disabled}}">
                                {{variable.name}}
                            </option>
                        </template>
                    </select>
            </template>
        </div>
    </template>
    <script>

        class OpencgaVariableSelector extends Polymer.Element {

            constructor() {
                super();

                this._init();
            }

            static get is() {
                return 'opencga-variable-selector';
            }

            static get properties() {
                return {
                    variableSet: {
                        type: Array,
                        observer: "parseVariableForDisplay"
                    },
                    selected: {
                        type: Array
                    },
                    config: {
                        type: Object,
                        observer: "configObserver"
                    }
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            _init() {
                // super.ready();
                this.prefix = "ovs-" + Utils.randomString(6);

                this.variables = [];

                this.configObserver(this.config);
            }

            configObserver(parentConfig) {
                let config = {};
                Object.assign(config, this.getDefaultConfig(), parentConfig);
                this._config = config;
            }

            parseVariableForDisplay(variableSet) {
                this.variables = this._parseVariableForDisplay(variableSet.variables, [], this._config.variableSelector.marginLeft);

                // Select first allowed variable by default
                for (let i = 0; i < this.variables.length; i++) {
                    if (!this.variables[i].disabled) {
                        $(`#${this.prefix}-annotation-picker`).find(".selectpicker").selectpicker('deselectAll');
                        return;
                    }
                }
            }

            _parseVariableForDisplay(variables, tags, margin) {
                let displayVariables = [];

                for (let i in variables) {
                    let variable = variables[i];

                    if (variable.type !== "OBJECT") {
                        // let myTags = Array.from(new Set([variable.name, variable.title].concat(tags))).join(" ");

                        // Add variable
                        displayVariables.push({
                            id: variable.id,
                            name: UtilsNew.defaultString(variable.name, variable.id),
                            category: variable.category,
                            type: variable.type,
                            defaultValue: variable.defaultValue,
                            multiValue: variable.multiValue,
                            allowedValues: variable.allowedValues,
                            disabled: false,
                            margin: margin,
                            cursor: "pointer",
                            // tags: [variable.name, variable.title].concat(tags).join(" ")
                            // tags: myTags
                            // tags: tags + "." + variable.name
                            tags: tags.concat(variable.id).join(".")
                        });
                    } else {
                        // Add variable
                        displayVariables.push({
                            id: variable.id,
                            name: UtilsNew.defaultString(variable.name, variable.id),
                            category: variable.category,
                            type: variable.type,
                            defaultValue: variable.defaultValue,
                            multiValue: variable.multiValue,
                            allowedValues: variable.allowedValues,
                            disabled: this._config.onlyAllowLeafSelection,
                            margin: margin,
                            cursor: this._config.onlyAllowLeafSelection ? "default" : "pointer",
                            // tags: myTags
                            tags: tags.concat(variable.id).join(".")
                        });

                        displayVariables = displayVariables.concat(this._parseVariableForDisplay(variable.variableSet,
                            // [variable.name, variable.title].concat(tags), margin + this._config.variableSelector.marginStep));
                            tags.concat(variable.id), margin + this._config.variableSelector.marginStep));
                    }
                }
                return displayVariables;
            }

            renderDomRepeat(e) {
                let mainDiv = $(`#${this.prefix}-main-div`);

                let selectpicker = mainDiv.find(".selectpicker");
                selectpicker.selectpicker('refresh');
                selectpicker.selectpicker('deselectAll');

                // Add the class to the select picker buttons
                selectpicker.selectpicker('setStyle', this._config.buttonClass, 'add');
                // Add the class to the lists
                mainDiv.find("ul > li").addClass(this._config.class);
            }

            onChangeSelectedVariable(e) {
                let selectedVariables = [];
                for (let i = 0; i < e.currentTarget.selectedOptions.length; i++) {
                    selectedVariables.push(e.currentTarget.selectedOptions[i].dataVariable);
                }

                this.dispatchEvent(new CustomEvent('ovschange', {detail: {value: selectedVariables}}));
            }

            resetSelection(e) {
                let mainDiv = $(`#${this.prefix}-main-div`);
                let selectpicker = mainDiv.find(".selectpicker");

                selectpicker.selectpicker('refresh');
                selectpicker.selectpicker('deselectAll');
            }

            getDefaultConfig() {
                return {
                    title: "Select variable and value(s)",
                    multiSelection: false, // Select multiple fields
                    onlyAllowLeafSelection: true, // Only allow leaf selection
                    addResetButton: false,

                    class: "small",
                    buttonClass: "btn-sm",
                    inputClass: "input-sm",

                    variableSelector: {
                        marginLeft: 20,
                        marginStep: 15
                    },
                }
            }
        }

        customElements.define(OpencgaVariableSelector.is, OpencgaVariableSelector);
    </script>
</dom-module>
