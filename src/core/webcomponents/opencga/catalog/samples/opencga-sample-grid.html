<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../../../commons/opencb-grid-toolbar.html">

<dom-module id="opencga-sample-grid">
    <template>
        <style include="jso-styles"></style>

        <opencb-grid-toolbar from="{{from}}" to="{{to}}" num-total-results-text="{{numTotalResultsText}}"></opencb-grid-toolbar>

        <div id="{{prefix}}GridTableDiv" style="margin-top: 10px">
            <table id="{{prefix}}SampleBrowserGrid" style="cursor: pointer">
                <thead style="background-color: #eee"></thead>
            </table>
        </div>
    </template>

    <script>
        class OpencgaSampleGrid extends Polymer.Element {

            constructor() {
                super();
                this._init();
            }

            static get is() {
                return 'opencga-sample-grid';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object,
                        observer: "renderTable",
                    },
                    opencgaClient: {
                        type: Object,
                        observer: 'renderTable'
                    },
                    samples: {
                        type: Array,
                        notify: true,
                    },
                    filters: {
                        type: Object,
                        observer: "onFilterUpdate"
                    },
                    search: {
                        type: Object,
                        observer: 'renderTable'
                    },
                    eventNotifyName: {
                        type: String,
                        value: "messageevent"
                    },
                    config: {
                        type: Object,
                        observer: "configObserver"
                    },
                }
            }

            static get observers() {
                return [
                    'calculateFilters(filteredVariables.variables.*)',
                ];
            }

            _init() {
                this.prefix = "VarSampleGrid" + Utils.randomString(6);

                this._config = this.getDefaultConfig();
            }

            ready() {
                super.ready();

                this._initTableColumns();
                this.dispatchEvent(new CustomEvent('clear', {detail: {}, bubbles: true, composed: true}));
            }

            configObserver() {
                this._config = Object.assign(this.getDefaultConfig(), this.config);
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();

                this.table = PolymerUtils.getElementById(this.prefix + "SampleBrowserGrid");
                this.search = {};
            }

            renderTable() {
                this.set('samples', []);

                let filters = Object.assign({}, this.search);

                this.from = 1;
                this.to = 10;

                if (!!this.opencgaSession && !!this.opencgaSession.study && !!this.opencgaSession.study.fqn) {
                    // Make a copy of the samples (if they exist), we will use this private copy until it is assigned to this.samples
                    /*
                    if (UtilsNew.isNotUndefined(this.samples)) {
                        this._samples = this.samples;
                    } else {
                        this._samples = [];
                    }
                    */

                    // Check that HTTP protocol is present and complete the URL
                    let opencgaHostUrl = this.opencgaClient.getConfig().host;
                    if (!opencgaHostUrl.startsWith("http://") && !opencgaHostUrl.startsWith("https://")) {
                        opencgaHostUrl = 'http://' + opencgaHostUrl;
                    }
                    opencgaHostUrl += '/webservices/rest/v1/samples/search';

                    const _table = $('#' + this.prefix + 'SampleBrowserGrid');
                    const _this = this;
                    let skipCount = false;

                    $("#" + this.prefix + 'SampleBrowserGrid').bootstrapTable('destroy');
                    $("#" + this.prefix + 'SampleBrowserGrid').bootstrapTable({
                        url: opencgaHostUrl,
                        columns: _this._columns,
                        method: 'get',
                        sidePagination: 'server',
                        // detailView: false,
                        // Table properties
                        pagination: _this._config.pagination,
                        pageSize: _this._config.pageSize,
                        pageList: _this._config.pageList,
                        showExport: _this._config.showExport,
                        detailView: _this._config.detailView,
                        detailFormatter: _this._config.detailFormatter,

                        queryParams: params => {
                            const fieldsToIncludeInSample = [
                              'id', 'name', 'creationDate', 'status', 'type', 'sex', 'version', 'release', 'phenotypes',
                                'individual.id', 'individual.sex', 'individual.father', 'individual.mother', 'individual.phenotypes'
                            ];
                            // include: "id,creationDate,status,type,sex,version,release,individual.id,individual.sex,individual.father,individual.mother,individual.phenotypes"
                            // from opencb
                            skipCount = (this.pageNumber > 1);
                            const auxParams = {
                                uniqueId: "id",
                                study: _this.opencgaSession.study.fqn,
                                // lazy: "false",
                                sid: Cookies.get(_this.opencgaClient.getConfig().cookieSessionId),
                                // order: params.order,
                                // sort: params.sort,
                                order: "desc",
                                sort: "creationDate",
                                limit: params.limit,
                                skip: params.offset,
                                includeIndividual: true,
                                include: fieldsToIncludeInSample.join(','),
                                skipCount: skipCount,
                            };
                            return Object.assign(filters || {}, auxParams);
                        },
                        responseHandler: response => {
                            if (!skipCount) {
                                if (!_this.hasOwnProperty("numTotalResults")) {
                                   _this.numTotalResults = 0;
                                }
                                if (_this.numTotalResults !== response.response[0].numTotalResults && response.queryOptions.skip === 0) {
                                    _this.numTotalResults = response.response[0].numTotalResults;
                                }
                            }

                            _this.numTotalResultsText = _this.numTotalResults.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                            if(response.queryOptions.skip === 0 && _this.numTotalResults < response.queryOptions.limit){
                                _this.from = 1;
                                _this.to = _this.numTotalResults;
                            }

                            return {
                                total: _this.numTotalResults,
                                rows: response.response[0].result
                            };
                        },
                        onClickRow: function (row, element, field) {
                            if (_this._config.multiselection) {
                                $(element).toggleClass('success');
                                let index = element[0].getAttribute("data-index");
                                // Check and uncheck actions trigger events that are captured below
                                if ("selected" === element[0].className) {
                                    $(PolymerUtils.getElementById(_this.prefix + 'SampleBrowserGrid')).bootstrapTable('uncheck', index);
                                } else {
                                    $(PolymerUtils.getElementById(_this.prefix + "SampleBrowserGrid")).bootstrapTable('check', index);
                                }
                            } else {
                                $('.success').removeClass('success');
                                $(element).addClass('success');
                            }

                            _this._onSelectSample(row);
                        },
                        onCheck: function (row, elem) {
                            if (!_this.samples.find(sample => (sample.name === row.name))) {
                                const newSamples = _this.samples.slice();
                                newSamples.push(row);
                                _this.set('samples', newSamples);
                            }
                        },
                        onUncheck: function (row, elem) {
                            const sampleToDeleteIdx = _this.samples.findIndex(sample => (sample.name === row.name));
                            if (-1 != sampleToDeleteIdx) {
                                const newSamples = _this.samples.slice();
                                newSamples.splice(sampleToDeleteIdx, 1);
                                _this.set('samples', newSamples);
                            }
                        },
                        onCheckAll: function (rows) {
                            const newSamples = _this.samples.slice();
                            rows.forEach(row => {
                                if (!_this.samples.find(sample => row.id === sample.id)) {
                                    newSamples.push(row);
                                }
                            });
                            if (newSamples.length !== _this.samples.length) {
                                _this.set('samples', newSamples);
                            }
                        },
                        onUncheckAll: function (rows) {
                            const newSamples = _this.samples.filter(sample => (!rows.some(row => (row.name === sample.name))));
                            if (newSamples.length !== _this.samples.length) {
                                _this.set('samples', newSamples);
                            }
                        },
                        onLoadSuccess: data => {
                            // Check all already selected rows. Selected samples are stored in this.samples array
                            if (!!_table) {
                                if (!_this._config.multiselection) {
                                    PolymerUtils.querySelector(_table.selector).rows[1].setAttribute('class', 'success');
                                    _this._onSelectSample(data.rows[0]);
                                }
                                if (!!_this.samples) {
                                    for (const idx in _this.samples) {
                                        for (const j in data.rows) {
                                            if (_this.samples[idx].id === data.rows[j].id) {
                                                $(PolymerUtils.getElementById(_this.prefix + 'SampleBrowserGrid')).bootstrapTable('check', j);
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        onPageChange: function (page, size) {
                            _this.from = (page - 1) * size + 1;
                            _this.to = page * size;
                        },
//                         onPostBody: function() {
//                             if(PolymerUtils.getElementsByClassName(_this.prefix + 'Download')) {
//                                 PolymerUtils.querySelectorAll("." + _this.prefix + "Download").forEach(elem => elem.addEventListener("click", _this.downloadQCFile.bind(_this), true));
//
// //                                PolymerUtils.getElementById(_this.prefix + 'Download').addEventListener('click', _this.downloadQCFile.bind(_this));
//                             }
//                         }
                    });

                    this.opencgaClient.studies().info(this.opencgaSession.study.id)
                        .then(function (response) {
                            _this.variableSets = response.response[0].result[0].variableSets;
                        })
                        .catch(function () {
                            console.log("Could not obtain the variable sets of the study " + _this.opencgaSession.study.id);
                        });
                } else {
                    // Delete table
                    $(PolymerUtils.getElementById(this.prefix + 'SampleBrowserGrid')).bootstrapTable('destroy');
                    this.numTotalResults = 0;
                }
            }

            /**
             * If filters have been removed, clean the values from the forms.
             */
            onFilterUpdate() {
                this.updateForms(this.filters);
            }

            _onSelectSample(row) {
                if (typeof row !== "undefined") {
                    this.dispatchEvent(new CustomEvent('selectsample', {detail: {id: row.id, sample: row}}));
                }
            }

            updateForms(filters) {
                // This is just to avoid entering here when it has just been initialized
                if (UtilsNew.isUndefined(this.prefix)) {
                    return;
                }

                let sampleName = PolymerUtils.getValue(this.prefix + "NameTextarea");
                if (!filters.hasOwnProperty("name") && UtilsNew.isNotUndefined(sampleName) && sampleName.length > 0) {
                    PolymerUtils.getElementById(this.prefix + "NameTextarea").value = "";
                }

                let individual = PolymerUtils.getValue(this.prefix + "IndividualTextarea");
                if (!filters.hasOwnProperty("individual.id") && UtilsNew.isNotUndefined(individual) && individual.length > 0) {

                    PolymerUtils.setValue(this.prefix + "IndividualTextarea", "");
                }

                if (this.filteredVariables.variables.length > 0) {
                    if (!filters.hasOwnProperty("annotation")) {
                        // Remove the filter variableSetId as it won't make more sense.
                        this.set("filteredVariables.variables", []);

                    } else if (filters.annotation.length < this.filteredVariables.variables.length) {
                        let tmpVariables = [];
                        filters.annotation.forEach(function (variable) {
                            tmpVariables.push(variable);
                        });

                        this.set("filteredVariables.variables", tmpVariables);
                    }
                }
            }

            /**
             * Read from the values in the forms, and sets the filters.
             */
            calculateFilters() {
                let filters = {};
                let sampleName = "";
                let individual = "";

                if (PolymerUtils.getElementById(this.prefix + "NameTextarea") !== null) {
                    sampleName = PolymerUtils.getElementById(this.prefix + "NameTextarea").value;
                }
                if (PolymerUtils.getElementById(this.prefix + "IndividualTextarea") !== null) {
                    individual = PolymerUtils.getElementById(this.prefix + "IndividualTextarea").value;
                }

                if (UtilsNew.isNotUndefined(sampleName) && sampleName.length > 0) {
                    filters["name"] = "~" + sampleName;
                }

                if (UtilsNew.isNotUndefined(individual) && individual.length > 0) {
                    filters["individual.id"] = "~" + individual;
                }

                if (UtilsNew.isNotUndefined(this.filteredVariables.variables) && this.filteredVariables.variables.length > 0) {
//                    filters["variableSetId"] = this.filteredVariables.variableSet;
                    let annotations = [];
                    this.filteredVariables.variables.forEach(function (variable) {
                        annotations.push(variable);
                    });
                    filters["annotation"] = annotations;
                }
                this.filters = filters;
            }

            onSearch() {
                // Convert the filters to an objectParam that can be directly send to the sample search
                let filterParams = {};

                let keys = Object.keys(this.filters);
                for (let i = 0; i < keys.length; i++) {
                    // Some filters can come as an array of things.
                    // annotation = [{name: name, value: Smith}, {name: age, value: >5}]
                    if (Array.isArray(this.filters[keys[i]])) {
                        let myArray = this.filters[keys[i]];

                        let myArrayFilter = [];

                        // The elements in the array can be either an object
                        if (Object.getPrototypeOf(myArray[0]) === Object.prototype) {
                            let myArray = this.filters[keys[i]];
                            for (let j = 0; j < myArray.length; j++) {
                                // TODO: We have to check if the value already has an operand
                                myArrayFilter.push(myArray[j].name + "=" + myArray[j].value);
                            }
                        } else {
                            // Or an array of strings or numbers
                            myArrayFilter = this.filters[keys[i]];
                        }

                        filterParams[keys[i]] = myArrayFilter.join(";");
                    } else {
                        filterParams[keys[i]] = this.filters[keys[i]];
                    }
                }

                if (this.filters.hasOwnProperty("annotation")) {
                    // Add the variable set whose annotations will be queried
                    filterParams["variableSetId"] = this.filteredVariables.variableSet;
                }

                this.search = filterParams;
            }


            stateFormatter(value, row, index) {
                if (typeof this.field.context.samples != "undefined") {
                    for (let idx in this.field.context.samples) {
                        if (this.field.context.samples[idx].name == row.name) {
                            break;
                        }
                    }
                }
            }

            individualFormatter(value, row) {
                if (UtilsNew.isNotUndefined(row.attributes) && UtilsNew.isNotUndefined(row.attributes.individual)
                    && UtilsNew.isNotUndefined(row.attributes.individual.id)) {
                    return row.attributes.individual.id;
                } else {
                    return '-'
                }
            }

            dateFormatter(value, row) {
                return moment(value, "YYYYMMDDHHmmss").format('D MMM YYYY');
            }

            diagnosisFormatter(value, row) {
                const diseases = ((!!row.attributes && !!row.attributes.individual && row.attributes.individual.phenotypes) || [])
                    .filter(disease => disease.source === "ICD10")
                    .map(disease => disease.name);
                return diseases.length > 0 ? diseases.join(',') : '-';
            }

            hpoFormatter(value, row) {
                const diseases = ((!!row.attributes && !!row.attributes.individual && row.attributes.individual.phenotypes) || [])
                    .filter(disease => disease.source === "HPO")
                    .map(disease => disease.name);
                return diseases.length > 0 ? diseases.join(',') : '-';
            }

            fatherFormatter(value, row) {
                return (!!row.individual && !!row.individual.father && row.individual.father.id>0)
                    ? row.attributes.individual.father.id
                    : '-';
            }

            motherFormatter(value, row) {
                return (!!row.individual && !!row.individual.mother && row.individual.mother.id>0)
                    ? row.attributes.individual.mother.id
                    : '-';
            }

            cellTypeFormatter(value, row) {
                return (row.somatic) ? "Somatic" : "Germline";
            }

            // TODO: both downloadFormatter and downloadQCFile come from mmp
            // and apparently are not used, so we should just remove them
            // but I am not sure if the merge guess was correct on this

            /*
            downloadFormatter(value, row) {
                return '<button role="button" type="button" class="'+this.prefix + 'Download btn btn-sm btn-primary" data-sample-name="'+row.name +'" ><i class="fa fa-download"  data-sample-name="' + row.name + '" aria-hidden="true"></i>&nbsp;Download</button>';
            }

            downloadQCFile(e) {
                let name = e.target.getAttribute('data-sample-name') + ".QC.tar.gz";
                let study = this.project.alias + ":" + this.study.alias;
                let sid =  Cookies.get(this.opencgaClient.getConfig().cookieSessionId);
                let opencgaHostUrl = this.opencgaClient.getConfig().host;
                if (!opencgaHostUrl.startsWith("http://") && !opencgaHostUrl.startsWith("https://")) {
                    opencgaHostUrl = 'http://' + opencgaHostUrl;
                }
                opencgaHostUrl += '/webservices/rest/v1/files/';

                let paramsInfo= {
                    study: study
                };

                this.opencgaClient.files().info(name, paramsInfo)
                    .then((response) => {
                        if (response.response.length > 0) {
                            let url = opencgaHostUrl + name + "/download?sid=" + sid + "&study=" + study;
                            let a = document.createElement("a");
                            a.href = url;
                            a.download = name;
                            document.body.appendChild(a);
                            a.click();
                        } else {
                            this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                                detail: {
                                    message: name + " not found.",
                                    type: UtilsNew.MESSAGE_ERROR
                                },
                                bubbles: true,
                                composed: true
                            }));
                        }
                    })
                    .catch((response) => {
                        this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                            detail: {
                                message: name + " not found.",
                                type: UtilsNew.MESSAGE_ERROR
                            },
                            bubbles: true,
                            composed: true
                        }));
                    });

            }
            */

            _initTableColumns() {
                let columns = [];
                if (this._config.multiselection) {
                    columns.push({
                        field: {source: 'state', context: this},
                        checkbox: true,
                        formatter: this.stateFormatter
                    });
                }

                this._columns = [
                    columns.concat([
                        {
                            title: 'Sample',
                            field: 'name'
                        },
                        {
                            title: 'Individual ID',
                            field: 'attributes.individual.id',
                            formatter: this.individualFormatter
                        },
                        {
                            title: 'Date',
                            field: 'creationDate',
                            formatter: this.dateFormatter
                        },
                        {
                            title: 'Status',
                            field: 'status.name'
                        },
                        {
                            title: 'Sex',
                            field: 'attributes.individual.sex'
                        },
                        {
                            title: 'Diagnosis',
                            formatter: this.diagnosisFormatter
                        },
                        {
                            title: 'HPO',
                            formatter: this.hpoFormatter
                        },
                        {
                            title: 'Father',
                            formatter: this.fatherFormatter,
                        },
                        {
                            title: 'Mother',
                            formatter: this.motherFormatter,
                        },
                        {
                            title: 'Cell Line',
                            formatter: this.cellTypeFormatter,
                            visible: false,
                        },
                        {
                            title: 'Type',
                            visible: false,
                            field: 'type'
                        },
                        {
                            title: 'Release',
                            visible: false,
                            field: 'release'
                        },
                        {
                            title: 'Version',
                            visible: false,
                            field: 'version'
                        }
                    ])
                ];

                return this._columns;
            }

            getDefaultConfig() {
                return {
                    pagination: true,
                    pageSize: 10,
                    pageList: [10, 25, 50],
                    showExport: false,
                    detailView: false,
                    detailFormatter: undefined, // function with the detail formatter
                    multiselection: true,
                }
            }
        }

        customElements.define(OpencgaSampleGrid.is, OpencgaSampleGrid);
    </script>
</dom-module>
