<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="opencga-facet-view">
    <template>
        <style include="jso-styles"></style>

        <div style="padding: 5px 10px">
            <!--<h3>{{facetResult.name}}</h3>-->
            <div class="btn-group" style="float: right">
                <span id="{{prefix}}HistogramChartButton" class="btn btn-primary plots active" on-click="renderHistogramChart">
                    <i class="fa fa-bar-chart" style="padding-right: 5px" title="Bar Chart" data-id="{{facetResult.name}}"></i>
                </span>
                <!--<template is="dom-if" if="{{item.renderPieChart}}">-->
                <span id="{{prefix}}PieChartButton" class="btn btn-primary plots" on-click="onPieChart">
                    <i class="fa fa-pie-chart" style="padding-right: 5px" title="Pie Chart" data-id="{{facetResult.name}}"></i>
                </span>
                <!--</template>-->
                <span id="{{prefix}}TableButton" class="btn btn-primary plots" on-click="onTabularView">
                    <i class="fa fa-table" style="padding-right: 5px" title="Tabular View" data-id="{{facetResult.name}}"></i>
                </span>
            </div>
            <div id="{{prefix}}Plot"></div>

            <!--Table-->
            <br>
            <table id="{{prefix}}Table" class="table table-bordered" style="display: none;">

                <!-- Facet Field Table -->
                <template is="dom-if" if="{{checkField(item.category)}}">
                    <thead class="table-header bg-primary">
                    <tr>
                        <th>{{item.title}}</th>
                        <template is="dom-if" if="{{subFieldExists(item.subField)}}">
                            <th>{{item.subField}}</th>
                        </template>
                        <th>Number of Variants</th>
                    </tr>
                    </thead>
                    <tbody>
                    <template is="dom-repeat" items="{{facetResult.buckets}}" as="count">
                        <template is="dom-if" if="{{fieldExists(count)}}">
                            <tr>
                                <td rowspan$="{{countSubFields(count)}}">{{count.value}}</td>
                            </tr>

                            <template is="dom-repeat" items="{{count.field.counts}}" as="subFieldCount">
                                <tr>
                                    <td>{{subFieldCount.value}}</td>
                                    <td>{{subFieldCount.count}}</td>
                                </tr>
                            </template>
                        </template>

                        <template is="dom-if" if="{{!fieldExists(count)}}">
                            <tr>
                                <td>{{count.value}}</td>
                                <td>{{count.count}}</td>
                            </tr>
                        </template>
                    </template>
                    </tbody>
                </template>

                <!-- Facet Range Table -->
                <template is="dom-if" if="{{!checkField(item.category)}}">
                    <thead class="table-header bg-primary">
                    <tr>
                        <th>Range</th>
                        <th>Number of Variants</th>
                    </tr>
                    </thead>
                    <tbody>
                    <template is="dom-repeat" items="{{item.data}}" as="data">
                        <tr>
                            <td>{{data.range}}</td>
                            <td>{{data.count}}</td>
                        </tr>
                    </template>
                    </tbody>
                </template>
            </table>
        </div>

    </template>

    <script>
        class OpencgaFacetView extends Polymer.Element {

            constructor() {
                super();

                // Set status and init private properties
                this._init();
            }

            static get is() {
                return 'opencga-facet-view'
            };

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    facetResult: {
                        type: Object,
                    },
                    active: {
                        type: Boolean,
                    },
                    config: {
                        type: Object,
                    }
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();

                this.renderFacets();
            }

            /**
             * Init the variables you need, keep in mind this is executed before the actual Polymer properties exist
             */
            _init() {
                // All id fields in the template must start with prefix, this allows components to be instantiated more than once
                this.prefix = "ofv" + Utils.randomString(6);

                this.plotDiv = "#" + this.prefix + "Plot";

                // Initially we set the default config, this will be overridden if 'config' is passed
                this._config = this.getDefaultConfig();
            }

            static get observers() {
                return [
                    'renderFacets(facetResult, active, config)'
                ]
            }

            renderFacets(e, active, conf) {
                this._config = Object.assign(this.getDefaultConfig(), this.config);

                this.renderHistogramChart();
            }

            // onHistogramChart() {
            //     // this.highlightActivePlot(e.target.parentElement);
            //     // let id = e.target.dataId;
            //     //TODO Refactor
            //     // debugger
            //     this.renderHistogramChart("#" + this.prefix + "Plot");
            //
            //     PolymerUtils.hide(this.prefix + "Table");
            // }

            onPieChart(e) {
                // this.highlightActivePlot(e.target.parentElement);
                // let id = e.target.dataId;
                this.renderPieChart("#" + this.prefix + "Plot");
                PolymerUtils.hide(this.prefix + "Table");
            }

            onTabularView(e) {
                // this.highlightActivePlot(e.target.parentElement);
                // let id = e.target.dataId;
                PolymerUtils.innerHTML(this.prefix + "Plot", "");
                PolymerUtils.show(this.prefix + "Table", "table");
            }


            highlightActivePlot(button) {
                // PolymerUtils.removeClass(".plots", "active");
                // PolymerUtils.addClass(button, "active");
            }

            renderHistogramChart() {
                PolymerUtils.hide(this.prefix + "Table");
                // PolymerUtils.removeStyleByClass("plots", "active");
                // PolymerUtils.removeClass(this.prefix + "HistogramChartButton", "active");
                // PolymerUtils.removeClass(".plots", "active");

                let params = this._getHistogramData();

                $(this.plotDiv).highcharts({
                    credits: {enabled: false},
                    chart: {
                        type: "column"
                    },
                    title: {
                        text: params.title || params.name
                    },
                    xAxis: {
                        categories: params.categories
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: 'Total number of Variants'
                        }
                    },
                    tooltip: {
                        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                            '<td style="padding:0"><b>{point.y:.1f} </b></td></tr>',
                        footerFormat: '</table>',
                        shared: true,
                        useHTML: true
                    },
                    plotOptions: {
                        column: {
                            pointPadding: 0.2,
                            borderWidth: 0
                        }
                    },
                    series: params.series
                });
            }

            renderPieChart(div, id) {
                let params;
                let renderDonut = false;
                if (UtilsNew.isNotUndefined(this.facetResult) && UtilsNew.isNotUndefined(this.facetResult.buckets[0].facetFields)) {
                    params = this._getDonutData(id);
                    renderDonut = true;
                } else {
                    params = this._getPieData(id);
                }

                if (renderDonut) {
                    $(this.plotDiv).highcharts({
                        credits: {enabled: false},
                        chart: {
                            type: 'pie'
                        },
                        title: {
                            text: params.title || params.name
                        },
                        plotOptions: {
                            pie: {
                                shadow: false,
                                center: ['50%', '50%']
                            }
                        },
                        series: params.series
                    });
                } else {
                    $(div).highcharts({
                        credits: {enabled: false},
                        chart: {
                            plotBackgroundColor: null,
                            plotBorderWidth: null,
                            plotShadow: false,
                            type: 'pie'
                        },
                        title: {
                            text: params.title
                        },
                        tooltip: {
                            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                        },
                        plotOptions: {
                            pie: {
                                allowPointSelect: true,
                                cursor: 'pointer',
                                dataLabels: {
                                    enabled: false
                                },
                                showInLegend: true
                            }
                        },
                        series: params.series
                    });
                }
            }

            _getHistogramData() {
                let params;
                if (this.facetResult.start === undefined) {
                    let field = this.facetResult;
                    let fields = field.name.split("-");
                    let title = [];
                    // if (fields.length > 1) {
                    //     for (let name of fields) {
                    //         title.push(this.fieldNamesMap[name]);
                    //     }
                    // } else {
                    //     title.push(this.fieldNamesMap[field.name]);
                    // }
                    let obj = {
                        title: field.name,
                        name: field.name,
                        categories: [],
                        series: []
                    };
                    let series = {};
                    let data = [];
                    for (let i = 0; i < field.buckets.length; i++) {
                        let bucket = field.buckets[i];
                        obj.categories.push(bucket.value);
                        if (UtilsNew.isNotEmptyArray(bucket.facetFields)) {
                            let nestedField = bucket.facetFields[0];
                            obj.nestedField = nestedField.name;
                            for (let nestedCountObj of nestedField.buckets) {
                                if (UtilsNew.isUndefined(series[nestedCountObj.value])) {
                                    series[nestedCountObj.value] = [];
                                }
                                // It is important to push 'index' as we need to take care of the missing values
                                series[nestedCountObj.value].push({index: i, count: nestedCountObj.count});
                            }
                        } else {
                            data.push(bucket.count);
                        }
                    }

                    if (Object.keys(series).length > 0) {
                        for (let key in series) {
                            let data = [];
                            for (let countIndex of series[key]) {
                                data[countIndex.index] = countIndex.count;
                            }
                            for (let i = 0; i < data.length; i++) {
                                if (UtilsNew.isUndefined(data[i])) {
                                    data[i] = 0; // Setting '0' for missing fields
                                }
                            }
                            obj.series.push({name: key, data: data});
                        }
                    } else {
                        obj.series.push({name: field.name, data: data});
                    }
                    params = obj;
                } else if (this.facetResult.start !== undefined) {
                    let range = this.facetResult;
                    let obj = {
                        name: range.name,
                        title: this.fieldNamesMap[range.name] || range.name,
                        categories: [],
                        series: [],
                    };
                    let data = [];
                    let start = Number(range.start);
                    for (let rangeCount of range.counts) {
                        if (Math.round(start) !== start) {
                            start = Number(start.toFixed(1));
                        }
                        let end = Number(start + range.gap);
                        if (Math.round(end) !== end) {
                            end = Number(end.toFixed(1));
                        }
                        obj.categories.push(start + "-" + end);
                        data.push(rangeCount);
                        start = end;
                    }
                    obj.series.push({name: range.name, data: data});
                    params = obj;
                }
                return params;
            }

            _getPieData(id) {
                let field = this.facetResults[id];
                let pieData = {
                    name: field.name,
                    title: this.fieldNamesMap[field.name],
                    series: []
                };
                let data = [];
                for (let countObj of field.counts) {
                    data.push({name: countObj.value, y: countObj.count});
                }
                pieData.series.push({
                    name: field.name,
                    colorByPoint: true,
                    data: data
                });

                return pieData;
            }

            _getDonutData(id) {
                let field = this.facetResult;
                let fields = field.name.split("-");
                let title = [];
                // if (fields.length > 1) {
                //     for (let name of fields) {
                //         title.push(this.fieldNamesMap[name]);
                //     }
                // } else {
                //     title.push(this.fieldNamesMap[field.name]);
                // }
                let donutData = {
                    name: field.name,
                    title: title.join(" - "),
                    series: []
                };

                let colors = Highcharts.getOptions().colors;
                let categories = [];
                let data = [];
                for (let i = 0; i < field.buckets.length; i++) {
                    let fieldObj = field.buckets[i];
                    debugger

                    categories.push(fieldObj.value);
                    let subField = fieldObj.field;
                    let subCategories = [];
                    let subData = [];
                    for (let countObj of subField.counts) {
                        subCategories.push(countObj.value);
                        subData.push(countObj.count);
                    }
                    data.push({
                        y: fieldObj.count,
                        color: colors[i],
                        drilldown: {
                            name: subField.name,
                            categories: subCategories,
                            data: subData,
                            color: colors[i]
                        }
                    });
                }
                let levelOneData = [];
                let levelTwoData = [];

                // Build the data arrays
                for (let i = 0; i < data.length; i++) {
                    // add level one data
                    levelOneData.push({
                        name: categories[i],
                        y: data[i].y,
                        color: data[i].color
                    });

                    // add level two data
                    let drillDataLen = data[i].drilldown.data.length;
                    for (let j = 0; j < drillDataLen; j++) {
                        let brightness = 0.2 - (j / drillDataLen) / 5;
                        levelTwoData.push({
                            name: data[i].drilldown.categories[j],
                            y: data[i].drilldown.data[j],
                            color: Highcharts.Color(data[i].color).brighten(brightness).get()
                        });
                    }
                }

                let [levelOneField, levelTwoField] = field.name.split("-");
                donutData.series.push({
                    name: levelOneField,
                    data: levelOneData,
                    size: '60%',
                    dataLabels: {
                        formatter: function () {
                            return this.y > 5 ? this.point.name : null;
                        },
                        color: '#ffffff',
                        distance: -30
                    }
                });
                donutData.series.push({
                    name: levelTwoField,
                    data: levelTwoData,
                    size: '80%',
                    innerSize: '60%',
                    dataLabels: {
                        formatter: function () {
                            // display only if larger than 1
                            return this.y > 1 ? '<b>' + this.point.name + ':</b> ' + this.y : null;
                        }
                    }
                });
                return donutData;
            }

            getDefaultConfig() {
                return {
                    property: "example property"
                };
            }
        }

        customElements.define(OpencgaFacetView.is, OpencgaFacetView);
    </script>
</dom-module>