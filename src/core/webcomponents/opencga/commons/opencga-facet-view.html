<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../commons/opencga-facet-result-view.html">
<link rel="import" href="../commons/opencga-facet-view-selector.html">

<dom-module id="opencga-facet-view">
    <template>
        <style include="jso-styles">
            option:disabled {
                font-size: 0.85em;
                font-weight: bold;
            }

            .active-filter-button:hover {
                text-decoration: line-through;
            }
        </style>


        <!-- Facet Fields -->

        <div class="row">
            <template is="dom-if" if="{{isNotEmpty(_config.defaultStats)}}">
                <div class="col-md-12">
                    <h3>Default Stats</h3>
                    <h4>Compute default stats <button type="button" class="btn btn-primary" on-click="addDefaultStats" style="cursor: pointer">Add</button></h4>

                </div>
            </template>

            <div class="col-md-12">
                <h3>Fields</h3>

                <div class="row">
                    <div class="col-md-5" style="padding: 0px 30px 0px 20px">
                        <opencga-facet-view-selector id="{{prefix}}-ofvs-first" terms="{{dataModelTerms}}" variable-sets="{{processedVariableSets}}"
                                                     on-variablechange="onVariableSelectedChange" clear$="{{clearSelectedOptions}}">
                        </opencga-facet-view-selector>
                    </div>
                    <div class="col-md-5" style="padding: 0px 20px 0px 30px">
                        <opencga-facet-view-selector id="{{prefix}}-ofvs-nested" terms="{{dataModelTerms}}" variable-sets="{{processedVariableSets}}"
                                                     on-variablechange="onVariableSelectedChange" clear$="{{clearSelectedOptions}}"
                                                     disabled$="{{disableNestedSelector}}">
                        </opencga-facet-view-selector>
                    </div>

                    <div class="col-md-offset-1 col-md-1" style="padding-top: 25px">
                        <button type="button" class="btn btn-primary" on-click="addFacet" style="cursor: pointer">Add</button>
                    </div>

                </div>
            </div>

            <div class="col-md-12">
                <div style="padding: 25px">
                    <template is="dom-if" if="{{facetFilters.length}}">
                        <span style="font-weight: bold; padding: 0px 20px">Selected Facets:</span>
                        <template is="dom-repeat" items="{{facetFilters}}">
                            <button type="button" class$="btn btn-warning btn-sm {{item}}" data-facet$="{{item}}"
                                    on-click="removeFacet" on-mouseover="_onMouseOver" on-mouseout="_onMouseOut">
                                {{item}}
                            </button>
                        </template>
                    </template>
                </div>
            </div>

            <div class="col-md-8 col-md-offset-4">
                <div style="float: right; padding: 0px 10px 10px 10px">
                    <button type="button" class="btn btn-primary btn-lg" on-click="fetchData">Run</button>
                </div>

                <div style="float: right; padding: 0px 10px 10px 10px">
                    <button type="button" class="btn btn-primary btn-lg" on-click="clearAll">Clear</button>
                </div>
            </div>


            <!-- RESULTS - Facet Plots -->
            <h2>Results</h2>

            <template is="dom-if" if="{{_showInitMessage}}">
                <h3>No facet filters selected</h3>
            </template>

            <template is="dom-repeat" items="{{facetResults}}" id="facetResultsDiv">
                <div style="padding: 20px">
                    <h3>{{item.name}}</h3>
                    <h4>{{item.name}}</h4>
                    <opencga-facet-result-view facet-result="{{item}}" config="{{_config.result}}"></opencga-facet-result-view>
                </div>
            </template>

        </div>

        <div class="modal fade" id="{{prefix}}LoadingModal" data-backdrop="static" data-keyboard="false" tabindex="-1"
             role="dialog" aria-hidden="true" style="padding-top:15%; overflow-y:visible;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Loading ...</h3>
                    </div>
                    <div class="modal-body">
                        <div class="progress progress-striped active">
                            <div class="progress-bar progress-bar-success" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        class OpencgaFacetView extends Polymer.Element {

            constructor() {
                super();

                // Set status and init private properties
                this._init();
            }

            static get is() {
                return 'opencga-facet-view';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object
                    },
                    variableSets: {
                        type: Array,
                        value: []
                    },
                    entity: {
                        type: String
                    },
                    query: {
                        type: Object,
                        value: {}
                    },
                    config: {
                        type: Object
                    }
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            _init() {
                this.prefix = "facet" + Utils.randomString(6);

                this.disableNestedSelector = false;

                this._showInitMessage = true;

                this.facets = new Set();
                this.facetFilters = [];

                this._firstVariable = {};
                this._secondVariable = {};
            }

            static get observers() {
                return [
                    'renderFacetView(variableSets, entity, query, config)'
                ]
            }

            renderFacetView(variableSets, entity, query, config) {
                this._config = Object.assign(this.getDefaultConfig(), this.config);

                this.dataModelTerms = this.getDataModelTerms(entity);

                this.prepareVariablesForSelector(variableSets);
            }

            onVariableSelectedChange(e) {
                if (e.target.id === `${this.prefix}-ofvs-first`) {
                    if (e.detail.value === "average" || e.detail.value === "percentile") {
                        this.disableNestedSelector = true;
                    } else {
                        this.disableNestedSelector = false;
                    }

                    this._firstVariable = e.detail;
                } else {
                    this._secondVariable = e.detail;
                }
            }

            prepareVariablesForSelector(variableSets) {
                if (typeof this.processedVariableSets !== "undefined" && this.processedVariableSets.length === variableSets.length) {
                    // If the variable set ids match, it will mean the variableSets were already processed
                    let match = true;
                    for (let i = 0; i < variableSets.length; i++) {
                        if (this.processedVariableSets[i].id !== variableSets[i].id) {
                            match = false;
                        }
                    }
                    if (match) {
                        // They were already processed
                        return;
                    }
                }

                let processedVariableSets = [];
                for (let i = 0; i < variableSets.length; i++) {
                    processedVariableSets.push({
                        id: variableSets[i].id,
                        variables: this._parseVariableForDisplay(variableSets[i].variables, [],
                            this._config.variableSelector.marginLeft)
                    });
                }

                this.processedVariableSets = processedVariableSets;
            }

            _parseVariableForDisplay(variables, tags, margin) {
                let displayVariables = [];

                for (let i in variables) {
                    let variable = variables[i];

                    if (variable.type !== "OBJECT") {
                        // let myTags = Array.from(new Set([variable.name, variable.title].concat(tags))).join(" ");

                        // Add variable
                        displayVariables.push({
                            id: variable.id,
                            name: UtilsNew.defaultString(variable.name, variable.id),
                            category: variable.category,
                            type: variable.type,
                            defaultValue: variable.defaultValue,
                            multiValue: variable.multiValue,
                            allowedValues: variable.allowedValues,
                            disabled: false,
                            margin: margin,
                            cursor: "pointer",

                            tags: "annotation." + tags.concat(variable.id).join(".")
                        });
                    } else {
                        // Add variable
                        displayVariables.push({
                            id: variable.id,
                            name: UtilsNew.defaultString(variable.name, variable.id),
                            category: variable.category,
                            type: variable.type,
                            defaultValue: variable.defaultValue,
                            multiValue: variable.multiValue,
                            allowedValues: variable.allowedValues,
                            disabled: true,
                            margin: margin,
                            cursor: "default",

                            tags: "annotation." + tags.concat(variable.id).join(".")
                        });

                        displayVariables = displayVariables.concat(this._parseVariableForDisplay(variable.variableSet,
                            // [variable.name, variable.title].concat(tags), margin + this._config.variableSelector.marginStep));
                            tags.concat(variable.id), margin + this._config.variableSelector.marginStep));
                    }
                }
                return displayVariables;
            }


            getDataModelTerms(entity) {
                let catalogCommon = [
                    {
                        id: "creationYear",
                        name: "Creation year",
                        disabled: false,
                        margin: this._config.variableSelector.marginLeft,
                        cursor: "pointer",
                        tags: "creationYear"
                    }, {
                        id: "creationMonth",
                        name: "Creation month",
                        disabled: false,
                        margin: this._config.variableSelector.marginLeft,
                        cursor: "pointer",
                        tags: "creationMonth"
                    }, {
                        id: "creationDay",
                        name: "Creation day",
                        disabled: false,
                        margin: this._config.variableSelector.marginLeft,
                        cursor: "pointer",
                        tags: "creationDay"
                    }, {
                        id: "creationDayOfWeek",
                        name: "Creation day of week",
                        disabled: false,
                        margin: this._config.variableSelector.marginLeft,
                        cursor: "pointer",
                        tags: "creationDayOfWeek"
                    }, {
                        id: "status",
                        name: "Status",
                        disabled: false,
                        margin: this._config.variableSelector.marginLeft,
                        cursor: "pointer",
                        tags: "status"
                    }, {
                        id: "release",
                        name: "Release",
                        disabled: false,
                        margin: this._config.variableSelector.marginLeft,
                        cursor: "pointer",
                        tags: "release"
                    }
                ];

                switch (entity) {
                    case "COHORT":
                        return catalogCommon.concat([{
                            id: "type",
                            name: "Type",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "type"
                        }, {
                            id: "numSamples",
                            name: "Number of samples",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "numSamples"
                        }]);
                    case "FILE":
                        return catalogCommon.concat([{
                            id: "name",
                            name: "Name",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "name"
                        }, {
                            id: "type",
                            name: "Type",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "type"
                        }, {
                            id: "format",
                            name: "Format",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "format"
                        }, {
                            id: "bioformat",
                            name: "Bioformat",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "bioformat"
                        }, {
                            id: "external",
                            name: "External",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "external"
                        }, {
                            id: "size",
                            name: "Size",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "size"
                        }, {
                            id: "numSamples",
                            name: "Number of samples",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "numSamples"
                        }, {
                            id: "numRelatedFiles",
                            name: "Number of related files",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "numRelatedFiles"
                        }]);
                    case "SAMPLE":
                        return catalogCommon.concat([{
                            id: "somatic",
                            name: "Somatic",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "somatic"
                        }, {
                            id: "version",
                            name: "Version",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "version"
                        }]);
                    case "INDIVIDUAL":
                        return catalogCommon.concat([{
                            id: "hasFather",
                            name: "Has father",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "hasFather"
                        }, {
                            id: "hasMother",
                            name: "Has mother",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "hasMother"
                        }, {
                            id: "numMultiples",
                            name: "Number of multiples",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "numMultiples"
                        }, {
                            id: "multiplesType",
                            name: "Multiples type",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "multiplesType"
                        }, {
                            id: "sex",
                            name: "Sex",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "sex"
                        }, {
                            id: "karyotypicSex",
                            name: "Karyotypic sex",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "karyotypicSex"
                        }, {
                            id: "version",
                            name: "Version",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "version"
                        }, {
                            id: "lifeStatus",
                            name: "Life status",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "lifeStatus"
                        }, {
                            id: "affectationStatus",
                            name: "Affectation status",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "affectationStatus"
                        }, {
                            id: "numSamples",
                            name: "Number of samples",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "numSamples"
                        }, {
                            id: "parentalConsanguinity",
                            name: "Parental consanguinity",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "parentalConsanguinity"
                        }]);
                    case "FAMILY":
                        return catalogCommon.concat([{
                            id: "phenotypes",
                            name: "Phenotypes",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "phenotypes"
                        }, {
                            id: "numMembers",
                            name: "Number of members",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "numMembers"
                        }, {
                            id: "expectedSize",
                            name: "Expected size",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "expectedSize"
                        }, {
                            id: "version",
                            name: "Version",
                            disabled: false,
                            margin: this._config.variableSelector.marginLeft,
                            cursor: "pointer",
                            tags: "version"
                        }]);
                    default:
                        return [{}];
                }
            }

            getOpencgaClient(entity) {
                switch (entity) {
                    case "COHORT":
                        return this.opencgaSession.opencgaClient.cohorts();
                    case "FILE":
                        return this.opencgaSession.opencgaClient.files();
                    case "SAMPLE":
                        return this.opencgaSession.opencgaClient.samples();
                    case "INDIVIDUAL":
                        return this.opencgaSession.opencgaClient.individuals();
                    case "FAMILY":
                        return this.opencgaSession.opencgaClient.families();
                    default:
                        return [{}];
                }
            }

            /**
             * Apply the 'config' properties on the default
             */
            configObserver() {
                this._config = Object.assign(this.getDefaultConfig(), this.config);
            }

            onFacetFieldChange(e) {
                if (e.target.selectedOptions[0].dataset.range !== undefined) {
                    PolymerUtils.setValue(this.prefix + "FacetFieldIncludes", e.target.selectedOptions[0].dataset.range);
                } else {
                    PolymerUtils.setValue(this.prefix + "FacetFieldIncludes", "");
                }
            }

            onNestedFacetFieldChange(e) {
                if (e.target.selectedOptions[0].dataset.range !== undefined) {
                    PolymerUtils.setValue(this.prefix + "NestedFacetFieldIncludes", e.target.selectedOptions[0].dataset.range);
                } else {
                    PolymerUtils.setValue(this.prefix + "NestedFacetFieldIncludes", "");
                }
            }

            onClear() {
                this.query = {};
                this.search = {};
            }

            onFilterChange(e) {
                this.query = e.detail;
                this.search = e.detail;
            }

            _onMouseOver(e) {
                PolymerUtils.addStyleByClass(e.target.dataset.facet, "text-decoration", "line-through");
            }

            _onMouseOut(e) {
                PolymerUtils.addStyleByClass(e.target.dataset.facet, "text-decoration", "none");
            }

            _isAggregationFunction(value) {
                return value === "percentile" || value === "average";
            }

            addDefaultStats(e) {
                for (let i = 0; i < this._config.defaultStats.length; i++) {
                    this.facets.add(this._config.defaultStats[i]);
                }
                this.facetFilters =  Array.from(this.facets);

                this.fetchData();
            }

            addFacet(e) {
                let facetField = this._firstVariable.term;

                if (typeof facetField !== "undefined") {
                    let facetFieldIncludes = this._firstVariable.value;

                    let facet;
                    if (this._isAggregationFunction(facetFieldIncludes)) {
                        facet = `${facetFieldIncludes}(${facetField})`;
                    } else {
                        facet = facetField + facetFieldIncludes;
                    }

                    let nestedFacetField = this._secondVariable.term;
                    if (!this.disableNestedSelector && typeof nestedFacetField !== "undefined") {
                        let nestedFacetFieldIncludes = this._secondVariable.value;

                        let nestedFacet;
                        if (this._isAggregationFunction(nestedFacetFieldIncludes)) {
                            nestedFacet = `${nestedFacetFieldIncludes}(${nestedFacetField})`;
                        } else {
                            nestedFacet = nestedFacetField + nestedFacetFieldIncludes;
                        }

                        facet += ">>" + nestedFacet;
                    }

                    // Add facet
                    this.facets.add(facet);
                    this.facetFilters =  Array.from(this.facets);

                    // Clear form controls
                    this.clearSelectedOptions = true;
                    this.clearSelectedOptions = false;

                    this._firstVariable = {};
                    this._secondVariable = {};
                }
            }

            removeFacet(e) {
                this.facets.delete(e.target.dataset.facet);
                this.facetFilters =  Array.from(this.facets);
            }

            fetchData() {
                let client = this.getOpencgaClient(this.entity);
                if (UtilsNew.isUndefinedOrNull(client)) {
                    console.log("opencgaClient is null or undefined");
                    return;
                }

                if (this.facets.size === 0) {
                    alert("No facets selected.");
                    return;
                }

                this.clearPlots();
                // Shows loading modal
                $(PolymerUtils.getElementById(this.prefix + "LoadingModal")).modal("show");

                // Join 'query' from left menu and facet filters
                let queryParams = Object.assign(this.query,
                    {
                        // sid: this.opencgaClient._config.sessionId,
                        study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias,
                        timeout: 60000,
                        field: this.facetFilters.join(";")
                    });

                let _this = this;
                setTimeout(() => {
                        client.stats(queryParams, {})
                            .then(function (queryResponse) {
                                // let response = queryResponse.response[0].result[0].result;
                                _this.facetResults = queryResponse.response[0].result[0].results;

                                // Remove loading modal
                                $(PolymerUtils.getElementById(_this.prefix + "LoadingModal")).modal("hide");
                                _this._showInitMessage = false;
                            })
                            .catch(function (e) {
                                console.log(e);
                                // Remove loading modal
                                $(PolymerUtils.getElementById(_this.prefix + "LoadingModal")).modal("hide");
                                _this._showInitMessage = false;
                            });}
                    , 250);
            }

            clearPlots() {
                this.facetResults = [];
            }

            clearAll() {
                this.clearPlots();
                this.facets = new Set();
                this.facetFilters = [];
                this._showInitMessage = true;

                this.clearSelectedOptions = true;
                this.clearSelectedOptions = false;
            }

            isNotEmpty(myArray) {
                return typeof myArray !== "undefined" && myArray.length > 0;
            }

            getDefaultConfig() {
                return {
                    variableSelector: {
                        marginLeft: 25,
                        marginStep: 15
                    },
                    defaultStats: ["creationYear>>creationMonth", "status"]
                }
            }
        }

        customElements.define(OpencgaFacetView.is, OpencgaFacetView);
    </script>
</dom-module>
