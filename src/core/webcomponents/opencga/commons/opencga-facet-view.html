<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../commons/opencga-facet-result-view.html">
<link rel="import" href="../commons/opencga-facet-view-selector.html">

<dom-module id="opencga-facet-view">
    <template>
        <style include="jso-styles">
            option:disabled {
                font-size: 0.85em;
                font-weight: bold;
            }

            .active-filter-button:hover {
                text-decoration: line-through;
            }
        </style>

        <!-- Facet Fields -->
        <div class="row" style="padding: 0px 15px">
            <div class="col-md-12 panel panel-default">
                <h3>Select Aggregation Stats</h3>

                <div class="col-md-12">
                    <template is="dom-if" if="{{isNotEmpty(_config.defaultStats)}}">
                        <h4 style="padding-top: 5px">Default Aggregation Stats</h4>
                        <span style="padding-left: 10px">Add default aggregation stats</span>
                        <span style="padding-left: 10px">
                            <button type="button" class="btn btn-primary" on-click="addDefaultStats">Add</button>
                        </span>
                    </template>
                </div>

                <div class="col-md-12">
                    <h4 style="padding: 20px 0px 5px 0px">Select Custom Aggregation Fields</h4>
                    <div class="col-md-5" style="padding: 0px 30px 0px 10px">
                        <opencga-facet-view-selector id="{{prefix}}-ofvs-first" terms="{{dataModelTerms}}" variable-sets="[[variableSets]]"
                                                     on-variablechange="onVariableSelectedChange" clear$="{{clearSelectedOptions}}">
                        </opencga-facet-view-selector>
                    </div>
                    <div class="col-md-5" style="padding: 0px 10px 0px 30px">
                        <opencga-facet-view-selector id="{{prefix}}-ofvs-nested" terms="{{dataModelTerms}}" variable-sets="[[variableSets]]"
                                                     on-variablechange="onVariableSelectedChange" clear$="{{clearSelectedOptions}}"
                                                     disabled$="{{disableNestedSelector}}">
                        </opencga-facet-view-selector>
                    </div>

                    <div class="col-md-1" style="padding-top: 25px">
                        <button type="button" class="btn btn-primary" on-click="addFacet" style="cursor: pointer">Add</button>
                    </div>
                </div>

                <div class="col-md-12">
                    <div style="padding: 35px 10px 15px 25px">
                        <template is="dom-if" if="{{facetFilters.length}}">
                            <span style="font-weight: bold; padding-right: 10px">Selected Aggregation Fields:</span>
                            <template is="dom-repeat" items="{{facetFilters}}">
                                <button type="button" class$="btn btn-warning btn-sm {{item}}" data-facet$="{{item}}"
                                        on-click="removeFacet" on-mouseover="_onMouseOver" on-mouseout="_onMouseOut">
                                    {{item}}
                                </button>
                            </template>
                        </template>
                    </div>
                </div>

                <div class="col-md-10 col-md-offset-1">
                    <div style="float: right; padding: 10px">
                        <button type="button" class="btn btn-primary btn-lg" on-click="fetchData">Run</button>
                    </div>

                    <div style="float: right; padding: 10px">
                        <button type="button" class="btn btn-primary btn-lg" on-click="clearAll">Clear</button>
                    </div>
                </div>
            </div>

            <!-- RESULTS - Facet Plots -->
            <h3>Results</h3>
            <template is="dom-if" if="{{_showInitMessage}}">
                <h4 style="padding-left: 20px">No aggregation fields selected.</h4>
            </template>

            <template is="dom-repeat" items="{{facetResults}}" id="facetResultsDiv">
                <div style="padding: 20px">
                    <h4>{{item.name}}</h4>
                    <opencga-facet-result-view facet-result="{{item}}" config="{{_config.result}}"></opencga-facet-result-view>
                </div>
            </template>

        </div>

        <div class="modal fade" id="{{prefix}}LoadingModal" data-backdrop="static" data-keyboard="false" tabindex="-1"
             role="dialog" aria-hidden="true" style="padding-top:15%; overflow-y:visible;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Loading ...</h3>
                    </div>
                    <div class="modal-body">
                        <div class="progress progress-striped active">
                            <div class="progress-bar progress-bar-success" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        class OpencgaFacetView extends Polymer.Element {

            constructor() {
                super();

                // Set status and init private properties
                this._init();
            }

            static get is() {
                return 'opencga-facet-view';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object
                    },
                    variableSets: {
                        type: Array,
                        value: []
                    },
                    entity: {
                        type: String
                    },
                    query: {
                        type: Object,
                        value: {}
                    },
                    config: {
                        type: Object
                    }
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            _init() {
                this.prefix = "facet" + Utils.randomString(6);

                this.disableNestedSelector = false;

                this._showInitMessage = true;

                this.facets = new Set();
                this.facetFilters = [];

                this._firstVariable = {};
                this._secondVariable = {};
            }

            static get observers() {
                return [
                    'renderFacetView(variableSets, entity, query, config)'
                ]
            }

            renderFacetView(variableSets, entity, query, config) {
                this._config = Object.assign(this.getDefaultConfig(), this.config);

                this.dataModelTerms = this.getDataModelTerms(entity);

                // Take variableSets from the opencgaSession if it has not been passed
                if (UtilsNew.isUndefinedOrNull(variableSets) && UtilsNew.isNotUndefinedOrNull(this.opencgaSession)
                    && UtilsNew.isNotUndefinedOrNull(this.opencgaSession.study)
                    && UtilsNew.isNotUndefinedOrNull(this.opencgaSession.study.variableSets)) {
                    this.variableSets = this.opencgaSession.study.variableSets;
                }
            }

            onVariableSelectedChange(e) {
                if (e.target.id === `${this.prefix}-ofvs-first`) {
                    if (e.detail.value === "average" || e.detail.value === "percentile") {
                        this.disableNestedSelector = true;
                    } else {
                        this.disableNestedSelector = false;
                    }

                    this._firstVariable = e.detail;
                } else {
                    this._secondVariable = e.detail;
                }
            }

            getDataModelTerms(entity) {
                let catalogCommon = [
                    {
                        id: "creationYear",
                        name: "Creation year"
                    }, {
                        id: "creationMonth",
                        name: "Creation month"
                    }, {
                        id: "creationDay",
                        name: "Creation day"
                    }, {
                        id: "creationDayOfWeek",
                        name: "Creation day of week"
                    }, {
                        id: "status",
                        name: "Status"
                    }, {
                        id: "release",
                        name: "Release"
                    }
                ];

                switch (entity) {
                    case "COHORT":
                        return catalogCommon.concat([{
                            id: "type",
                            name: "Type"
                        }, {
                            id: "numSamples",
                            name: "Number of samples"
                        }]);
                    case "FILE":
                        return catalogCommon.concat([{
                            id: "name",
                            name: "Name"
                        }, {
                            id: "type",
                            name: "Type"
                        }, {
                            id: "format",
                            name: "Format"
                        }, {
                            id: "bioformat",
                            name: "Bioformat"
                        }, {
                            id: "external",
                            name: "External"
                        }, {
                            id: "size",
                            name: "Size"
                        }, {
                            id: "numSamples",
                            name: "Number of samples"
                        }, {
                            id: "numRelatedFiles",
                            name: "Number of related files"
                        }]);
                    case "SAMPLE":
                        return catalogCommon.concat([{
                            id: "somatic",
                            name: "Somatic"
                        }, {
                            id: "version",
                            name: "Version"
                        }]);
                    case "INDIVIDUAL":
                        return catalogCommon.concat([{
                            id: "hasFather",
                            name: "Has father"
                        }, {
                            id: "hasMother",
                            name: "Has mother"
                        }, {
                            id: "numMultiples",
                            name: "Number of multiples"
                        }, {
                            id: "multiplesType",
                            name: "Multiples type"
                        }, {
                            id: "sex",
                            name: "Sex"
                        }, {
                            id: "karyotypicSex",
                            name: "Karyotypic sex"
                        }, {
                            id: "version",
                            name: "Version"
                        }, {
                            id: "lifeStatus",
                            name: "Life status"
                        }, {
                            id: "affectationStatus",
                            name: "Affectation status"
                        }, {
                            id: "numSamples",
                            name: "Number of samples"
                        }, {
                            id: "parentalConsanguinity",
                            name: "Parental consanguinity"
                        }]);
                    case "FAMILY":
                        return catalogCommon.concat([{
                            id: "phenotypes",
                            name: "Phenotypes"
                        }, {
                            id: "numMembers",
                            name: "Number of members"
                        }, {
                            id: "expectedSize",
                            name: "Expected size"
                        }, {
                            id: "version",
                            name: "Version"
                        }]);
                    default:
                        return [{}];
                }
            }

            getOpencgaClient(entity) {
                switch (entity) {
                    case "COHORT":
                        return this.opencgaSession.opencgaClient.cohorts();
                    case "FILE":
                        return this.opencgaSession.opencgaClient.files();
                    case "SAMPLE":
                        return this.opencgaSession.opencgaClient.samples();
                    case "INDIVIDUAL":
                        return this.opencgaSession.opencgaClient.individuals();
                    case "FAMILY":
                        return this.opencgaSession.opencgaClient.families();
                    default:
                        return [{}];
                }
            }

            /**
             * Apply the 'config' properties on the default
             */
            configObserver() {
                this._config = Object.assign(this.getDefaultConfig(), this.config);
            }

            onFacetFieldChange(e) {
                if (e.target.selectedOptions[0].dataset.range !== undefined) {
                    PolymerUtils.setValue(this.prefix + "FacetFieldIncludes", e.target.selectedOptions[0].dataset.range);
                } else {
                    PolymerUtils.setValue(this.prefix + "FacetFieldIncludes", "");
                }
            }

            onNestedFacetFieldChange(e) {
                if (e.target.selectedOptions[0].dataset.range !== undefined) {
                    PolymerUtils.setValue(this.prefix + "NestedFacetFieldIncludes", e.target.selectedOptions[0].dataset.range);
                } else {
                    PolymerUtils.setValue(this.prefix + "NestedFacetFieldIncludes", "");
                }
            }

            onClear() {
                this.query = {};
                this.search = {};
            }

            onFilterChange(e) {
                this.query = e.detail;
                this.search = e.detail;
            }

            _onMouseOver(e) {
                PolymerUtils.addStyleByClass(e.target.dataset.facet, "text-decoration", "line-through");
            }

            _onMouseOut(e) {
                PolymerUtils.addStyleByClass(e.target.dataset.facet, "text-decoration", "none");
            }

            _isAggregationFunction(value) {
                return value === "percentile" || value === "average";
            }

            addDefaultStats(e) {
                for (let i = 0; i < this._config.defaultStats.length; i++) {
                    this.facets.add(this._config.defaultStats[i]);
                }
                this.facetFilters =  Array.from(this.facets);
            }

            addFacet(e) {
                let facetField = this._firstVariable.term;

                if (UtilsNew.isNotEmpty(facetField)) {
                    let facetFieldIncludes = this._firstVariable.value;

                    let facet;
                    if (this._isAggregationFunction(facetFieldIncludes)) {
                        facet = `${facetFieldIncludes}(${facetField})`;
                    } else {
                        facet = facetField + facetFieldIncludes;
                    }

                    let nestedFacetField = this._secondVariable.term;
                    if (!this.disableNestedSelector && UtilsNew.isNotEmpty(nestedFacetField)) {
                        let nestedFacetFieldIncludes = this._secondVariable.value;

                        let nestedFacet;
                        if (this._isAggregationFunction(nestedFacetFieldIncludes)) {
                            nestedFacet = `${nestedFacetFieldIncludes}(${nestedFacetField})`;
                        } else {
                            nestedFacet = nestedFacetField + nestedFacetFieldIncludes;
                        }

                        facet += ">>" + nestedFacet;
                    }

                    // Add facet
                    this.facets.add(facet);
                    this.facetFilters =  Array.from(this.facets);

                    // Clear form controls
                    this.clearSelectedOptions = true;
                    this.clearSelectedOptions = false;

                    this._firstVariable = {};
                    this._secondVariable = {};
                }
            }

            removeFacet(e) {
                this.facets.delete(e.target.dataset.facet);
                this.facetFilters =  Array.from(this.facets);
            }

            fetchData() {
                let client = this.getOpencgaClient(this.entity);
                if (UtilsNew.isUndefinedOrNull(client)) {
                    console.log("opencgaClient is null or undefined");
                    return;
                }

                if (this.facets.size === 0) {
                    alert("No facets selected.");
                    return;
                }

                this.clearPlots();
                // Shows loading modal
                $(PolymerUtils.getElementById(this.prefix + "LoadingModal")).modal("show");

                // Join 'query' from left menu and facet filters
                let queryParams = Object.assign(this.query,
                    {
                        // sid: this.opencgaClient._config.sessionId,
                        study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias,
                        timeout: 60000,
                        field: this.facetFilters.join(";")
                    });

                let _this = this;
                setTimeout(() => {
                        client.stats(queryParams, {})
                            .then(function (queryResponse) {
                                // let response = queryResponse.response[0].result[0].result;
                                _this.facetResults = queryResponse.response[0].result[0].results;

                                // Remove loading modal
                                $(PolymerUtils.getElementById(_this.prefix + "LoadingModal")).modal("hide");
                                _this._showInitMessage = false;
                            })
                            .catch(function (e) {
                                console.log(e);
                                // Remove loading modal
                                $(PolymerUtils.getElementById(_this.prefix + "LoadingModal")).modal("hide");
                                _this._showInitMessage = false;
                            });}
                    , 250);
            }

            clearPlots() {
                this.facetResults = [];
            }

            clearAll() {
                this.clearPlots();
                this.facets = new Set();
                this.facetFilters = [];
                this._showInitMessage = true;

                this.clearSelectedOptions = true;
                this.clearSelectedOptions = false;
            }

            isNotEmpty(myArray) {
                return typeof myArray !== "undefined" && myArray.length > 0;
            }

            getDefaultConfig() {
                return {
                    defaultStats: ["creationYear>>creationMonth"]
                }
            }
        }

        customElements.define(OpencgaFacetView.is, OpencgaFacetView);
    </script>
</dom-module>
