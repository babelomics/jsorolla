<dom-module id="opencga-variant-filter-sec-sample">
    <template>
        <div class="panel panel-default" style="margin-bottom: 10px">
            <div class="panel-heading" role="tab">
                <h4 class="panel-title">
                    <a class="collapsed" role="button" data-toggle="collapse" href="#[[collapsibleId]]" aria-expanded="true" aria-controls="[[collapsibleId]]">
                        Samples
                    </a>
                </h4>
            </div>

            <div id="[[collapsibleId]]" class="panel-collapse collapse in" role="tabpanel">
                <div class="panel-body">
                    <div class="form-group">
                        <div class="browser-subsection">
                            Mode of Inheritance
                            <div style="float: right" class="tooltip-div">
                                    <a>
                                        <i class="fa fa-info-circle" aria-hidden="true" id="[[modesOfInheritanceTooltipId]]"></i>
                                    </a>
                            </div>
                        </div>
                        <select id="[[modesOfInheritanceId]]" class="form-control input-sm" on-change="onModeOfInheritanceChanged">
                            <option value="none">Select...</option>
                            <template is="dom-repeat" items="[[modesOfInheritance]]" as="mode">
                                <option value="[[mode.id]]">[[mode.text]]</option>
                            </template>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="browser-subsection">
                            Samples & Genotypes
                            <div style="float: right" class="tooltip-div">
                                    <a>
                                        <i class="fa fa-info-circle" aria-hidden="true" id="[[sampleGenotypesTooltipId]]"></i>
                                    </a>
                            </div>
                        </div>


                        <table class="table table-hover" style="margin-bottom: 10px; font-size:smaller; table-layout:fixed;">
                            <thead>
                                <tr>
                                    <th style="width:40%">Sample</th>
                                    <template is="dom-repeat" items="[[potentialGenotypes]]" as="genotype">
                                        <th>[[genotype]]</td>
                                    </template>
                                </tr>
                            </thead>
                            <tbody>
                                <template is="dom-repeat" items="[[samples]]" as="sample">
                                    <tr>
                                        <td>[[sample.name]]</td>
                                        <template is="dom-repeat" items="[[potentialGenotypes]]" as="genotype">
                                            <td><input id="[[prefix]]-sgcb-[[sample.name]]-[[genotype]]" type="checkbox" on-click="onGenotypeCheckboxClick" data-sample="[[sample.name]]" data-genotype="[[genotype]]" checked$="[[isGenotypeIncluded(sample.name, genotype, query.*)]]"></td>
                                        </template>
                                    </tr>
                                </template>
                            </tbody>
                        </table>

                    </div>
                </div>
            </div>
        </template>
    </template>
    <script>

        class OpencgaVariantFilterSecSample extends Polymer.Element {

            constructor() {
                super();

                // set read-only properties
                this._setPrefix(`ovfss${Utils.randomString(8)}`);
                this._setCollapsibleId(`${this.prefix}-collapsible-id`);
                this._setModesOfInheritanceId(`${this.prefix}-moh-id`);
                this._setModesOfInheritanceTooltipId(`${this.prefix}-moh-tooltip-id`);
                this._setSampleGenotypesTooltipId(`${this.prefix}-sag-tooltip-id`);
            }

            static get is() {
                return "opencga-variant-filter-sec-sample";
            }

            static get properties() {
                const inheritanceModes = [
                    { id: "autoDominant", text: "Autosomal Dominant" },
                    { id: "autoRecessive", text: "Autosomal Recessive" },
                    { id: "xLinked", text: "X linked" },
                    { id: "yLinked", text: "Y linked" },
                ];

                return {
                    samples: {
                        type: Array,
                        value: () => [],
                        observer: "onSamplesChanged",
                    },
                    query: {
                        type: Object,
                        notify: true,
                    },
                    modesOfInheritance: {
                        type: Array,
                        readOnly: true,
                        value: inheritanceModes,
                    },
                    prefix: {
                        type: String,
                        readOnly: true,
                    },
                    collapsibleId: {
                        type: String,
                        readOnly: true,
                    },
                    modesOfInheritanceTooltipId: {
                        type: String,
                        readOnly: true,
                    },
                    modesOfInheritanceId: {
                        type: String,
                        readOnly: true,
                    },
                    sampleGenotypesTooltipId: {
                        type: String,
                        readOnly: true,
                    },
                    potentialGenotypes: {
                        type: Array,
                        readOnly: true,
                        value: ['0/0', '0/1', '1/1', './.'],
                    },
                    modeOfInheritance: {
                        type: String,
                        notify: true,
                    },
                };
            }

            static get observers() {
                return [
                    'onQueryChanged(query.*)',
                ];
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();

                // tooltips
                const tooltipDesc = {
                    content: { title: "", text: "" },
                    position: { target: "mouse", adjust: { x: 2, y: 2, mouse: false } },
                    style: { width: true, classes: "qtip-dark qtip-rounded qtip-shadow" },
                    show: { delay: 200 },
                    hide: { fixed: true, delay: 300 },
                };
                $(`#${this.modesOfInheritanceTooltipId}`).qtip(Object.assign({}, tooltipDesc, {
                    content: {
                        title: "Mode of Inheritance",
                        text: "Filter by disease mode of inheritance",
                    },
                }));
                $(`#${this.sampleGenotypesTooltipId}`).qtip(Object.assign({}, tooltipDesc, {
                    content: {
                        title: "Samples & Genotypes",
                        text: "Filter by sample genotypes",
                    },
                }));
            }

            onModeOfInheritanceChanged(e) {
                const value = (!!e && !!e.target && e.target.value) || "none";
                switch (value) {
                    case 'autoDominant':
                        this.removeRegion();
                        for (const sample of this.samples) {
                            this.setSampleGenotypes(sample.name,
                                !!sample.individual && 'AFFECTED' === sample.individual.affectationStatus
                                ? ['0/1', '1/1']
                                : ['0/0']
                            );
                        }
                        this.updateSampleGenotypeCheckboxes();
                        this.notifyQueryUpdate();
                        break;
                    case 'autoRecessive':
                        this.removeRegion();
                        for (const sample of this.samples) {
                            this.setSampleGenotypes(sample.name,
                                !!sample.individual && 'AFFECTED' === sample.individual.affectationStatus
                                ? ['1/1']
                                : ['0/0', '0/1']
                            );
                        }
                        this.updateSampleGenotypeCheckboxes();
                        this.notifyQueryUpdate();
                        break;
                    case 'xLinked':
                        this.setRegion("X");
                        for (const sample of this.samples) {
                            if (!!sample.individual && !!sample.individual.karyotypicSex && !!sample.individual.affectationStatus) {
                                const numXs = (sample.individual.karyotypicSex.match(/X/g) || []).length;
                                const diseased = ('AFFECTED' === sample.individual.affectationStatus);
                                const isFemale = (numXs > 1);
                                if (isFemale) {
                                    this.setSampleGenotypes(sample.name, diseased ? ['1/1'] : ['0/0', '0/1']);
                                } else {
                                    this.setSampleGenotypes(sample.name, diseased ? ['1/1'] : ['0/0']);
                                }
                            } else {
                                this.setSampleGenotypes(sample.name, []);
                            }
                        }
                        this.updateSampleGenotypeCheckboxes();
                        this.notifyQueryUpdate();
                        break;
                    case 'yLinked':
                        this.setRegion("Y");
                        for (const sample of this.samples) {
                            if (!!sample.individual && !!sample.individual.karyotypicSex && !!sample.individual.affectationStatus) {
                                const numYs = (sample.individual.karyotypicSex.match(/Y/g) || []).length;
                                const diseased = ('AFFECTED' === sample.individual.affectationStatus);
                                const isMale = (numYs > 1);
                                if (isMale) {
                                    this.setSampleGenotypes(sample.name, diseased ? ['1/1'] : ['0/0']);
                                } else {
                                    this.setSampleGenotypes(sample.name, []);
                                }
                            } else {
                                this.setSampleGenotypes(sample.name, []);
                            }



                            if (!!sample.individual && !!sample.individual.karyotypicSex) {
                                const numYs = (sample.individual.karyotypicSex.match(/Y/g) || []).length;
                                if (0 === numYs)    this.setSampleGenotypes(sample.name, []);
                                else this.setSampleGenotypes(sample.name, ['1/1']);
                            } else {
                                this.setSampleGenotypes(sample.name, []);
                            }
                        }
                        this.updateSampleGenotypeCheckboxes();
                        this.notifyQueryUpdate();
                        break;
                }
            }

            isGenotypeIncluded(sample, genotype) {
                const genos = this.parseGenotypeString();
                const xs = genos[sample] || [];
                return xs.includes(genotype);
            }

            addSampleGenotype(sample, genotype) {
                const genos = this.parseGenotypeString();
                const xs = genos[sample] || [];
                if (!xs.includes(genotype)) {
                    xs.push(genotype);
                    xs.sort();
                    genos[sample] = xs;
                    this.setQueryGenotypes(this.stringigyGenotypes(genos));
                }
            }

            removeSampleGenotype(sample, genotype) {
                const genos = this.parseGenotypeString();
                const xs = genos[sample] || [];
                if (xs.includes(genotype)) {
                    genos[sample] = xs.filter(x => x !== genotype);
                    this.setQueryGenotypes(this.stringigyGenotypes(genos));
                }
            }

            getSampleGenotypes(sampleName) {
                const genos = this.parseGenotypeString();
                return genos[sample] || [];
            }

            setSampleGenotypes(sample, genotypes) {
                const genos = this.parseGenotypeString();
                genos[sample] = genotypes;
                this.setQueryGenotypes(this.stringigyGenotypes(genos));
            }

            stringigyGenotypes(genotypes) {
                const sampleNames = Object.keys(genotypes).filter(sampleName => (genotypes[sampleName].length>0));
                const genoString = sampleNames.map(sampleName => `${sampleName}:${genotypes[sampleName].join(',')}`).join(';');
                return !!genoString ? genoString + ";" : genoString;
                // return genoString;
            }

            parseGenotypeString(genoString) {
                genoString = genoString || (!!this.query && this.query.genotype);
                if (!!genoString) {
                    const samplesString = genoString.split(';').filter(s => !!s);
                    let res = {};
                    for (const sampleString of samplesString) {
                        const parts = sampleString.split(':');
                        if (parts.length === 2 && this.samples.some(sample => sample.name === parts[0])) {
                            const sampleName = parts[0];
                            const sampleGenotypes = parts[1].split(',').filter(geno => this.potentialGenotypes.includes(geno));
                            sampleGenotypes.sort();
                            res[sampleName] = sampleGenotypes;
                        }
                    }
                    return res;
                } else {
                    return {};
                }
            }

            onGenotypeCheckboxClick(e) {
                if (!!e && !!e.target) {
                    const checked = e.target.checked;
                    const sampleName = e.target.dataSample;
                    const genotype = e.target.dataGenotype;

                    if (!!sampleName && !!genotype) {
                        if (!!checked) {
                            this.addSampleGenotype(sampleName, genotype);
                        } else {
                            this.removeSampleGenotype(sampleName, genotype);
                        }
                        document.getElementById(this.modesOfInheritanceId).value = "none";
                        this.notifyQueryUpdate();
                    }
                }
            }

            getSampleGenotypeCheckboxId(sample, genotype) {
                return `${this.prefix}-sgcb-${sample}-${genotype}`;
            }

            updateSampleGenotypeCheckboxes() {
                for (const sample of this.samples) {
                    for (const genotype of this.potentialGenotypes) {
                        const checkbox = document.getElementById(this.getSampleGenotypeCheckboxId(sample.name, genotype));
                        if (!!checkbox) {
                            if (checkbox.checked !== this.isGenotypeIncluded(sample.name, genotype)) {
                                checkbox.checked = this.isGenotypeIncluded(sample.name, genotype);
                            }
                        }
                    }
                }
            }

            setRegion(region) {
                if (!!region) {
                    this.query.region = region;
                } else if (!!this.query) {
                    delete this.query.region;
                }
            }

            removeRegion() {
                if (!!this.query.region) {
                    delete this.query.region;
                }
            }

            setQueryGenotypes(genoString) {
                if (!!this.query) {
                    if (!!genoString) {
                        this.query.genotype = genoString;
                    } else {
                        delete this.query.genotype;
                    }
                }
            }

            notifyQueryUpdate() {
                const params = {
                    detail: {
                        value: this.query,
                    },
                    bubbles: false,
                    composed: true
                };
                this.dispatchEvent(new CustomEvent("query-changed", params));
            }

            onSamplesChanged() {
                this.onQueryChanged();
            }

            onQueryChanged() {
                // if query is externally changed,
                // check if region changed, so we change mode of inheritance
                if (!!this.query && this.query.region) {
                    const region = this.query.region;
                    const moiElement = document.getElementById(this.modesOfInheritanceId);
                    const moiValue = !!moiElement && moiElement.value;
                    if (!!moiValue) {
                        if (('yLinked' === moiValue && region !== 'Y') || ('xLinked' === moiValue && region !== 'X')) {
                            moiElement.value = "none";
                        }
                    }
                }
                // make checkboxes congruent
                for (const sample of this.samples) {
                    for (const genotype of this.potentialGenotypes) {
                        const checkboxId = this.getSampleGenotypeCheckboxId(sample.name, genotype);
                        const checkbox = !!checkboxId && document.getElementById(checkboxId);
                        if (!!checkbox) {
                            const checkboxActualValue = checkbox.checked;
                            const checkboxExpectedValue = this.isGenotypeIncluded(sample.name, genotype);
                            if (checkboxExpectedValue !== checkboxActualValue) {
                                checkbox.checked = checkboxExpectedValue;
                            }
                        }
                    }
                }
            }
        }

        customElements.define(OpencgaVariantFilterSecSample.is, OpencgaVariantFilterSecSample);

    </script>
</dom-module>