<dom-module id="opencga-variant-filter-sec-sample">
    <template>
        <button on-click="onDebug">debug</button>
        <div class="panel panel-default" style="margin-bottom: 10px">
            <div class="panel-heading" role="tab">
                <h4 class="panel-title">
                    <a class="collapsed" role="button" data-toggle="collapse" href="#[[collapsibleId]]" aria-expanded="true" aria-controls="[[collapsibleId]]">
                        Samples
                    </a>
                </h4>
            </div>

            <div id="[[collapsibleId]]" class="panel-collapse collapse" role="tabpanel">
                <div class="panel-body">
                    <div class="form-group">
                        <div class="browser-subsection">
                            Mode of Inheritance
                            <div style="float: right" class="tooltip-div">
                                    <a>
                                        <i class="fa fa-info-circle" aria-hidden="true" id="[[modesOfInheritanceTooltipId]]"></i>
                                    </a>
                            </div>
                        </div>
                        <select class="form-control input-sm" on-change="onModeOfInheritanceChanged">
                            <option value="none">Select...</option>
                            <template is="dom-repeat" items="[[modesOfInheritance]]" as="mode">
                                <option value="[[mode.id]]">[[mode.text]]</option>
                            </template>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="browser-subsection">
                            Samples & Genotypes
                            <div style="float: right" class="tooltip-div">
                                    <a>
                                        <i class="fa fa-info-circle" aria-hidden="true" id="[[sampleGenotypesTooltipId]]"></i>
                                    </a>
                            </div>
                        </div>


                        <table class="table table-hover" style="margin-bottom: 10px; font-size:smaller">
                            <thead>
                                <tr>
                                    <th>Sample</th>
                                    <th>0/0</th>
                                    <th>0/1</th>
                                    <th>1/1</th>
                                    <th>./.</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template is="dom-repeat" items="[[samples]]" as="sample">
                                    <tr>
                                        <td>[[sample.name]]</td>
                                        <template is="dom-repeat" items="[[potentialGenotypes]]" as="genotype">
                                            <td><input id="[[prefix]]-sgcb-[[sample.name]]-[[genotype]]" type="checkbox" on-click="onGenotypeCheckboxClick" data-sample="[[sample.name]]" data-genotype="[[genotype]]"></td>
                                        </template>
                                    </tr>
                                </template>
                            </tbody>
                        </table>

                    </div>
                </div>
            </div>
        </template>
    </template>
    <script>
        class OpencgaVariantFilterSecSample extends Polymer.Element {

            constructor() {
                super();

                // set read-only properties
                this._setPrefix(`ovfss${Utils.randomString(8)}`);
                this._setCollapsibleId(`${this.prefix}-collapsible-id`);
                this._setModesOfInheritanceTooltipId(`${this.prefix}-moh-tooltip-id`);
                this._setSampleGenotypesTooltipId(`${this.prefix}-sag-tooltip-id`);
                this.sampleGenotypeMap = {};
            }

            static get is() {
                return "opencga-variant-filter-sec-sample";
            }

            static get properties() {
                const inheritanceModes = [
                    { id: "autoDominant", text: "Autosomal Dominant" },
                    { id: "autoRecessive", text: "Autosomal Recessive" },
                    { id: "xLinked", text: "X linked" },
                    { id: "yLinked", text: "Y linked" },
                ];

                return {
                    samples: {
                        type: Array,
                        value: () => [],
                        observer: "onSamplesChanged",
                    },
                    query: {
                        type: Object,
                        notify: true,
                    },
                    modesOfInheritance: {
                        type: Array,
                        readOnly: true,
                        value: inheritanceModes,
                    },
                    prefix: {
                        type: String,
                        readOnly: true,
                    },
                    collapsibleId: {
                        type: String,
                        readOnly: true,
                    },
                    modesOfInheritanceTooltipId: {
                        type: String,
                        readOnly: true,
                    },
                    sampleGenotypesTooltipId: {
                        type: String,
                        readOnly: true,
                    },
                    sampleGenotypeMap: {
                        type: Object,
                        // value: () => {},
                    },
                    potentialGenotypes: {
                        type: Array,
                        readOnly: true,
                        value: ['0/0', '0/1', '1/1', './.'],
                    }
                };
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();

                // tooltips
                const tooltipDesc = {
                    content: { title: "", text: "" },
                    position: { target: "mouse", adjust: { x: 2, y: 2, mouse: false } },
                    style: { width: true, classes: "qtip-dark qtip-rounded qtip-shadow" },
                    show: { delay: 200 },
                    hide: { fixed: true, delay: 300 },
                };
                $(`#${this.modesOfInheritanceTooltipId}`).qtip({
                    ...tooltipDesc,
                    content: {
                        title: "Mode of Inheritance",
                        text: "Filter by disease mode of inheritance",
                    },
                });
                $(`#${this.sampleGenotypesTooltipId}`).qtip({
                    ...tooltipDesc,
                    content: {
                        title: "Samples & Genotypes",
                        text: "Filter by sample genotypes",
                    },
                });
            }

            onSamplesChanged() {
                console.log("opencga-variant-filter-sec-sample.samples.changed");
                console.dir(this.samples);
            }

            onModeOfInheritanceChanged(e) {
                const value = (!!e && !!e.target && e.target.value) || "none";
                switch (value) {
                    case 'autoDominant':
                        for (const sample of this.samples) {
                            this.setSampleGenotypes(sample.name, ['1/1']);
                        }
                        this.computeFilterGenotypeString();
                        this.updateSampleGenotypeCheckboxes();
                        break;
                    case 'autoRecessive':
                        for (const sample of this.samples) {
                            this.setSampleGenotypes(sample.name, ['0/1', '1/1']);
                        }
                        this.computeFilterGenotypeString();
                        this.updateSampleGenotypeCheckboxes();
                        break;
                    case 'xLinked':
                        for (const sample of this.samples) {
                            this.setSampleGenotypes(sample.name, ['1/1']);
                        }
                        this.computeFilterGenotypeString();
                        this.updateSampleGenotypeCheckboxes();
                        break;
                    case 'yLinked':
                        for (const sample of this.samples) {
                            this.setSampleGenotypes(sample.name, ['1/1']);
                        }
                        this.computeFilterGenotypeString();
                        this.updateSampleGenotypeCheckboxes();
                        break;
                }
            }

            isGenotypeIncluded(sample, genotype) {
                const sampleGenotypes = this.sampleGenotypeMap[sample] || [];
                return sampleGenotypes.includes(genotype);
            }

            addSampleGenotype(sample, genotype) {
                const sampleGenotype = this.sampleGenotypeMap[sample];
                if (!sampleGenotype) {
                    this.sampleGenotypeMap[sample] = [ genotype ];
                } else if (!sampleGenotype.includes(genotype)) {
                    sampleGenotype.push(genotype);
                    sampleGenotype.sort();
                }
            }

            removeSampleGenotype(sample, genotype) {
                const sampleGenotype = this.sampleGenotypeMap[sample];
                const idx = !!sampleGenotype ? sampleGenotype.indexOf(genotype) : -1;
                if (-1 !== idx) {
                    sampleGenotype.splice(idx, 1);
                }
            }

            setSampleGenotypes(sample, genotypes) {
                this.sampleGenotypeMap[sample] = genotypes;
            }

            computeFilterGenotypeString() {
                const samples = Object.keys(this.sampleGenotypeMap);
                samples.sort();
                const filterString = samples.map(sample => {
                    const genotypes = this.sampleGenotypeMap[sample];
                    return !!genotypes && genotypes.length > 0 ? `${sample}:${genotypes.join(',')};` : '';
                }).join('');
                if (!!filterString) {
                    // this.query = {...this.query, genotype: filterString};
                    this.query.genotype = filterString;
                } else {
                    delete this.query.genotype;
                    // const tmpQuery = {...this.query};
                    // delete tmpQuery.genotype;
                    // this.query = tmpQuery;
                }
                console.log(`> genotype = ${filterString}`);
            }

            onGenotypeCheckboxClick(e) {
                if (!!e && !!e.target) {
                    const checked = e.target.checked;
                    const sampleName = e.target.dataSample;
                    const genotype = e.target.dataGenotype;

                    if (!!sampleName && !!genotype) {
                        if (!!checked) {
                            this.addSampleGenotype(sampleName, genotype);
                        } else {
                            this.removeSampleGenotype(sampleName, genotype);
                        }
                    }
                }
                console.dir(this.sampleGenotypeMap);
                this.computeFilterGenotypeString();
            }

            getSampleGenotypeCheckboxId(sample, genotype) {
                return `${this.prefix}-sgcb-${sample}-${genotype}`;
            }

            updateSampleGenotypeCheckboxes() {
                for (const sample of this.samples) {
                    for (const genotype of this.potentialGenotypes) {
                        const checkbox = document.getElementById(this.getSampleGenotypeCheckboxId(sample.name, genotype));
                        if (!!checkbox) {
                            if (checkbox.checked !== this.isGenotypeIncluded(sample.name, genotype)) {
                                checkbox.checked = this.isGenotypeIncluded(sample.name, genotype);
                            }
                        }
                    }
                }
            }

            onDebug() {
                console.log("opencga-variant-filter-sec-sample.onDebug");
                console.dir(this.query);
                console.log(">> " + JSON.stringify(this.query));
            }
        }

        customElements.define(OpencgaVariantFilterSecSample.is, OpencgaVariantFilterSecSample);

    </script>
</dom-module>