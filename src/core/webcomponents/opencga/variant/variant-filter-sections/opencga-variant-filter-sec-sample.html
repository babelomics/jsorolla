<dom-module id="opencga-variant-filter-sec-sample">
    <template>
        <div class="panel panel-default" style="margin-bottom: 10px">
            <div class="panel-heading" role="tab">
                <h4 class="panel-title">
                    <a class="collapsed" role="button" data-toggle="collapse" href="#[[collapsibleId]]" aria-expanded="true" aria-controls="[[collapsibleId]]">
                        Samples
                    </a>
                </h4>
            </div>

            <div id="[[collapsibleId]]" class="panel-collapse collapse in" role="tabpanel">
                <div class="panel-body">
                    <div class="form-group">
                        <div class="browser-subsection">
                            Mode of Inheritance
                            <jsorolla-tooltip
                                header="Mode of Inheritance"
                                content="Filter by disease mode of inheritance"
                            ></jsorolla-tooltip>
                        </div>
                        <select id="[[modesOfInheritanceId]]" class="form-control input-sm" on-change="onModeOfInheritanceChanged">
                            <option value="none">Select...</option>
                            <template is="dom-repeat" items="[[modesOfInheritance]]" as="mode">
                                <option value="[[mode.id]]">[[mode.text]]</option>
                            </template>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="browser-subsection">
                            Samples & Genotypes
                            <jsorolla-tooltip
                                header="Samples & Genotypes"
                                content="Filter by sample genotypes"
                            ></jsorolla-tooltip>
                        </div>
                        <table class="table table-hover" style="margin-bottom: 10px; font-size:smaller; table-layout:fixed;">
                            <thead>
                                <tr>
                                    <th style="width:40%">Sample</th>
                                    <template is="dom-repeat" items="[[potentialGenotypes]]" as="genotype">
                                        <th>[[genotype]]</td>
                                    </template>
                                </tr>
                            </thead>
                            <tbody>
                                <template is="dom-repeat" items="[[samples]]" as="sample">
                                    <tr>
                                        <td>[[sample.name]]</td>
                                        <template is="dom-repeat" items="[[potentialGenotypes]]" as="genotype">
                                            <td><input id="[[prefix]]-sgcb-[[sample.name]]-[[genotype]]" type="checkbox" on-click="onGenotypeCheckboxClick" data-sample="[[sample.name]]" data-genotype="[[genotype]]" checked$="[[isGenotypeIncluded(sample.name, genotype, query.*)]]"></td>
                                        </template>
                                    </tr>
                                </template>
                            </tbody>
                        </table>

                    </div>
                </div>
            </div>
        </template>
    </template>
    <script>

        class OpencgaVariantFilterSecSample extends Polymer.Element {

            constructor() {
                super();

                // set read-only properties
                this._setPrefix(`ovfss${Utils.randomString(8)}`);
                this._setCollapsibleId(`${this.prefix}-collapsible-id`);
                this._setModesOfInheritanceId(`${this.prefix}-moh-id`);
            }

            static get is() {
                return "opencga-variant-filter-sec-sample";
            }

            static get properties() {
                const inheritanceModes = [
                    { id: "autoDominant", text: "Autosomal Dominant" },
                    { id: "autoRecessive", text: "Autosomal Recessive" },
                    { id: "xLinked", text: "X linked" },
                    { id: "yLinked", text: "Y linked" },
                ];

                return {
                    samples: {
                        type: Array,
                        value: () => [],
                        observer: "onSamplesChanged",
                    },
                    query: {
                        type: Object,
                        notify: true,
                    },
                    prefix: {
                        type: String,
                        readOnly: true,
                    },
                    collapsibleId: {
                        type: String,
                        readOnly: true,
                    },
                    modesOfInheritanceId: {
                        type: String,
                        readOnly: true,
                    },
                    modeOfInheritance: {
                        type: String,
                        notify: true,
                        observer: 'onModeOfInheritanceChanged2',
                    },
                    modesOfInheritance: {
                        type: Array,
                        readOnly: true,
                        value: inheritanceModes,
                    },
                    potentialGenotypes: {
                        type: Array,
                        readOnly: true,
                        value: ['0/0', '0/1', '1/1', './.'],
                    },
                    individuals: {
                        type: Array,
                        computed: 'getIndividualsFromSamples(samples)',
                    },
                };
            }

            getIndividualsFromSamples() {
                return this.samples
                    .filter(sample => !!sample.individual)
                    .map(sample => sample.individual)
                    .reduce((accum, individual) => accum.some(ind => ind.id === individual.id) ? accum : accum.concat([individual]), []);
            }

            static get observers() {
                return [
                    'onQueryChanged(query.*)',
                ];
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            //==================================================================
            // for modes of inheritance
            //==================================================================

            isAffected(individual) {
                return !!individual.affectationStatus && individual.affectationStatus === 'AFFECTED';
            }

            getParents(individual) {
                if (!individual || !individual.id || individual.id === 0) {
                    return []
                } else {
                    const parentIds = ['mother', 'father'].map(relation => !!individual[relation] && individual[relation].id).filter(id => !!id);
                    return 0 === parentIds.length ? [] : this.individuals
                        .filter(parent => !!parent.id && parent.id>0 && parentIds.includes(parent.id));
                }
            }

            getChildren(individual) {
                if (!individual || !individual.id || individual.id === 0) {
                    return [];
                } else {
                    return this.individuals.filter(child =>
                        (!!child.mother && !!child.mother.id && child.mother.id === individual.id)
                        || (!!child.father && !!child.father.id && child.father.id === individual.id)
                    ).reduce((accum, child) => accum.some(ind => ind.id === child.id) ? accum : accum.concat([child]), []);
                }
            }

            hasHealthyChildren(individual) {
                return !!individual && this.getChildren(individual).some(child => !this.isAffected(child));
            }

            hasDiseasedChildren(individual) {
                return !!individual && this.getChildren(individual).some(child => this.isAffected(child));
            }

            hasHealthyParent(individual) {
                return !!individual && this.getParents(individual).some(parent => !this.isAffected(parent));
            }

            hasDiseasedParent(individual) {
                return !!individual && this.getParents(individual).some(parent => this.isAffected(parent));
            }

            onModeOfInheritanceChanged(e) {
                const value = (!!e && !!e.target && e.target.value) || "none";
                switch (value) {
                    case 'autoDominant':
                        this.removeRegion();
                        for (const sample of this.samples) {
                            const individual = sample.individual;
                            const genotypes = !!individual && this.isAffected(individual) ? (
                                this.hasHealthyChildren(individual) || this.hasHealthyParent(individual) ? ['0/1'] : ['0/1', '1/1']
                            ) : ['0/0'];
                            this.setSampleGenotypes(sample.name, genotypes);
                        }
                        this.updateSampleGenotypeCheckboxes();
                        this.notifyQueryUpdate();
                        break;
                    case 'autoRecessive':
                        this.removeRegion();
                        for (const sample of this.samples) {
                            const individual = sample.individual;
                            const genotypes = !!individual && this.isAffected(individual) ? ['1/1'] : (
                                this.hasDiseasedChildren(individual) || this.hasDiseasedParent(individual) ? ['0/1'] : ['0/0', '0/1']
                            );
                            this.setSampleGenotypes(sample.name, genotypes);
                        }
                        this.updateSampleGenotypeCheckboxes();
                        this.notifyQueryUpdate();
                        break;
                    case 'xLinked':
                        this.setRegion("X");
                        for (const sample of this.samples) {
                            const individual = sample.individual;
                            if (!!individual && !!individual.karyotypicSex && !!individual.affectationStatus) {
                                const numXs = (individual.karyotypicSex.match(/X/g) || []).length;
                                const diseased = this.isAffected(individual);
                                const isFemale = (numXs > 1);
                                if (isFemale) {
                                    const genotypes = diseased ? ['1/1'] : (
                                        this.hasDiseasedChildren(individual) || this.hasDiseasedParent(individual) ? ['0/1'] : ['0/0', '0/1']
                                    );
                                    this.setSampleGenotypes(sample.name, genotypes);
                                } else {
                                    this.setSampleGenotypes(sample.name, diseased ? ['1/1'] : ['0/0']);
                                }
                            } else {
                                this.setSampleGenotypes(sample.name, []);
                            }
                        }
                        this.updateSampleGenotypeCheckboxes();
                        this.notifyQueryUpdate();
                        break;
                    case 'yLinked':
                        this.setRegion("Y");
                        for (const sample of this.samples) {
                            const individual = sample.individual;
                            if (!!individual && !!individual.karyotypicSex && !!individual.affectationStatus) {
                                const numYs = (individual.karyotypicSex.match(/Y/g) || []).length;
                                const diseased = this.isAffected(individual);
                                const isMale = (numYs > 0);
                                if (isMale) {
                                    this.setSampleGenotypes(sample.name, diseased ? ['1/1'] : ['0/0']);
                                } else {
                                    this.setSampleGenotypes(sample.name, []);
                                }
                            } else {
                                this.setSampleGenotypes(sample.name, []);
                            }
                            // if (!!sample.individual && !!sample.individual.karyotypicSex) {
                            //     const numYs = (sample.individual.karyotypicSex.match(/Y/g) || []).length;
                            //     if (0 === numYs)    this.setSampleGenotypes(sample.name, []);
                            //     else this.setSampleGenotypes(sample.name, ['1/1']);
                            // } else {
                            //     this.setSampleGenotypes(sample.name, []);
                            // }
                        }
                        this.updateSampleGenotypeCheckboxes();
                        this.notifyQueryUpdate();
                        break;
                }

                this.dispatchEvent(new CustomEvent('mode-of-inheritance-changed', {detail: value, bubbles: true, composed: true}));
            }

            isGenotypeIncluded(sample, genotype) {
                const genos = this.parseGenotypeString();
                const xs = genos[sample] || [];
                return xs.includes(genotype);
            }

            addSampleGenotype(sample, genotype) {
                const genos = this.parseGenotypeString();
                const xs = genos[sample] || [];
                if (!xs.includes(genotype)) {
                    xs.push(genotype);
                    xs.sort();
                    genos[sample] = xs;
                    this.setQueryGenotypes(this.stringigyGenotypes(genos));
                }
            }

            removeSampleGenotype(sample, genotype) {
                const genos = this.parseGenotypeString();
                const xs = genos[sample] || [];
                if (xs.includes(genotype)) {
                    genos[sample] = xs.filter(x => x !== genotype);
                    this.setQueryGenotypes(this.stringigyGenotypes(genos));
                }
            }

            getSampleGenotypes(sampleName) {
                const genos = this.parseGenotypeString();
                return genos[sample] || [];
            }

            setSampleGenotypes(sample, genotypes) {
                const genos = this.parseGenotypeString();
                genos[sample] = genotypes;
                this.setQueryGenotypes(this.stringigyGenotypes(genos));
            }

            stringigyGenotypes(genotypes) {
                const sampleNames = Object.keys(genotypes).filter(sampleName => (genotypes[sampleName].length>0));
                const genoString = sampleNames.map(sampleName => `${sampleName}:${genotypes[sampleName].join(',')}`).join(';');
                return !!genoString ? genoString + ";" : genoString;
                // return genoString;
            }

            parseGenotypeString(genoString) {
                genoString = genoString || (!!this.query && this.query.genotype);
                if (!!genoString) {
                    const samplesString = genoString.split(';').filter(s => !!s);
                    let res = {};
                    for (const sampleString of samplesString) {
                        const parts = sampleString.split(':');
                        if (parts.length === 2 && this.samples.some(sample => sample.name === parts[0])) {
                            const sampleName = parts[0];
                            const sampleGenotypes = parts[1].split(',').filter(geno => this.potentialGenotypes.includes(geno));
                            sampleGenotypes.sort();
                            res[sampleName] = sampleGenotypes;
                        }
                    }
                    return res;
                } else {
                    return {};
                }
            }

            onGenotypeCheckboxClick(e) {
                if (!!e && !!e.target) {
                    const checked = e.target.checked;
                    const sampleName = e.target.dataSample;
                    const genotype = e.target.dataGenotype;

                    if (!!sampleName && !!genotype) {
                        if (!!checked) {
                            this.addSampleGenotype(sampleName, genotype);
                        } else {
                            this.removeSampleGenotype(sampleName, genotype);
                        }
                        document.getElementById(this.modesOfInheritanceId).value = "none";
                        this.dispatchEvent(new CustomEvent('mode-of-inheritance-changed', {detail: "", bubbles: true, composed: true}));
                        this.notifyQueryUpdate();
                    }
                }
            }

            getSampleGenotypeCheckboxId(sample, genotype) {
                return `${this.prefix}-sgcb-${sample}-${genotype}`;
            }

            updateSampleGenotypeCheckboxes() {
                for (const sample of this.samples) {
                    for (const genotype of this.potentialGenotypes) {
                        const checkbox = document.getElementById(this.getSampleGenotypeCheckboxId(sample.name, genotype));
                        if (!!checkbox) {
                            if (checkbox.checked !== this.isGenotypeIncluded(sample.name, genotype)) {
                                checkbox.checked = this.isGenotypeIncluded(sample.name, genotype);
                            }
                        }
                    }
                }
            }

            setRegion(region) {
                if (!!region) {
                    this.query.region = region;
                } else if (!!this.query) {
                    delete this.query.region;
                }
            }

            removeRegion() {
                if (!!this.query.region) {
                    delete this.query.region;
                }
            }

            setQueryGenotypes(genoString) {
                if (!!this.query) {
                    if (!!genoString) {
                        this.query.genotype = genoString;
                    } else {
                        delete this.query.genotype;
                    }
                }
            }

            notifyQueryUpdate() {
                const params = {
                    detail: {
                        value: this.query,
                    },
                    bubbles: false,
                    composed: true
                };
                this.dispatchEvent(new CustomEvent("query-changed", params));
            }

            onSamplesChanged() {
                // check if any sample has an haploid Y
                this.checkHaploidSamples();

                this.onQueryChanged();
            }

            onQueryChanged() {
                // if query is externally changed,
                // check if region changed, so we change mode of inheritance
                if (!!this.query && this.query.region) {
                    const region = this.query.region;
                    const moiElement = document.getElementById(this.modesOfInheritanceId);
                    const moiValue = !!moiElement && moiElement.value;
                    if (!!moiValue) {
                        if (('yLinked' === moiValue && region !== 'Y') || ('xLinked' === moiValue && region !== 'X')) {
                            moiElement.value = "none";
                        }
                    }
                }
                // make checkboxes congruent
                for (const sample of this.samples) {
                    for (const genotype of this.potentialGenotypes) {
                        const checkboxId = this.getSampleGenotypeCheckboxId(sample.name, genotype);
                        const checkbox = !!checkboxId && document.getElementById(checkboxId);
                        if (!!checkbox) {
                            const checkboxActualValue = checkbox.checked;
                            const checkboxExpectedValue = this.isGenotypeIncluded(sample.name, genotype);
                            if (checkboxExpectedValue !== checkboxActualValue) {
                                checkbox.checked = checkboxExpectedValue;
                            }
                        }
                    }
                }
            }

            onModeOfInheritanceChanged2() {
                const moiElement = document.getElementById(this.modesOfInheritanceId);
                if (!!moiElement) {
                    const moiValue = moiElement.value;
                    if (moiValue !== this.modeOfInheritance) {
                        moiElement.value = this.modeOfInheritance || "none";
                        this.onModeOfInheritanceChanged({target: { value: this.modeOfInheritance }});
                        // const value = (!!e && !!e.target && e.target.value) || "none";
                    }
                }
            }

            checkHaploidSamples() {
                // just make a query looking for haploid samples

            }
        }

        customElements.define(OpencgaVariantFilterSecSample.is, OpencgaVariantFilterSecSample);

    </script>
</dom-module>