<dom-module id="variant-filter-feature-selector">
    <template>
        <div class="form-group">
            <div class="browser-subsection">
                Feature IDs <span style="font-size: smaller">(gene, SNPs, ...)</span>
                <jsorolla-tooltip
                    header="Feature IDs (gene, SNPs, ...)"
                    content="Filter out variants falling outside the genomic features (gene, transcript, SNP, etc.) defined"
                ></jsorolla-tooltip>
            </div>
            <div style="padding-top: 5px" style="font-size: smaller">
                <div class="row">
                    <div class="col-sm-9">
                        <input
                            type="text"
                            class="form-control"
                            list$="[[optionListId]]"
                            placeholder="Search for Gene Symbols"
                            value="{{searchText::input}}"
                        >
                        <datalist id="[[optionListId]]"></datalist>
                    </div>
                    <div class="col-sm-3">
                        <button type="button" class="btn btn-primary form-control" on-click="onAddIdClick">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                </div>
                <textarea
                    name="geneSnp"
                    class="form-control clearable"
                    rows="3"
                    placeholder="BRCA2,ENSG00000139618,ENST00000544455,rs28897700"
                    style="margin-top: 5px"
                    value="{{idList::input}}"
                ></textarea>
            </div>
        </div>
    </template>
    <script>

        class VariantFilterFeatureSelector extends Polymer.Element {

            static get is() {
                return "variant-filter-feature-selector";
            }

            static get properties() {
                return {
                    cellbaseClient: {
                        type: Object,
                    },
                    query: {
                        type: Object,
                        notify: true,
                    },
                    searchText: {
                        type: String,
                        value: "",
                        observer: "onSearchTextChanged",
                    },
                    idList: {
                        type: String,
                        value: "",
                        observer: "onIdListChanged",
                    },
                    optionListId: {
                        type: String,
                        readOnly: true,
                    },
                }
            }

            static get observers() {
                return [
                    'onQueryChanged(query.*)',
                ];
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            constructor() {
                super();
                const prefix = `vfcl-${Utils.randomString(12)}`;
                this._setOptionListId(`${prefix}-options-id`);
            }

            onSearchTextChanged(newValue) {
                // only gene symbols are going to be searched and not Ensembl IDs
                const featureId = this.searchText;
                const optionList = document.getElementById(this.optionListId);
                if (!!optionList && !!featureId && featureId.length > 2 && !featureId.startsWith("ENS")) {
                    this.cellbaseClient
                        .get('feature', 'id', featureId.toUpperCase(), 'starts_with', {}, {})
                        .then(response => {
                            const options = (
                                !!response &&
                                !!response.response &&
                                response.response.length === 1 &&
                                response.response[0].result
                            ) || [];
                            optionList.innerHTML = options.map(option => `<option value="${option.name}">`).join('');
                        });
                }
            }

            onAddIdClick() {
                const featureId = this.searchText;
                if (!!featureId) {
                    const normFeatureId = featureId.toLowerCase().startsWith('rs') || featureId.split(':').length > 2
                        ? featureId.toLowerCase() : featureId.toUpperCase();
                    const featureIds = (!!this.idList && this.idList.split(',').filter(id => !!id)) || [];
                    if (!featureIds.includes(featureId)) {
                        featureIds.push(featureId);
                        featureIds.sort();
                        this.searchText = "";
                        this.idList = featureIds.join(',');
                        this.notifyQueryUpdate();
                    }
                }
            }

            onQueryChanged() {
                const xrefs = this.query['annot-xref'] || "";
                if (xrefs !== this.idList) {
                    this.idList = xrefs;
                }
            }

            onIdListChanged() {
                const xrefs = this.query['annot-xref'] || "";
                if (xrefs !== this.idList) {
                    this.query['annot-xref'] = this.idList;
                    this.notifyQueryUpdate();
                }
            }

            notifyQueryUpdate() {
                const params = {
                    detail: {
                        value: this.query,
                    },
                    bubbles: true,
                    composed: true
                };
                this.dispatchEvent(new CustomEvent("query-changed", params));
            }
        }

        customElements.define(VariantFilterFeatureSelector.is, VariantFilterFeatureSelector);

    </script>
</dom-module>