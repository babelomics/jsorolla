<dom-module id="variant-filter-biotype-selector">
    <template>
        <style include="jso-styles">
            .selectpicker {
                width: 100%!important;
            }
        </style>
        <div class="form-group">
            <div class="browser-subsection">
                [[title]]
                <div style="float: right" class="tooltip-div">
                        <a>
                            <i class="fa fa-info-circle" aria-hidden="true" id="[[tooltipId]]"></i>
                        </a>
                </div>
            </div>
            <div style="padding-top: 5px; font-size: x-small">
                <select
                    class="form-control"
                    style="font-size: small"
                    on-change="onSelectionChanged"
                    multiple>
                    <template is="dom-repeat" items="[[biotypes]]" as="biotype">
                        <option value="[[biotype]]" selected="[[isBiotypeSelected(biotype, query.*)]]">[[biotype]]</option>
                    </template>
                </select>
            </div>
        </div>
    </template>
    <script>

        class VariantFilterBiotypeSelector extends Polymer.Element {

            static get is() {
                return "variant-filter-biotype-selector";
            }

            static get properties() {
                return {
                    query: {
                        type: Object,
                        notify: true,
                    },
                    tooltipId: {
                        type: String,
                        readOnly: true,
                    },
                    title: {
                        type: String,
                        value: "Biotype",
                        readOnly: true,
                    },
                    tooltip: {
                        type: String,
                        value: "Filter out variants falling outside the genomic features (gene, transcript, SNP, etc.) defined. To select multiple options, hold CTRL down while clicking.",
                        readOnly: true,
                    },
                    biotypes: {
                        type: Array,
                        readOnly: true,
                        value: [
                            "3prime_overlapping_ncrna", "IG_C_gene", "IG_C_pseudogene", "IG_D_gene", "IG_J_gene", "IG_J_pseudogene",
                            "IG_V_gene", "IG_V_pseudogene", "Mt_rRNA", "Mt_tRNA", "TR_C_gene", "TR_D_gene", "TR_J_gene", "TR_J_pseudogene",
                            "TR_V_gene", "TR_V_pseudogene", "antisense", "lincRNA", "miRNA", "misc_RNA", "polymorphic_pseudogene",
                            "processed_transcript", "protein_coding", "pseudogene", "rRNA", "sense_intronic", "sense_overlapping", "snRNA",
                            "snoRNA"
                        ],
                    },
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            constructor() {
                super();
                const prefix = `vfbs-${Utils.randomString(12)}`;
                this._setTooltipId(`${prefix}-tooltip-id`);
            }

            connectedCallback() {
                super.connectedCallback();

                const tooltipDesc = {
                    content: { title: "", text: "" },
                    position: { target: "mouse", adjust: { x: 2, y: 2, mouse: false } },
                    style: { width: true, classes: "qtip-dark qtip-rounded qtip-shadow" },
                    show: { delay: 200 },
                    hide: { fixed: true, delay: 300 },
                };
                $(`#${this.tooltipId}`).qtip({
                    ...tooltipDesc,
                    content: {
                        title: this.title,
                        text: this.tooltip,
                    },
                });
            }

            onSelectionChanged(e) {
                const selectedValues = [];
                const selectedOptions = (!!e && !!e.target && !!e.target.selectedOptions && e.target.selectedOptions) || [];
                for (const selectedOption of selectedOptions) {
                    selectedValues.push(selectedOption.value);
                }
                if (selectedValues.length > 0) {
                    this.query.biotype = selectedValues.join(',');
                } else {
                    delete this.query.biotype;
                }
                this.notifyQueryUpdate();
            }

            isBiotypeSelected(biotype) {
                const queryBiotypes = (this.query.biotype || "").split(',');
                return queryBiotypes.includes(biotype);
            }

            notifyQueryUpdate() {
                const params = {
                    detail: {
                        value: this.query,
                    },
                    bubbles: true,
                    composed: true
                };
                this.dispatchEvent(new CustomEvent("query-changed", params));
            }
        }

        customElements.define(VariantFilterBiotypeSelector.is, VariantFilterBiotypeSelector);

    </script>
</dom-module>