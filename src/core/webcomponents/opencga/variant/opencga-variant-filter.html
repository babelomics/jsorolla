<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="variant-sample-selector.html">
<link rel="import" href="opencga-variant-filter-sample.html">
<link rel="import" href="../catalog/samples/opencga-sample-grid.html">
<link rel="import" href="../catalog/clinical/opencga-clinical-analysis-browser.html">
<link rel="import" href="../../commons/variant-modal-ontology.html">

<link rel="import" href="./variant-filter-sections/jsorolla-tooltip.html">
<link rel="import" href="./variant-filter-sections/opencga-variant-filter-sec-sample.html">
<link rel="import" href="./variant-filter-sections/opencga-variant-filter-sec-mmp-panel.html">
<link rel="import" href="./variant-filter-sections/opencga-variant-filter-sec-genomic.html">


<dom-module id="opencga-variant-filter">
    <template>
        <style include="jso-styles">
            span + span {
                margin-left: 10px;
            }

            .browser-ct-scroll {
                /*max-height: 450px;*/
                /*overflow-y: scroll;*/
                overflow-x: scroll;
            }

            .browser-ct-tree-view,
            .browser-ct-tree-view * {
                padding: 0;
                margin: 0;
                list-style: none;
            }

            .browser-ct-tree-view li ul {
                margin: 0 0 0 22px;
            }

            .browser-ct-tree-view * {
                vertical-align: middle;
            }

            .browser-ct-tree-view input[type="checkbox"] {
                cursor: pointer;
            }

            .browser-ct-item {
                white-space: nowrap;
                display: inline
            }

            div.block {
                overflow: hidden;
            }

            div.block label {
                width: 80px;
                display: block;
                float: left;
                text-align: left;
                font-weight: normal;
            }

            select + select {
                margin-left: 10px;
            }

            select + input {
                margin-left: 10px;
            }

            .browser-subsection {
                font-size: 1.35rem;
                font-weight: bold;
                padding: 5px 0px;
                color: #444444;
                border-bottom: 1px solid rgba(221, 221, 221, 0.8);
            }

            .subsection-content {
                margin: 5px 5px;
            }

            span.searchingSpan{
                background-color: #286090;
            }
            .searchingButton{
                color: #fff;
            }
            .notbold{
                font-weight: normal;
            }
            .bootstrap-select {
                width: 100%!important;
            }

            .selectpicker {
                width: 100%!important;
            }

        </style>

        <div>
            <div style="width: 60%;margin: 0 auto">
                <button type="button" class="btn btn-lg btn-primary" style="width: 100%" on-click="onSearch">
                    <i class="fa fa-search" aria-hidden="true" style="padding: 0px 5px"></i> {{config.menu.searchButtonText}}
                </button>
            </div>

            <div class="panel-group" id="{{prefix}}Accordion" role="tablist" aria-multiselectable="true" style="padding-top: 20px">
                <!-- <template is="dom-if" if="[[config." -->
                <opencga-variant-filter-sec-sample
                    samples="[[samples]]"
                    query="{{query}}"
                    on-query-changed="onQueryChanged"
                    modeOfInheritance="{{modeInheritance}}"
                ></opencga-variant-filter-sec-sample>
                <opencga-variant-filter-sec-mmp-panel
                    query="{{query}}"
                    on-query-changed="onQueryChanged"
                    mmp-extension-config="[[mmpExtensionConfig]]"
                ></opencga-variant-filter-sec-mmp-panel>
                <opencga-variant-filter-sec-genomic
                    cellbase-client="[[cellbaseClient]]"
                    query="{{query}}"
                    consequence-types="[[consequenceTypes]]"
                    on-query-changed="onQueryChanged"
                ></opencga-variant-filter-sec-genomic>
                <div id="FilterMenu"></div>
            </div>
        </div>
        <variant-modal-ontology prefix={{prefix}} on-propagateok="propagateOkHPO" ontology-filter="{{ontologyFilter}}" term="{{ontologyTerm}}"
                                selected-terms="{{selectedTermsOntology}}">
        </variant-modal-ontology>

        <div class="modal fade" id="{{prefix}}SampleFilterModal" data-backdrop="static" data-keyboard="false" tabindex="-1"
             role="dialog" aria-hidden="true" style="padding-top: 0%; overflow-y: visible">
            <div class="modal-dialog" style="width: 1024px">
                <div class="modal-content">
                    <div class="modal-header" style="padding: 5px 15px">
                        <h3>Sample Selection</h3>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        class OpencgaVariantFilter extends Polymer.Element {

            static get is() {
                return 'opencga-variant-filter';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object,
                        observer: 'studyObserver'
                    },
                    query: {
                        type: Object,
                        value: {},
                        notify: true,
                        observer: 'queryObserver'
                    },
                    search: {
                        type: Object,
                        notify: true,
                    },
                    family: {
                        type: Object,
                        // observer: "familyObserver"
                    },
                    opencgaClient: {
                        type: Object
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    populationFrequencies: {
                        type: Object
                    },
                    consequenceTypes: {
                        type: Object
                    },
                    config: {
                        type: Object
                    },
                    mmpExtensionConfig: {
                        type: Object
                    },
                    modeInheritance: {
                        type: String,
                        notify: true
                    },
                    samples: {
                        type: Array,
                        observer: "onSamplesChanged",
                    },
                    mmpExtensionConfig: {
                        type: Object,
                    },
                }
            }

            constructor() {
                super();

                this.prefix = "ovf" + Utils.randomString(12);

                this._initialised = false;
                this._reset = true;
                if (typeof PANELS !== "undefined") {
                    this.set('panelList', PANELS);
                }

                this.modalHpoActive = false;
                this.modalGoActive = false;

                this.onQueryChanged = this.onQueryChanged.bind(this);
            }

            onSamplesChanged() {
            }

            static get observers() {
                return [
                    "samplesObserver(samples.*)",
                ]
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();

                // Render filter menu and add event and tooltips
                this._renderFilterMenu();
                $('select.selectpicker').selectpicker('render');

                this._initialised = true;
                this.setQueryFilters();
            }

            // this changes comes from opencb/jsorolla, 20181026
            // _init() {
            //     this.prefix = "ovf" + Utils.randomString(6);

            //     this._initialised = false;
            //     this._reset = true;
            //     if (typeof PANELS !== "undefined") {
            //         this.set('panelList', PANELS);
            //     }

            //     this.modalHpoActive = false;
            //     this.modalGoActive = false;

            //     this._genotypes = ["0/0", "0/1", "1/1"];
            //     this.samples = [];
            // }

            studyObserver() {
                if (UtilsNew.isNotUndefinedOrNull(this.opencgaSession.study)) {
                    // Update the study list of studies and the selected one
                    if (UtilsNew.isNotUndefinedOrNull(this.opencgaSession.project.studies)) {
                        let _differentStudies = [];
                        for (let i = 0; i < this.opencgaSession.project.studies.length; i++) {
                            if (this.opencgaSession.study.alias !== this.opencgaSession.project.studies[i].alias) {
                                _differentStudies.push(this.opencgaSession.project.studies[i]);
                            }
                        }
                        this.differentStudies = _differentStudies;

                        // Insert study checkboxes HTML, this only happens if the Study subsection has been added
                        PolymerUtils.innerHTML(this.prefix + "study", this._getStudyHtml(this.prefix));
                        for (let study of this.differentStudies) {
                            let element = PolymerUtils.getElementById(this.prefix + study.alias + "Checkbox");
                            if (UtilsNew.isNotUndefinedOrNull(element)) {
                                element.addEventListener('change', this.updateQueryFilters.bind(this));
                            }
                        }
                    }

                    // Update cohorts from config, this updates the Cohort filter MAF
                    if (typeof this.config !== "undefined" && typeof this.config.menu.sections !== "undefined") {
                        this._cohorts = [];
                        for (let section of this.config.menu.sections) {
                            for (let subsection of section.subsections) {
                                if (subsection.id === "cohort") {
                                    let projectFields = this.opencgaSession.project.alias.split("@");
                                    let projectId = (projectFields.length > 0) ? projectFields[1] : projectFields[0];
                                    if (UtilsNew.isNotUndefinedOrNull(subsection.cohorts[projectId])) {
                                        for (let study of Object.keys(subsection.cohorts[projectId])) {
                                            Array.prototype.push.apply(this._cohorts, subsection.cohorts[projectId][study]);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            queryObserver(newValue, oldValue) {
                if (this._reset) {
                    this.setQueryFilters();
                } else {
                    this._reset = true;
                }

                // Parameter 'format' has been removed
                if (!!oldValue && !!oldValue.format && !!newValue && !newValue.format) {
                    for (const sample of this.samples) {
                        delete sample.dp;
                    }
                    // TODO: I changed the following for the previous;
                    // check this produces no undesired side effects,
                    // due to non-propagation of changes
                    // this.samples = this.samples.map(sample => ({ ...sample, dp: undefined }));
                }
            }

            samplesObserver(e) {
                this._calculateFilesSamples();
                this.updateQueryFilters();
            }

            _calculateFilesSamples() {
                this.samplesFiles = [];
                let _this = this;
                let params = {
                    study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias
                };
                this.samples.forEach((sample) => {
                    params.samples = [sample.source];
                    if (!UtilsNew.containsArray(_this.samplesFiles, sample.source)) {
                        _this.samplesFiles.push(sample.source);
                    }
                });
            }

            propagateOkHPO(e) {
                if (this.openHPO) {
                    PolymerUtils.setValue(this.prefix + "HumanPhenotypeOntologyTextarea", e.detail.result.join(","));
                    this.selectedTermsHPO = e.detail.originalResult;
                } else {
                    PolymerUtils.setValue(this.prefix + "GeneOntologyTextarea", e.detail.result.join(","));
                    this.selectedTermsGO = e.detail.originalResult;
                }
                $("#" + this.prefix + "ontologyModal").modal('hide');

                this.updateQueryFilters();
            }

            openModalOntology() {
                $("#" + this.prefix + "ontologyModal").modal('show');
            }

            openModalHpo() {
                this.openHPO = true;
                this.ontologyTerm = "HPO";
                this.selectedTermsOntology = this.selectedTermsHPO;
                this.ontologyFilter = "hp";
                this.openModalOntology();
            }

            openModalGo() {
                this.openHPO = false;
                this.ontologyTerm = "GO";
                this.selectedTermsOntology = this.selectedTermsGO;
                this.ontologyFilter = "go";
                this.openModalOntology();
            }

            onSearch() {
                this.search = this.query;
            }

            handleCollapseAction(e) {
                let id = e.target.dataset.id;
                let elem = $('#' + id)[0];
                elem.hidden = !elem.hidden;
                if (elem.hidden) {
                    e.target.className = "fa fa-plus";
                } else {
                    e.target.className = "fa fa-minus";
                }
            }

            keyUpAllPopFreq(e) {
                let studyId = e.target.getAttribute("data-study");
                let study = this.populationFrequencies.studies.find((study) => {
                    return study.id === studyId;
                });

                study.populations.forEach((popFreq) => {
                    PolymerUtils.setValue(this.prefix + studyId +  popFreq.id, e.target.value);
                });
            }

            checkScore(e) {
                const inputElement = $(`#${this.prefix}${e.target.name}Input`);
                const operatorElement = $(`#${this.prefix}${e.target.name}Operator`);
                if (e.target.value === "score") {
                    inputElement.prop("disabled", false);
                    operatorElement.prop("disabled", false);
                } else {
                    inputElement.val("");
                    operatorElement.val("<");
                    inputElement.prop("disabled", true);
                    operatorElement.prop("disabled", true);
                }
                this.updateQueryFilters();
            }

            setQueryFilters() {
                // Empty everything before rendering
                this._clearHtmlDom();

                // Check 'query' is not null or empty there is nothing else to do
                if (0 === Object.keys(this.query || []).length) return;

                // inheritance Mode
                // if (UtilsNew.isNotUndefinedOrNull(this.modeInheritance)) {
                //     PolymerUtils.setValue(this.prefix + "SegregationOperator", this.modeInheritance)
                // }

                // Cohorts

                if (!!this.query.maf) {
                    const cohortArray = this.query.maf.split(new RegExp("[,;]"));
                    for (const cohortItem of cohortArray) {
                        const [study, cohortFreq] = cohortItem.split(':');
                        const [cohort, freq] = cohortFreq.split(/[<=>]+/);
                        const operator = cohortFreq.split(/[-A-Za-z0-9._:]+/)[1];
                        PolymerUtils.setValue(this.prefix + study + cohort + "Cohort", freq);
                        PolymerUtils.setValue(this.prefix + study + cohort + "CohortOperator", operator);
                    }
                }

                // Studies
                if (!!this.query.studies) {
                    if (!!this.$.includeOtherStudy && !!this.$.differentStudies) {
                        const studies = this.query.studies.split(new RegExp("[,;]"));
                        if (studies.length > 1) {
                            const checkBoxes = PolymerUtils.querySelectorAll("input", this.prefix + "DifferentStudies");
                            for (const studyItem of studies) {
                                const study = studyItem.split(':')[1];
                                for (const checkbox of checkBoxes) {
                                    if (checkBoxes[j].value === study) {
                                        checkBoxes[j].checked = true;
                                    }
                                }
                            }
                        }
                    }
                }

                // Population Freqs
                let pfArray = [];
                if (typeof this.query["alternate_frequency"] !== "undefined") {
                    pfArray = this.query["alternate_frequency"].split(new RegExp("[,;]"));
                }
                if (typeof this.populationFrequencies !== "undefined" && typeof this.populationFrequencies.studies !== "undefined" && this.populationFrequencies.studies.length > 0) {
                    for (let i = 0; i < this.populationFrequencies.studies.length; i++) {
                        let study = this.populationFrequencies.studies[i].id;
                        for (let j = 0; j < this.populationFrequencies.studies[i].populations.length; j++) {
                            let population = this.populationFrequencies.studies[i].populations[j].id;
                            if (pfArray.length > 0) {
                                for (let k = 0; k < pfArray.length; k++) {
                                    let pf = pfArray[k];
                                    if (pf.startsWith(study + ":" + population)) {
                                        PolymerUtils.setValue(this.prefix + study + population, pf.split(/[<=>]+/)[1]);
                                        PolymerUtils.setValue(this.prefix + study + population + "Operator", pf.split(/[-A-Za-z0-9._:]+/)[1]);
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }

                // Protein Substitution scores
                if (typeof this.query["protein_substitution"] !== "undefined") {
                    let pss = this.query["protein_substitution"].split(new RegExp("[,;]"));
                    if (pss.length > 0) {
                        for (let i = 0; i < pss.length; i++) {
                            if (pss[i].startsWith("sift")) {
                                let value = pss[i].split("sift")[1];
                                if (value.startsWith("<") || value.startsWith(">")) {
                                    PolymerUtils.setValue(this.prefix + "SiftInput", value.split(/[<=>]+/)[1]);
                                    PolymerUtils.setValue(this.prefix + "SiftOperator", value.split(/[-0-9.]+/)[0]);
                                } else {
                                    PolymerUtils.setValue(this.prefix + "SiftValues", value.split('==')[1]);
                                }
                                PolymerUtils.getElementById(this.prefix + "SiftInput").disabled = !(value.startsWith("<") || value.startsWith(">"));
                                PolymerUtils.getElementById(this.prefix + "SiftOperator").disabled = !(value.startsWith("<") || value.startsWith(">"));
                            } else if (pss[i].startsWith("polyphen")) {
                                let value = pss[i].split("polyphen")[1];
                                if (value.startsWith("<") || value.startsWith(">")) {
                                    PolymerUtils.setValue(this.prefix + "PolyphenInput", value.split(/[<=>]+/)[1]);
                                    PolymerUtils.setValue(this.prefix + "PolyphenOperator", value.split(/[-0-9.]+/)[0]);
                                } else {
                                    PolymerUtils.setValue(this.prefix + "PolyphenValues", value.split('==')[1]);
                                }
                                PolymerUtils.getElementById(this.prefix + "PolyphenInput").disabled = !(value.startsWith("<") || value.startsWith(">"));
                                PolymerUtils.getElementById(this.prefix + "PolyphenOperator").disabled = !(value.startsWith("<") || value.startsWith(">"));
                            }
                        }
                    }
                }

                // Cadd scores
                if (typeof this.query["annot-functional-score"] !== "undefined") {
                    let fields = this.query["annot-functional-score"].split(new RegExp("[,;]"));
                    for (let i = 0; i < fields.length; i++) {
                        let source = fields[i].split(/[<=>]+/)[0];
                        switch (source) {
                            case "cadd_raw":
                                PolymerUtils.setValue(this.prefix + "CaddRawInput", fields[i].split(/[<=>]+/)[1]);
                                PolymerUtils.setValue(this.prefix + "CaddRawOperator", fields[i].split(/[-A-Za-z0-9_]+/)[1]);
                                break;
                            case "cadd_scaled":
                                PolymerUtils.setValue(this.prefix + "CaddScaledInput", fields[i].split(/[<=>]+/)[1]);
                                PolymerUtils.setValue(this.prefix + "CaddScaledOperator", fields[i].split(/[-A-Za-z0-9_]+/)[1]);
                                break;
                        }
                    }
                }

                // Conservation
                if (!!this.query.conservation) {
                    const fields = this.query.conservation.split(new RegExp("[,;]"));
                    for (const field of fields) {
                        const source = field.split(/[<=>]+/)[0];
                        switch (source) {
                            case "phylop":
                                PolymerUtils.setValue(this.prefix + "PhylopInput", field.split(/[<=>]+/)[1]);
                                PolymerUtils.setValue(this.prefix + "PhylopOperator", field.split(/[-A-Za-z0-9]+/)[1]);
                                break;
                            case "phastCons":
                                PolymerUtils.setValue(this.prefix + "PhastconsInput", field.split(/[<=>]+/)[1]);
                                PolymerUtils.setValue(this.prefix + "PhastconsOperator", field.split(/[-A-Za-z0-9]+/)[1]);
                                break;
                            case "gerp":
                                PolymerUtils.setValue(this.prefix + "GerpInput", field.split(/[<=>]+/)[1]);
                                PolymerUtils.setValue(this.prefix + "GerpOperator", field.split(/[-A-Za-z0-9]+/)[1]);
                                break;
                        }
                    }
                }

                // Gene Ontology and Human Phenotype Ontology
                if (typeof this.query["annot-go"] !== "undefined") {
                    PolymerUtils.setValue(this.prefix + "GeneOntologyTextarea", this.query["annot-go"]);
                }
                if (typeof this.query["annot-hpo"] !== "undefined") {
                    PolymerUtils.setValue(this.prefix + "HumanPhenotypeOntologyTextarea", this.query["annot-hpo"]);
                }
                if (typeof this.query["clinvar"] !== "undefined") {
                    PolymerUtils.setValue(this.prefix + "ClinVarTextarea", this.query["clinvar"]);
                }

                // VCFFilter
                if (typeof this.query["filter"] !== "undefined") {
                    $("#" + this.prefix + "vcfFilterSelect").selectpicker('val', this.query["filter"].split(","));
                }

                if (typeof this.query["traits"] !== "undefined") {
                    PolymerUtils.setValue(this.prefix + "TraitsTextarea", this.query.traits);
                }
            }

            onGeneDiseasePanelChange() {
                let panelName = PolymerUtils.getElementById(this.prefix + "PanelApps").value;
                for (let i = 0; i < this.panelList.length; i++) {
                    if (this.panelList[i].name === panelName) {
                        let panel = this.panelList[i];
                        PolymerUtils.getElementById(this.prefix + "PanelAppsTextarea").value = panel.genes;
                        PolymerUtils.setValue(this.prefix + "AutocompleteExternalPanelSearchInput", "");
                        PolymerUtils.setValue(this.prefix + "ExternalPanelAppsTextarea", "");
                        break;
                    }
                }
                this.dispatchEvent(new CustomEvent("panelselected", {detail: {panel: panelName}, bubbles: true, composed: true}));

                this.updateQueryFilters();
            }

            onExternalPanelChange() {
                const externalPanelSearchInputValue = PolymerUtils.getValue(this.prefix + "AutocompleteExternalPanelSearchInput");
                const externalPanelSearchInput = PolymerUtils.getElementById(this.prefix + "AutocompleteExternalPanelSearchDataList").options;
                const optionSelected = Array.from(externalPanelSearchInput).find(option => option.value === externalPanelSearchInputValue);
                if (!!optionSelected) {
                    const panel = JSON.parse(optionSelected.dataset.panel);
                    const genes = panel.genes.map(gene => gene._id.cellbaseId).join(",");
                    PolymerUtils.getElementById(this.prefix + "ExternalPanelAppsTextarea").value = genes;
                    PolymerUtils.setValue(this.prefix + "PanelAppsTextarea", "");
                    PolymerUtils.setPropertyById(this.prefix + "PanelApps", "selectedIndex", 0);
                    this.dispatchEvent(new CustomEvent("panelselected", {detail: {panel: optionSelected.value}, bubbles: true, composed: true}));
                }

                this.updateQueryFilters();
            }

            updateQueryFilters() {

                if (!this._initialised) {
                    return;
                }

                const _filters = {};
                const fieldsToCopy = ["genotype", "gene", "region", "type", "biotype", "annot-xref", "annot-ct", "format", "info"];
                for (const field of fieldsToCopy) {
                    if (!!this.query[field]) {
                        _filters[field] = this.query[field];
                    }
                }

                // Add Cohort stats MAF filter: [{study.alias}]:{cohort}[<|>|<=|>=]{number}
                let cohortFreq = [];
                if (typeof this._cohorts !== "undefined" && this._cohorts.length > 0) {
                    for (let i = 0; i < this._cohorts.length; i++) {
                        let cohort = this._cohorts[i].id;
                        let cohortInput = PolymerUtils.getElementById(this.prefix + this.opencgaSession.study.alias + cohort + "Cohort");
                        let operator = PolymerUtils.getElementById(this.prefix + this.opencgaSession.study.alias + cohort + "CohortOperator");
                        if ((cohortInput !== null && cohortInput.value !== "") || (operator !== null && operator.value !== "<")) {
                            operator = operator.value;
                            const study = this.opencgaSession.study.alias;
                            // to be removed!!
                            if (study === "BRIDGE") {
                                study = "bridge";
                            }
                            const pf = study + ":" + cohort + operator + cohortInput.value;
                            cohortFreq.push(pf);
                        }
                    }
                }
                if (cohortFreq.length > 0) {
                    _filters["maf"] = cohortFreq.join(';');
                }

                // Studies - This section is not renderer when only study exists
                let studies = [this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias];
                let selectedStudies = PolymerUtils.querySelectorAll("input:checked", this.prefix + "DifferentStudies");
                if (UtilsNew.isNotUndefinedOrNull(selectedStudies)) {
                    for (let i = 0; i < selectedStudies.length; i++) {
                        if (studies.indexOf(this.opencgaSession.project.alias + ':' + selectedStudies[i].value) === -1) {
                            studies.push(this.opencgaSession.project.alias + ':' + selectedStudies[i].value);
                        }
                    }
                    switch (PolymerUtils.getElementById(this.prefix + "includeOtherStudy").value) {
                        case "in":
                            _filters.studies = studies.join(';');
                            break;
                        case "atleast":
                            _filters.studies = studies.join(',');
                            break;
                        case "not in":
                            let notInStudies = [];
                            let currentStudy = this.opencgaSession.project.alias + ':' + this.opencgaSession.study.alias;
                            for (let j = 0; j < studies.length; j++) {
                                if (currentStudy === studies[j]) {
                                    // Always add the study that we are browsing currently
                                    notInStudies.push(studies[j]);
                                } else {
                                    notInStudies.push("!" + studies[j]);
                                }
                            }
                            _filters.studies = notInStudies.join(";");
                            break;
                    }
                }

                // Population Frequencies
                // Population minor allele frequency: {study}:{population}[<|>|<=|>=]{number}
                if (!!this.populationFrequencies && !!this.populationFrequencies.studies) {
                    const frequencies = this.populationFrequencies.studies.map(study => (
                        study.populations.map(population => {
                            const studyTextbox = PolymerUtils.getElementById(`${this.prefix}${study.id}${population.id}`);
                            const studyTextboxValue = !!studyTextbox && studyTextbox.value;
                            const operator = PolymerUtils.getElementById(`${this.prefix}${study.id}${population.id}Operator`);
                            const operatorValue = !!operator && operator.value;
                            return (!!studyTextboxValue && !!operatorValue && `${study.id}:${population.id}${operatorValue}${studyTextboxValue}`) || "";
                        }).filter(freq => !!freq).join(';')
                    )).filter(freq => !!freq).join(';');
                    if (!!frequencies) {
                        _filters["alternate_frequency"] = frequencies;
                    }
                }

                // Protein Substitution Scores -  Sift and Polyphen
                let pss = [];
                let numFilters = 0;
                let subsScores = ["Sift", "Polyphen"];
                subsScores.forEach((subsScore) => {
                    let dropdownValues = PolymerUtils.getElementById(this.prefix + subsScore + "Values");
                    let textboxInput = PolymerUtils.getElementById(this.prefix + subsScore + "Input");
                    let operator = PolymerUtils.getElementById(this.prefix + subsScore + "Operator");
                    if (dropdownValues !== null && dropdownValues.value === "score" && textboxInput !== null && textboxInput.value !== "") {
                        pss.push(subsScore.toLowerCase() + operator.value + textboxInput.value);
                        numFilters++;
                    } else if (dropdownValues !== null && dropdownValues.value !== "score") {
//                        let value = dropdownValues.value;
//                        let splitValues = value.split(',');
//                        for (let i = 0; i < splitValues.length; i++) {
//                            pss.push(subsScore.toLowerCase() + "==" + splitValues[i]);
//                        }
                        pss.push(subsScore.toLowerCase() + "==" + dropdownValues.value);
                        numFilters++;
                    }
                });
                // If both Sift and Polyphen are selected then we activate the AND/OR control
                if (numFilters === 2) {
                    $("input:radio[name=pss]").attr('disabled', false);
                }
                if (!!pss && pss.length > 0) {
                    const filter = $('input:radio[name=pss]:checked').val();
                    _filters.protein_substitution = pss.join(filter === "and" ? ';' : ',');
                }

                // Cadd scores
                let cadd = [];
                let caddRawInput = PolymerUtils.getElementById(this.prefix + "CaddRawInput");
                let caddScaledInput = PolymerUtils.getElementById(this.prefix + "CaddScaledInput");
                if (UtilsNew.isNotUndefinedOrNull(caddRawInput) && UtilsNew.isNotUndefinedOrNull(caddScaledInput)) {
                    if (UtilsNew.isNotEmpty(caddRawInput.value)) {
                        cadd.push("cadd_raw" + PolymerUtils.getElementById(this.prefix + "CaddRawOperator").value + caddRawInput.value);
                    }
                    if (UtilsNew.isNotEmpty(caddScaledInput.value)) {
                        cadd.push("cadd_scaled" + PolymerUtils.getElementById(this.prefix + "CaddScaledOperator").value + caddScaledInput.value);
                    }
                }
                if (cadd.length > 0) {
                    _filters["annot-functional-score"] = cadd.join(',');
                }

                // Conservation
                const arr = {"Phylop": "phylop", "Phastcons": "phastCons", "Gerp": "gerp"};
                let conserArr = [];
                for (const key in arr) {
                    const inputTextArea = PolymerUtils.getElementById(`${this.prefix}${key}Input`);
                    if (!!inputTextArea && !!inputTextArea.value) {
                        const operator = PolymerUtils.getElementById(`${this.prefix}${key}Operator`);
                        conserArr.push(arr[key] + operator.value + inputTextArea.value);
                    }
                }

                // Disable OR/AND logical operator
                $("input:radio[name=conservation]").attr('disabled', conserArr.length > 1);
                if (conserArr.length > 0) {
                    const filter = $('input:radio[name=conservation]:checked').val();
                    _filters.conservation = conserArr.join(filter === "and" ? ';' : ',');
                }

                // Gene Ontology and Human Phenotype Ontology
                let inputTextArea = PolymerUtils.getElementById(this.prefix + "GeneOntologyTextarea");
                if (UtilsNew.isNotUndefinedOrNull(inputTextArea) && UtilsNew.isNotEmpty(inputTextArea.value)) {
                    _filters["annot-go"] = inputTextArea.value;
                }

                inputTextArea = PolymerUtils.getElementById(this.prefix + "HumanPhenotypeOntologyTextarea");
                if (UtilsNew.isNotUndefinedOrNull(inputTextArea) && UtilsNew.isNotEmpty(inputTextArea.value)) {
                    const hpoValues = inputTextArea.value.split(",");
                    if (UtilsNew.isNotEmptyArray(hpoValues)) {
                        $("input:radio[name=hpoRadio]").attr('disabled', false);
                        const filter = $('input:radio[name=hpoRadio]:checked').val();
                        _filters["annot-hpo"] = hpoValues.join(filter === "and" ? ';' : ',');
                    }
                }

                inputTextArea = PolymerUtils.getElementById(this.prefix + "ClinVarTextarea");
                if (UtilsNew.isNotUndefinedOrNull(inputTextArea) && UtilsNew.isNotEmpty(inputTextArea.value)) {
                    _filters["clinvar"] = inputTextArea.value;
                }

                inputTextArea = PolymerUtils.getElementById(this.prefix + "TraitsTextarea");
                if (UtilsNew.isNotUndefinedOrNull(inputTextArea) && UtilsNew.isNotEmpty(inputTextArea.value)) {
                    _filters["traits"] = inputTextArea.value;
                }

                // VCF Filter -> PASS, QualByDepth, FisherStrand, RMSMappingQuality,
                const vcfFilterDropdown = PolymerUtils.getElementById(this.prefix + "vcfFilterSelect");
                if (!!vcfFilterDropdown && !!vcfFilterDropdown.value) {
                    const types = PolymerUtils.querySelectorAll("option:checked", vcfFilterDropdown);
                    const vcfFilters = Object.keys(types).map(optionKey => types[optionKey].value);
                    _filters["filter"] = vcfFilters.join(",");
                    _filters["files"] = this.samplesFiles.join(",");
                }

                // To prevent to call setQueryFilters we set this to false
                this._reset = false;
                this.query = _filters;
                this._reset = true;
            }

            _clearHtmlDom() {
                // Empty everything before rendering
                $("." + this.prefix + "FilterSelect").prop('selectedIndex', 0);
                $("." + this.prefix + "FilterSelect").prop("disabled", false);
                $("." + this.prefix + "FilterTextInput").val("");
                $("." + this.prefix + "FilterTextInput").prop("disabled", false);
                $("." + this.prefix + "FilterCheckBox").prop("checked", false);
                $("." + this.prefix + "FilterRadio").prop("checked", false);
                $("." + this.prefix + "FilterRadio").filter('[value="or"]').prop('checked', true);
                $("." + this.prefix + "FilterRadio").prop("disabled", true);

                // Deselect bootstrap-select dropdowns
                $("#" + this.prefix + "PanelApps").selectpicker('val', []);
                $("#" + this.prefix + "vcfFilterSelect").selectpicker('val', []);
            }


            // This method is only executed one time from connectedCallback function
            _renderFilterMenu() {

                // This set the generated HTML in the DIV element
                const sections = this.config.menu.sections.filter(section => !["Study", "Genomic"].includes(section.title));
                const html = sections.map(section => this._createSection(section, this.prefix)).join('');
                this.$.FilterMenu.innerHTML = html;

                // Add events and tooltips to the filter menu
                this._addEventListeners();

                // If Samples or Family properties have been passed then we hide the Sample selector
                // if (UtilsNew.isNotEmptyArray(this.samples)) {
                //     PolymerUtils.hide(this.prefix + "AutocompleteSampleSelect");
                // }
            }

            _createSection(section, prefix) {
                const id = section.title.replace(/ /g, "");
                const collapsed = section.collapsed ? "" : "in";

                const header= `
                    <div class="panel panel-default" style="margin-bottom: 10px">
                        <div class="panel-heading" role="tab" id="${prefix}${id}Heading">
                            <h4 class="panel-title">
                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#${prefix}Accordion"
                                    href="#${prefix}${id}" aria-expanded="true" aria-controls="${prefix}${id}">
                                    ${section.title}
                                </a>
                            </h4>
                        </div>

                        <div id="${prefix}${id}" class="panel-collapse collapse ${collapsed}" role="tabpanel" aria-labelledby="${prefix}${id}Heading">
                            <div class="panel-body">
                `;

                // We get the HTML content for each subsection
                const content = section.subsections
                                .filter(subsection => !(this.config.menu.skipSubsections || []).includes(subsection.id))
                                .map(this._createSubSection.bind(this))
                                .join('');

                const footer = Array(3+1).join('</div>');

                return header + content + footer;
            }

            _createSubSection(subsection) {

                // Add subsection header
                const header = `
                    <div class="form-group">
                        <div class="browser-subsection" id="${subsection.id}" name="${subsection.title}">${subsection.title}
                            <jsorolla-tooltip header="${subsection.title}" content="${subsection.tooltip}"></jsorolla-tooltip>
                        </div>
                        <div id="${this.prefix}${subsection.id}" class="subsection-content">
                `;

                let content = "";
                switch (subsection.id) {
                    case "sample":
                        this.decisionTreeInheritance = subsection.decisionTreeInheritance;
                        content = this._getSampleHtml(subsection, this.prefix);
                        break;
                    case "cohort":
                        content = this._getCohortHtml(subsection.cohorts, this.prefix);
                        break;
                    case "study":
                        content = this._getStudyHtml(this.prefix);
                        break;
                    case "geneDiseasePanels":
                        content = this._getGeneDiseasePanelsHtml(this.prefix);
                        break;
                    case "populationFrequency":
                        content = this._getPopulationFrequencyHtml(this.prefix);
                        break;
                    case "proteinSubstitutionScore":
                        content = this._getProteinSubstitutionScoreHtml(this.prefix);
                        break;
                    case "cadd":
                        content = this._getCaddHtml(this.prefix);
                        break;
                    case "conservation":
                        content = this._getConservationHtml(this.prefix);
                        break;
                    case "go":
                        content = this._getGoAccessionsHtml(this.prefix);
                        break;
                    case "hpo":
                        content = this._getHpoAccessionsHtml(this.prefix);
                        break;
                    case "clinvar":
                        content = this._getClinvarAccessionsHtml(this.prefix);
                        break;
                    case "fullTextSearch":
                        content = this._getFullTextSearchAccessionsHtml(this.prefix);
                        break;
                    case "vcfFilterDropdown":
                        content = this._getVCFFilterHTML(subsection.filterValues, this.prefix);
                        break;
                    case "externalPanels":
                        content = this._getExternalPanelsHTML(this.prefix);
                        break;
                }

                // Add subsection footer
                const footer = Array(2+1).join('</div>');

                return header + content + footer;
            }

            _getCohortHtml(cohorts, prefix) {
                let projectFields = this.opencgaSession.project.alias.split("@");
                let projectId = (projectFields.length > 1) ? projectFields[1] : projectFields[0];
                let cohortsPerStudy = cohorts[projectId];

                if (UtilsNew.isNotUndefinedOrNull(cohortsPerStudy)) {
                    let content = "";
                    for (let study of Object.keys(cohortsPerStudy)) {
                        content += `
                        <div style="padding-left: 5px;padding-top: 10px">
                            <span><em>${study}</em> study:</span>
                    `;

                        let cohorts = cohortsPerStudy[study];
                        for (let cohort of cohorts) {
                            content += `
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <span class="col-md-4 control-label">${cohort.name}</span>
                                    <div class="col-md-4" style="padding: 0px 10px">
                                        <select id="${prefix}${study}${cohort.id}CohortOperator" name="${cohort.id}Operator"
                                                    class="form-control input-sm ${prefix}FilterSelect" style="padding: 0px 5px">
                                            <option value="<" selected><</option>
                                            <option value="<="><=</option>
                                            <option value=">">></option>
                                            <option value=">=">>=</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" value="" class="form-control input-sm col-md-4 ${prefix}FilterTextInput"
                                                    name="${study}_${cohort.id}" id="${prefix}${study}${cohort.id}Cohort">
                                    </div>
                                </div>
                            </div>
                        `;
                        }
                        content += "</div>";
                    }
                    return content;
                } else {
                    return "<span>Project not found</span>"
                }
            }

            _getStudyHtml(prefix) {
                let options = "";
                if (UtilsNew.isNotUndefinedOrNull(this.differentStudies)) {
                    for (let study of this.differentStudies) {
                        options += `<br>
                                    <input id="${prefix}${study.alias}Checkbox" type="checkbox" value="${study.alias}" data-id="${study.id}" class="${prefix}FilterCheckBox">
                                    ${study.alias}
                               `;
                    }
                }

                return `
                    <select class="form-control input-sm ${prefix}FilterSelect" id="${prefix}includeOtherStudy">
                        <option value="in" selected>In all (AND)</option>
                        <option value="atleast">In any of (OR)</option>
                    </select>

                    <div id="${prefix}DifferentStudies" class="form-group">
                        <br>
                        <input type="checkbox" value="${this.opencgaSession.study.alias}" data-id="${this.opencgaSession.study.id}" checked disabled>
                        <span style="font-weight: bold;font-style: italic;color: darkred">
                            ${this.opencgaSession.study.alias}
                        </span>
                        ${options}
                    </div>
                `;
            }

            _getGeneDiseasePanelsHtml(prefix) {
                // let options = "";
                // let _this = this;
                // this.opencgaClient.panels()
                //     .search({
                //         study: _this.opencgaSession.project.alias + ":" + _this.opencgaSession.study.alias,
                //         include: "id,name,stats"
                //     }, {})
                //     .then(function (response) {
                //         options += `<optgroup label="Study Panels of ${_this.opencgaSession.study.alias}">`;
                //         if (response.response[0].result.length === 0) {
                //             options += "<option disabled>None</option>";
                //         } else {
                //             for (let panel of response.response[0].result) {
                //                 if (panel.stats.numberOfGenes > 0) {
                //                     options += `<option value="${panel.name}">${panel.name} (${panel.stats.numberOfGenes})</option>`;
                //                 }
                //             }
                //         }
                //         options += "</optgroup>";
                //
                //         // Search Global Panels
                //         _this.opencgaClient.panels()
                //             .search({
                //                 globalPanels: true,
                //                 include: "id,name,stats"
                //             }, {})
                //             .then(function (response) {
                //                 options += `<optgroup label="Global Panels">`;
                //                 for (let panel of response.response[0].result) {
                //                     if (panel.stats.numberOfGenes > 0) {
                //                         options += `<option value="${panel.name}">${panel.name} (${panel.stats.numberOfGenes})</option>`;
                //                     }
                //                 }
                //                 options += "</optgroup>";
                //
                //                 let content = `
                //                         <select id="${prefix}PanelApps" class="selectpicker show-tick ${prefix}FilterSelect" data-size="10" data-live-search="true"
                //                             data-max-options="1" data-selected-text-format="count" multiple>
                //                             ${options}
                //                         </select>
                //                         <div style="padding-top: 5px">
                //                             <textarea id="${prefix}PanelAppsTextarea" name="panelAppsTextarea"
                //                               class="form-control clearable ${prefix}FilterTextInput"
                //                               rows="3" placeholder="No panel selected"></textarea>
                //                         </div>
                //                 `;
                //                 PolymerUtils.innerHTML(_this.prefix + "DiseasePanelDropdown", content);
                //             });
                //         //
                //     //     let content = `
                //     //      <select id="${prefix}PanelApps" class="selectpicker show-tick ${prefix}FilterSelect" data-size="10" data-live-search="true"
                //     //             data-max-options="1" data-selected-text-format="count" multiple>
                //     //         ${options}
                //     //     </select>
                //     //     <div style="padding-top: 5px">
                //     //         <textarea id="${prefix}PanelAppsTextarea" name="panelAppsTextarea"
                //     //                   class="form-control clearable ${prefix}FilterTextInput"
                //     //                   rows="3" placeholder="No panel selected"></textarea>
                //     //     </div>
                //     // `;
                //     //     PolymerUtils.innerHTML(_this.prefix + "DiseasePanelDropdown", content);
                //     });

                if (UtilsNew.isNotUndefinedOrNull(this.panelList)) {
                    let options = "";
                    this.panelList.sort((a, b) => {
                        if (a.title === b.title) {
                            return 0;
                        }
                        return a.title < b.title ? -1 : 1;
                    }).forEach((item) => {
                        options += `<option value="${item.name}">${item.title} (${item.genes.length})</option>`;
                    });

                    // <select class="form-control ${prefix}FilterSelect" id="${prefix}PanelApps">
                    //     <option value="none">Select a panel...</option>
                    //     ${options}
                    // </select>

                    return `
                         <select id="${prefix}PanelApps" class="selectpicker show-tick ${prefix}FilterSelect" data-size="10" data-live-search="true"
                                data-max-options="1" data-selected-text-format="count" multiple>
                            ${options}
                        </select>
                        <div style="padding-top: 5px">
                            <textarea id="${prefix}PanelAppsTextarea" name="panelAppsTextarea"
                                      class="form-control clearable ${prefix}FilterTextInput"
                                      rows="3" placeholder="No panel selected"></textarea>
                        </div>
                    `;

                    // return `<div id="${prefix}DiseasePanelDropdown"></div>`;
                }
            }

            _getPopulationFrequencyHtml(prefix) {
                let content = "";
                for (let study of this.populationFrequencies.studies) {
                    content += `
                        <div style="padding-top: 10px">
                            <i id="${this.prefix}${study.id}Icon" data-id="${this.prefix}${study.id}"
                                    class="fa fa-plus" style="cursor: pointer;padding-right: 10px"></i>
                            <strong>${study.title}</strong>
                            <div id="${prefix}${study.id}" class="form-horizontal" hidden>
                                <div class="row" style="margin: 5px 0px">
                                     <span class="col-md-7 control-label" data-toggle="tooltip" data-placement="top" style="text-align: left;">Set all</span>
                                         <div class="col-md-5" style="padding: 0px 10px">
                                            <input id="${prefix}${study.id}Input" type="text" data-study="${study.id}" value="" class="form-control input-sm ${prefix}FilterTextInput"
                                                            name="${study.id}Input">
                                         </div>
                                </div>
                    `;

                    for (let popFreq of study.populations) {
                        content += `
                                <div class="row" style="margin: 5px 0px">
                                    <span class="col-md-3 control-label" data-toggle="tooltip" data-placement="top" title="${popFreq.title}">${popFreq.id}</span>
                                    <div class="col-md-4" style="padding: 0px 10px">
                                        <select id="${prefix}${study.id}${popFreq.id}Operator" name="${popFreq.id}Operator"
                                                class="form-control input-sm ${prefix}FilterSelect" style="padding: 0px 5px">
                                            <option value="<" selected><</option>
                                            <option value="<="><=</option>
                                            <option value=">">></option>
                                            <option value=">=">>=</option>
                                        </select>
                                    </div>
                                    <div class="col-md-5" style="padding: 0px 10px">
                                        <input id="${prefix}${study.id}${popFreq.id}" type="text" value="" class="form-control input-sm ${prefix}FilterTextInput"
                                                name="${study.id}_${popFreq.id}">
                                    </div>
                                </div>
                        `;
                    }

                    content += `
                            </div>
                        </div>
                    `;
                }

                return content;
            }

            _getProteinSubstitutionScoreHtml(prefix) {
                return `
                    <div style="padding-top: 10px">
                        <span style="padding-left: 0px;">SIFT</span>
                        <div class="row">
                            <div class="col-md-5" style="padding-right: 5px">
                                <select  name="Sift" id="${prefix}SiftValues" class="${prefix}FilterSelect form-control input-sm options">
                                    <option value="score" selected>Score...</option>
                                    <option value="tolerated">Tolerated</option>
                                    <option value="deleterious">Deleterious</option>
                                </select>
                            </div>
                            <div class="col-md-3" style="padding: 0px 5px">
                                <select name="siftOperator" id="${prefix}SiftOperator" class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                    <option value="<"><</option>
                                    <option value="<="><=</option>
                                    <option value=">"selected>></option>
                                    <option value=">=">>=</option>
                                </select>
                            </div>
                            <div class="col-md-4" style="padding-left: 5px">
                                <input id="${prefix}SiftInput" name="Sift" type="text" value=""
                                            class="${prefix}FilterTextInput form-control input-sm">
                            </div>
                        </div>
                    </div>

                    <div style="padding-top: 15px">
                        <span style="padding-top: 10px;padding-left: 0px;">Polyphen</span>
                        <div class="row">
                            <div class="col-sm-5" style="padding-right: 5px">
                                <select name="Polyphen" id="${prefix}PolyphenValues" class="${prefix}FilterSelect form-control input-sm options">
                                    <option value="score" selected>Score...</option>
                                    <option value="benign">Benign</option>
                                    <option value="unknown">Unknown</option>
                                    <option value="possibly damaging">Possibly damaging</option>
                                    <option value="probably damaging">Probably damaging</option>
                                    <option value="possibly damaging,probably damaging">Possibly & Probably damaging</option>
                                </select>
                            </div>
                            <div class="col-sm-3" style="padding: 0px 5px">
                                <select name="polyphenOperator" id="${prefix}PolyphenOperator" class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                    <option value=">" selected>></option>
                                    <option value=">=">>=</option>
                                    <option value="<" ><</option>
                                    <option value="<="><=</option>
                                </select>
                            </div>
                            <div class="col-sm-4" style="padding-left: 5px">
                                <input type="text" value="" class="${prefix}FilterTextInput form-control input-sm"
                                            id="${prefix}PolyphenInput" name="Polyphen" >
                            </div>
                        </div>

                        <form style="padding-top: 15px">
                            <label style="font-weight: normal;">Logical Operator</label>
                            <input type="radio" name="pss" id="${prefix}pssOrRadio" value="or" class="${prefix}FilterRadio"
                                    checked disabled  style="margin-left: 10px"> OR<br>
                            <input type="radio" name="pss" id="${prefix}pssAndRadio" value="and"
                                    class="${prefix}FilterRadio" disabled style="margin-left: 102px"> AND  <br>
                        </form>
                        <br>
                    </div>
                `;
            }

            _getCaddHtml(prefix) {
                return `
                    <div style="padding-top: 10px">
                        <div class="row">
                            <div class="col-md-5 form-group" style="padding-right: 5px">
                                <span class="control-label">Raw</span>
                            </div>
                            <div class="col-md-3" style="padding: 0px 5px">
                                <select name="caddRawOperator" id="${prefix}CaddRawOperator"
                                 class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                    <option value="<"><</option>
                                        <option value="<="><=</option>
                                        <option value=">" selected>></option>
                                        <option value=">=">>=</option>
                                </select>
                            </div>
                            <div class="col-md-4" style="padding-left: 5px">
                                <input type="text" value="" class="${prefix}FilterTextInput form-control input-sm"
                                   id="${prefix}CaddRawInput" name="caddRaw">
                            </div>

                        </div>
                    </div>

                    <div style="padding-top: 10px">
                        <div class="row">
                            <span class="col-md-5 control-label" style="padding-right: 5px">Scaled</span>
                            <div class="col-md-3" style="padding: 0px 5px">
                                <select name="caddRScaledOperator" id="${prefix}CaddScaledOperator"
                                class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                            </div>
                            <div class="col-md-4" style="padding-left: 5px">
                                <input type="text" value="" class="${prefix}FilterTextInput form-control input-sm"
                                       id="${prefix}CaddScaledInput" name="caddScaled">
                            </div>
                        </div>
                    </div>
                `;
            }

            _getConservationHtml(prefix) {
                return `
                    <div style="padding-top: 10px">
                        <div class="row">
                            <span class="col-md-5 control-label" style="padding-right: 5px"> PhyloP</span>
                            <div class="col-md-3" style="padding: 0px 5px">
                                <select name="phylopOperator" id="${prefix}PhylopOperator" class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                    <option value="<"><</option>
                                    <option value="<="><=</option>
                                    <option value=">" selected>></option>
                                    <option value=">=">>=</option>
                                </select>
                            </div>
                            <div class="col-md-4" style="padding-left: 5px">
                                <input type="text" value="" class="${prefix}FilterTextInput form-control input-sm"
                                   id="${prefix}PhylopInput" name="phylop">
                            </div>
                        </div>
                    </div>

                     <div style="padding-top: 10px">
                        <div class="row">
                            <span class="col-md-5 control-label" style="padding-right: 5px">PhastCons</span>
                            <div class="col-md-3" style="padding: 0px 5px">
                                <select name="phastconsOperator" id="${prefix}PhastconsOperator"
                                       class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                    <option value="<" ><</option>
                                    <option value="<="><=</option>
                                    <option value=">" selected>></option>
                                    <option value=">=">>=</option>
                                </select>
                            </div>
                            <div class="col-md-4" style="padding-left: 5px">
                                <input type="text" value="" class="${prefix}FilterTextInput form-control input-sm"
                                   id="${prefix}PhastconsInput" name="phastCons">
                            </div>
                        </div>
                    </div>

                    <div style="padding-top: 10px">
                        <div class="row">
                            <span class="col-md-5 control-label" style="padding-right: 5px">Gerp</span>
                            <div class="col-md-3" style="padding: 0px 5px">
                                <select name="gerpOperator" id="${prefix}GerpOperator"
                                        class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                    <option value="<"><</option>
                                    <option value="<="><=</option>
                                    <option value=">" selected>></option>
                                    <option value=">=">>=</option>
                                </select>
                             </div>
                            <div class="col-md-4" style="padding-left: 5px">
                                <input type="text" value="" class="${prefix}FilterTextInput form-control input-sm"
                                        id="${prefix}GerpInput" name="gerp">
                            </div>
                        </div>

                        <form style="padding-top: 15px">
                            <label style="font-weight: normal;">Logical Operator</label>
                            <input type="radio" name="conservation" id="${prefix}conservationOrRadio" value="or"
                                    class="${prefix}FilterRadio" checked disabled style="margin-left: 10px"> OR<br>
                            <input type="radio" name="conservation" id="${prefix}conservationAndRadio" value="and"
                                    class="${prefix}FilterRadio" disabled style="margin-left: 102px"> AND<br>
                        </form>
                    </div>
                `;
            }

            _getGoAccessionsHtml(prefix) {
                return `
                    <textarea id="${prefix}GeneOntologyTextarea" class="form-control clearable ${prefix}FilterTextInput"
                                rows="3" name="geneOntology" placeholder="GO:0000145"></textarea>
                    <span class="input-group-addon btn btn-primary searchingSpan" id="${prefix}buttonOpenGoAccesions">
                        <strong style="color: white">Add GO Term</strong>
                        <i class="fa fa-search searchingButton" aria-hidden="true"></i>
                    </span>
                `;
            }

            _getHpoAccessionsHtml(prefix) {
                return `
                    <textarea id="${prefix}HumanPhenotypeOntologyTextarea" class="form-control clearable ${prefix}FilterTextInput"
                                rows="3" name="hpo" placeholder="HP:0000001, HP:3000079"></textarea>
                    <span class="input-group-addon btn btn-primary searchingSpan" id="${prefix}buttonOpenHpoAccesions">
                        <strong style="color: white">Add HPO Term</strong>
                        <i class="fa fa-search searchingButton" aria-hidden="true"></i>
                    </span>
                     <form style="padding-top: 15px">
                        <label style="font-weight: normal;">Logical Operator</label>
                        <input type="radio" name="hpoRadio" id="${prefix}hpoOrRadio" value="or" class="${prefix}FilterRadio"
                                checked style="margin-left: 10px"> OR<br>
                        <input type="radio" name="hpoRadio" id="${prefix}hpoAndRadio" value="and"
                                class="${prefix}FilterRadio" style="margin-left: 102px"> AND  <br>
                    </form>
                `;
            }

            _getClinvarAccessionsHtml(prefix) {
                return `
                    <textarea id="${prefix}ClinVarTextarea" class="form-control clearable ${prefix}FilterTextInput" rows="3"
                                name="clinvar" placeholder="RCV000058226"></textarea>
                `;
            }

            _getFullTextSearchAccessionsHtml(prefix) {
                return `
                    <textarea id="${prefix}TraitsTextarea" class="form-control clearable ${prefix}FilterTextInput" rows="5"
                                name="traits" placeholder="Full-text search, e.g. *melanoma*"></textarea>
                `;
            }

            _getVCFFilterHTML(filterValues, prefix) {
                let options = "";
                for (let val of filterValues) {
                    options += `<option value="${val}">${val}</option>`;
                }
                return `
                    <select class="selectpicker" id="${prefix}vcfFilterSelect" data-size="10" data-live-search="true"
                            data-selected-text-format="count" multiple>
                        ${options}
                    </select>
                `;
            }


            _getExternalPanelsHTML(prefix){
                return `<div id="${prefix}AutocompleteExternalPanel" style="margin: 15px 0px">
                        <span>Select MMP panel:</span>

                        <div class="row">
                            <div class="col-md-12">
                                <input id="${prefix}AutocompleteExternalPanelSearchInput" type="text" class="form-control" placeholder="Search name..."
                                    list="${prefix}AutocompleteExternalPanelSearchDataList">
                                <datalist id="${prefix}AutocompleteExternalPanelSearchDataList"></datalist>
                            </div>

                        </div>
                     </div>
                     <div style="padding-top: 5px">
                        <textarea id="${prefix}ExternalPanelAppsTextarea" readonly name="externalPanelAppsTextarea"
                          class="form-control clearable ${prefix}FilterTextInput"
                          rows="3" placeholder="No panel selected"></textarea>
                    </div>
`;
            }


            _addEventListeners() {
                const keyupEvents = ["PanelAppsTextarea", "FilterTextInput", "CaddRawInput", "CaddScaledInput", "SiftInput",
                    "PolyphenInput", "PhylopInput", "PhastconsInput", "GerpInput", "GeneOntologyTextarea", "HumanPhenotypeOntologyTextarea", "ClinVarTextarea", "TraitsTextarea"];
                for (const id of keyupEvents) {
                    const element = PolymerUtils.getElementById(this.prefix + id);
                    if (!!element) {
                        element.addEventListener('keyup', this.updateQueryFilters.bind(this));
                    }
                }

                const changeEvents = ["includeOtherStudy", "GenotypeQueryOptions", "GeneBiotypes", "Type", "CaddRawOperator", "CaddScaledOperator", "SiftOperator", "PolyphenOperator",
                    "pssOrRadio", "pssAndRadio", "PhylopOperator", "PhastconsOperator", "GerpOperator", "conservationAndRadio", "conservationOrRadio", "vcfFilterSelect",
                    "hpoOrRadio", "hpoAndRadio"];
                for (const id of changeEvents) {
                    const element = PolymerUtils.getElementById(this.prefix + id);
                    if (!!element) {
                        element.addEventListener('change', this.updateQueryFilters.bind(this));
                    }
                }

                // removed for 20180924 course
                // Add events for Sample IDs
                // let autoCompleteSampleElement = PolymerUtils.getElementById(this.prefix + "AutocompleteSampleSearchInput");
                // if (UtilsNew.isNotUndefinedOrNull(autoCompleteSampleElement)) {
                //     autoCompleteSampleElement.addEventListener('keyup', this._autocompleteSampleSearch.bind(this));
                //     PolymerUtils.getElementById(this.prefix + "SampleAddButton").addEventListener('click', this.onSampleChange.bind(this));
                // }
                // Add event for inheritanceMode
                // let inheritanceModeElement = PolymerUtils.getElementById(this.prefix + "SegregationOperator");
                // if (UtilsNew.isNotUndefinedOrNull(inheritanceModeElement)) {
                //     inheritanceModeElement.addEventListener('change', this.selectInheritanceMode.bind(this));
                // }

                // ApproxCountCheckbox
                // let approxCountCheckbox = PolymerUtils.getElementById(this.prefix + "ApproxCountCheckbox");
                // if (UtilsNew.isNotUndefinedOrNull(approxCountCheckbox)) {
                //     approxCountCheckbox.addEventListener('change', this.onApproxCountChange.bind(this));
                // }


                // Add events for Cohort
//                let cohorts = this.config.menu.sections.forEach(section => section.subsections.forEach(subsection => {if (subsection.id === "cohort") return subsection}));
                for (let section of this.config.menu.sections) {
                    for (let subsection of section.subsections) {
                        if (subsection.id === "cohort") {
                            let projectFields = this.opencgaSession.project.alias.split("@");
                            let projectId = (projectFields.length > 0) ? projectFields[1] : projectFields[0];

                            if (UtilsNew.isNotUndefinedOrNull(subsection.cohorts[projectId])) {
                                for (let study of Object.keys(subsection.cohorts[projectId])) {
                                    for (let cohort of subsection.cohorts[projectId][study]) {
                                        let element = PolymerUtils.getElementById(this.prefix + study + cohort.id + "CohortOperator");
                                        if (UtilsNew.isNotUndefinedOrNull(element)) {
                                            element.addEventListener('change', this.updateQueryFilters.bind(this));
                                        }
                                        element = PolymerUtils.getElementById(this.prefix + study + cohort.id + "Cohort");
                                        if (UtilsNew.isNotUndefinedOrNull(element)) {
                                            element.addEventListener('keyup', this.updateQueryFilters.bind(this));
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                // Add events for Studies checkboxes
                if (UtilsNew.isNotUndefinedOrNull(this.differentStudies)) {
                    for (let study of this.differentStudies) {
                        let element = PolymerUtils.getElementById(this.prefix + study.alias + "Checkbox");
                        if (UtilsNew.isNotUndefinedOrNull(element)) {
                            element.addEventListener('change', this.updateQueryFilters.bind(this));
                        }
                    }
                }

                // Add events for gene disease panels
                let element = PolymerUtils.getElementById(this.prefix + "PanelApps");
                if (UtilsNew.isNotUndefinedOrNull(element)) {
                    element.addEventListener('change', this.onGeneDiseasePanelChange.bind(this));
                }

                // Add events for Population Frequency
                for (let study of this.populationFrequencies.studies) {
                    let element = PolymerUtils.getElementById(this.prefix + study.id + "Icon");
                    let inputAll = PolymerUtils.getElementById(this.prefix + study.id + "Input");
                    if (UtilsNew.isNotUndefinedOrNull(element)) {
                        element.addEventListener('click', this.handleCollapseAction.bind(this));
                    }

                    if (UtilsNew.isNotUndefinedOrNull(inputAll)) {
                        inputAll.addEventListener('keyup', this.keyUpAllPopFreq.bind(this));
                        inputAll.addEventListener('change', this.updateQueryFilters.bind(this));
                    }

                    for (let pop of study.populations) {
                        PolymerUtils.getElementById(this.prefix + study.id + pop.id).addEventListener('keyup', this.updateQueryFilters.bind(this));
                        PolymerUtils.getElementById(this.prefix + study.id + pop.id + "Operator").addEventListener('change', this.updateQueryFilters.bind(this));
                    }
                }

                // Add events Protein substitution score
                PolymerUtils.getElementById(this.prefix + "SiftValues").addEventListener('change', this.checkScore.bind(this));
                PolymerUtils.getElementById(this.prefix + "PolyphenValues").addEventListener('change', this.checkScore.bind(this));

                // Add events GO accessions
                PolymerUtils.getElementById(this.prefix + "buttonOpenGoAccesions").addEventListener('click', this.openModalGo.bind(this));

                // Add events hpo accessions
                PolymerUtils.getElementById(this.prefix + "buttonOpenHpoAccesions").addEventListener('click', this.openModalHpo.bind(this));

                // Add events for externalPanel
                let autoCompleteExternalPanels = PolymerUtils.getElementById(this.prefix + "AutocompleteExternalPanelSearchInput");
                if (UtilsNew.isNotUndefinedOrNull(autoCompleteExternalPanels)) {
//                    autoCompleteExternalPanels.addEventListener('keyup', this._autocompleteExternalPanelSearch.bind(this));
                    // autoCompleteExternalPanels.addEventListener('input', this._autocompleteExternalPanelSearch.bind(this));
//                    PolymerUtils.getElementById(this.prefix + "SampleAddButton").addEventListener('click', this.onSampleChange.bind(this));
                }

            }

            // onApproxCountChange(e) {
            //     // this.query.approximateCount = e.target.checked;
            //     this.set("query.approximateCount", e.target.checked);
            // }

            onQueryChanged(e) {
                this.query = Object.assign({}, this.query);
            }
        }

        customElements.define(OpencgaVariantFilter.is, OpencgaVariantFilter);
    </script>
</dom-module>
