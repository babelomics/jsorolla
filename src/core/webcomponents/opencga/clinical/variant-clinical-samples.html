<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../catalog/samples/opencga-sample-grid.html">
<link rel="import" href="../catalog/samples/opencga-sample-filter.html">
<link rel="import" href="../catalog/samples/opencga-family-editor-new.html">
<link rel="import" href="../opencga-active-filters.html">
<link rel="import" href="../opencga-message-dialog.html">
<link rel="import" href="./variant-clinical-samples-analyses-table.html">

<dom-module id="variant-clinical-samples">
    <template>
        <style include="jso-styles"></style>

        <div class="row">
            <div class="col-md-2">
                <opencga-sample-filter opencga-session="{{opencgaSession}}" config="{{config}}" samples="{{samples}}"
                                       opencga-client="{{opencgaClient}}" query="{{query}}" search="{{search}}">
                </opencga-sample-filter>
            </div>

            <div class="col-md-10">
                <br>
                <opencga-active-filters opencga-client="{{opencgaSession.opencgaClient}}" query="{{query}}" filters="{{config.filters}}" default-study="{{opencgaSession.study.alias}}"
                                        alias="{{activeFilterAlias}}" refresh="{{search}}" on-clear="onClear" on-filterchange="onFilterChange">
                </opencga-active-filters>

                <h3>Sample Results</h3>
                <opencga-sample-grid opencga-client="{{opencgaClient}}" opencga-session="{{opencgaSession}}" config="[[config]]" event-notify-name="[[eventNotifyName]]" samples="{{samples}}" search="{{search}}"></opencga-sample-grid>
                <br>

                <h3>Actions</h3>
                <div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" on-click="addAnalysis" disabled="[[!samples.length]]">
                            Create analysis
                        </button>
                        <button type="button" class="btn btn-primary" on-click="editFamilyRelations" disabled="[[!samples.length]]">
                            Edit family relations
                        </button>
                    </div>
                <br>


                <div style="padding: 10px 0px">
                    <h3>Clinical Analysis</h3>
                    <template is="dom-repeat" items="[[messageSuccess]]" as="message">
                        <div class="alert alert-success" role="alert" style="margin:0 auto;">[[message]]</div>
                    </template>
                    <template is="dom-repeat" items="[[messageErrorText]]" as="message">
                            <div class="alert alert-danger" role="alert" style="margin:0 auto;">[[message]]</div>
                    </template>
                    <template is="dom-if" if="{{pendingAnalyses.length}}">
                        <div class="alert alert-warning" role="alert" style="margin:0 auto;">There are unsaved analyses!</div>
                    </template>
                    <variant-clinical-samples-analyses-table
                            opencga-session="[[opencgaSession]]"
                            opencga-client="[[opencgaClient]]"
                            analyses="[[pendingAnalyses]]"
                            on-remove-analysis="onRemovePendingAnalysis"
                            on-message="onMessage"
                    ></variant-clinical-samples-analyses-table>
                </div>
            </div>
        </div>

        <!-- Modal dialog for Family Editor-->
        <div
                class="modal fade"
                id="{{prefix}}FamilyEditor"
                tabindex="-1"
                role="dialog"
                aria-labelledby="familyEditorLabel">
            <div class="modal-dialog modal-sm" role="document" style="width:90%">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="{{prefix}}FamilyEditorLabel">Family Editor</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <template is="dom-if" if="{{showModalFamilyEditor}}" restamp="true">
                                <opencga-family-editor-new
                                        opencga-session="{{opencgaSession}}"
                                        opencga-client="{{opencgaClient}}"
                                        samples="{{_samplesAnalysis}}"
                                        family="{{family}}"
                                        on-familychange="familyChange"
                                        message-error-family="{{messageErrorFamily}}">
                                </opencga-family-editor-new>
                            </template>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" on-click="checkFamily">OK</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Modal dialog for warnings -->
        <div class="modal fade" id="{{prefix}}warningModal" tabindex="-1" role="dialog"
             aria-labelledby="warningLabel" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-sm" role="document" style="width: 500px;">
                <div class="modal-content">
                    <div class="modal-header alert alert-danger">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Warning!</h4>
                    </div>
                    <div id="{{prefix}}warningMsgDiv" class="modal-body" style="height: 100px"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <opencga-message-dialog
                opencga-client="{{opencgaClient}}"
                show-message-modal="{{showMessageModal}}"
                settings-message-modal="{{settingsMessageModal}}">
        </opencga-message-dialog>
    </template>

    <script>
        class VariantClinicalSamples extends Polymer.Element {

            static get is() {
                return 'variant-clinical-samples';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object,
                        observer: "clear"
                    },
                    opencgaClient: {
                        type: Object,
                    },
                    samples: {
                        type: Array,
                        notify: true,
                        observer: 'onSamplesChanged',
                    },
                    prefix: {
                        type: String
                    },
                    filters: {
                        type: Object,
                        notify: true,
                        observer: "onFilterUpdate"
                    },
                    search: {
                        type: Object,
                        notify: true
                    },
                    config: {
                        type: Object
                    },
                    showMessageModal: {
                        type: Boolean,
                        notify: true
                    },
                    settingsMessageModal: {
                        type: Object,
                        notify: true
                    },
                    eventNotifyName: {
                        type: String,
                        value: "messageevent"
                    },
                    pendingAnalyses: {
                        type: Array,
                        value: () => [],
                    },
                    messageError: {
                        type: Array,
                        value: () => [],
                    },
                    messageSuccess: {
                        type: Array,
                        value: () => [],
                    },
                }
            }

            static get observers() {
                return ['calculateFilters(filteredVariables.variables.*)'];
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            constructor() {
                super();
                this.prefix = "sample" + Utils.randomString(6);
            }

            ready() {
                super.ready();
                this.clear();
            }

            connectedCallback() {
                super.connectedCallback();

                this.table = PolymerUtils.getElementById(this.prefix + "FamilySelector");
                const _this = this;
                $("#"+this.prefix + "FamilyEditor").on('shown.bs.modal', e => {
                    _this.showModalFamilyEditor = true;
                });

                $("#"+this.prefix + "FamilyEditor").on('hidden.bs.modal', () => {
                    _this.showModalFamilyEditor = false;
                });
            }

            onSamplesChanged(newValue, oldValue) {
                // TODO
            }

            getAnalysisButtonStyle(count) {
                return !!this.samples && this.samples.length > 0 ? "" : "opacity: 0.4; filter: alpha(opacity=40);";
            }

            clear() {
                this.samples = [];
                this.pendingAnalyses = [];
                this.currentAnalysis = {};
                this.selectedRow = -1;
                this.messageError = false;
                this.fixedFilters = ["studies"];
            }

            /**
             * If filters have been removed, clean the values from the forms.
             */
            onFilterUpdate() {
                this.updateForms(this.filters);
            }

            updateForms(filters) {
                // This is just to avoid entering here when it has just been initialized
                if (this.prefix === undefined) {
                    return;
                }

                let sampleName = PolymerUtils.getElementById(this.prefix + "NameTextarea").value;
                if (!filters.hasOwnProperty("name") && sampleName !== undefined && sampleName.length > 0) {
                    PolymerUtils.setPropertyById(this.prefix + "NameTextarea", "value", "");
                }

                let individual = PolymerUtils.getElementById(this.prefix + "IndividualTextarea").value;
                if (!filters.hasOwnProperty("individual.id") && individual !== undefined && individual.length > 0) {
                    PolymerUtils.setPropertyById(this.prefix + "IndividualTextarea", "value", "");
                }

                if (this.filteredVariables.variables.length > 0) {
                    if (!filters.hasOwnProperty("annotation")) {
                        this.set("filteredVariables.variables", []);
                    } else if (filters.annotation.length < this.filteredVariables.variables.length) {
                        let tmpVariables = [];
                        filters.annotation.forEach(function (variable) {
                            tmpVariables.push(variable);
                        });

                        this.set("filteredVariables.variables", tmpVariables);
                    }
                }
            }

            /**
             * Read from the values in the forms, and sets the filters.
             */
            calculateFilters() {
                let filters = {};
                let sampleName = "";
                let individual = "";

                if (PolymerUtils.getElementById(this.prefix + "NameTextarea") !== null) {
                    sampleName = PolymerUtils.setPropertyById(this.prefix + "NameTextarea", "value", "");

                }
                if (PolymerUtils.getElementById(this.prefix + "IndividualTextarea") !== null) {
                    individual = PolymerUtils.setPropertyById(this.prefix + "IndividualTextarea", "value", "");
                }

                if (sampleName !== undefined && sampleName.length > 0) {
                    filters["name"] = "~" + sampleName;
                }

                if (individual !== undefined && individual.length > 0) {
                    filters["individual.id"] = "~" + individual;
                }

                if (this.filteredVariables.variables !== undefined && this.filteredVariables.variables.length > 0) {
                    let annotations = [];
                    this.filteredVariables.variables.forEach(function (variable) {
                        annotations.push(variable);
                    });
                    filters["annotation"] = annotations;
                }
                this.filters = filters;
            }

            onSearch() {
                // Convert the filters to an objectParam that can be directly send to the sample search
                let filterParams = {};

                let keys = Object.keys(this.filters);
                for (let i = 0; i < keys.length; i++) {
                    if (Array.isArray(this.filters[keys[i]])) {
                        let myArray = this.filters[keys[i]];

                        let myArrayFilter = [];

                        // The elements in the array can be either an object
                        if (Object.getPrototypeOf(myArray[0]) === Object.prototype) {
                            let myArray = this.filters[keys[i]];
                            for (let j = 0; j < myArray.length; j++) {
                                // TODO: We have to check if the value already has an operand
                                myArrayFilter.push(myArray[j].name + "=" + myArray[j].value);
                            }
                        } else {
                            // Or an array of strings or numbers
                            myArrayFilter = this.filters[keys[i]];
                        }

                        filterParams[keys[i]] = myArrayFilter.join(";");
                    } else {
                        filterParams[keys[i]] = this.filters[keys[i]];
                    }
                }

                if (this.filters.hasOwnProperty("annotation")) {
                    // Add the variable set whose annotations will be queried
                    filterParams["variableSetId"] = this.filteredVariables.variableSet;
                }
                this.search = filterParams;
            }

            addAnalysis(e) {
                // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                e.preventDefault();

                if (this.analysisError(this.samples)) {
                    const fullDate = new Date();
                    const twoDigitMonth = ((fullDate.getMonth() + 1) >= 10) ? (fullDate.getMonth() + 1) : '0' + (fullDate.getMonth() + 1);
                    const currentDate = fullDate.getDate() + "/" + twoDigitMonth + "/" + fullDate.getFullYear();

                    // TODO: the way the ID is generated MUST be changed;
                    // with 700 analyses, 7% probability of collision (initial ID space was 1-10000)
                    // in any way, this is not a matter of increasing the ID space
                    // it should be solved other way (i.e., asking a new ID to the server)

                    const analysis = {
                        id: `AN-${1 + Math.floor(Math.random() * 10000000)}`,
                        date: currentDate,
                        diseaseSelected: "none",
                        samples: this.samples,
                    };

                    this.push('pendingAnalyses', analysis);
                }
            }

            // we don't want to worry about the details of sending a message in every function
            throwMessage(message, type) {
                const params = { detail: { message: message, type: type }, bubbles: true, composed: true };
                this.dispatchEvent(new CustomEvent(this.eventNotifyName, params));
            }

            analysisError(samples, checkDiseases = true) {
                if (!samples || samples.length == 0) {
                    const message = "An analysis must include at least one sample. Please, select one from the sample browser above.";
                    this.throwMessage(message, UtilsNew.MESSAGE_ERROR);
                    return false;
                } else {
                    // check all samples have an associated individual
                    const sampleHasIndividual = sample => (
                        !!sample && !!sample.attributes && !!sample.attributes.individual
                        && !!sample.attributes.individual.id && (sample.attributes.individual.id>0)
                    );
                    const allSamplesHaveIndividual = samples.every(sampleHasIndividual);
                    if (!allSamplesHaveIndividual) {
                        this.throwMessage("All samples must have an associated individual.", UtilsNew.MESSAGE_ERROR);
                        return false;
                    } else {
                        const anyDiseasedSamples = samples.some(sample => !!sample.phenotypes && sample.phenotypes.length > 0);
                        if (checkDiseases && !anyDiseasedSamples) {
                            this.throwMessage("At least one subject should be diseased.", UtilsNew.MESSAGE_ERROR);
                            return false;
                        } else {
                            return true;
                        }
                    }
                }
            }

            selectSubject(e){
                PolymerUtils.setValue(this.prefix + "selectedSubject" + this.currentAnalysis.analysisIDinternal, e.target.value);
            }

            onClear() {
                this.query = {studies: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias};
                this.search = {};
            }

            onFilterChange(e) {
                this.query = e.detail;
                this.search = e.detail;
            }

            onRemovePendingAnalysis(e) {
                if (!!e && !!e.detail) {
                    this.pendingAnalyses = this.pendingAnalyses.filter(analysis => analysis.id !== e.detail);
                }
            }

            onMessage(e) {
                const error = !!e && !!e.detail && !!e.detail.error;
                const message = !!e && !!e.detail && e.detail.message;
                const pthis = this;
                const queue = error ? 'messageError' : 'messageSuccess';
                this.push(queue, message);
                setTimeout(() => pthis.shift(queue), 5000);
            }

            //======================================================================================
            // family relations
            //======================================================================================

            editFamilyRelations() {
                if (this.analysisError(this.samples)) {
                    const message = "An analysis must include at least one sample. Please, select one from the sample browser above.";
                    this.throwMessage(message, UtilsNew.MESSAGE_ERROR);
                    return false;
                } else {
                    const sampleHasIndividual = sample => (
                        !!sample && !!sample.attributes && !!sample.attributes.individual
                        && !!sample.attributes.individual.id && (sample.attributes.individual.id>0)
                    );
                    const allSamplesHaveIndividual = samples.every(sampleHasIndividual);
                    if (!allSamplesHaveIndividual) {
                        const message = "Some samples do not have an associated individual, so they cannot be edited.";
                        this.throwMessage(message, UtilsNew.MESSAGE_ERROR);
                        return false;
                    } else {
                        // pass them to new family editor

                    }
                }
            }

            //======================================================================================
            // TODO: remove family related methods from this class
            //======================================================================================

            createFamily(params, body, rowInfo, subjectName, samplesName, analysisInfo){
                let _this = this;
                this.opencgaClient.families().create(params, body)
                    .then(function (response) {
                        if (response.response[0].numResults >= 1) {
                            _this.createAnalysis(analysisInfo);
                        }
                    })
                    .catch(function (response) {
                        _this.messageError = true;
                        _this.messageErrorText.push(analysisInfo.analysisID + " " + response.error);
//                        PolymerUtils.innerHTML(_this.prefix + "messageError", _this.messageErrorText);
                    });
            }

            initFamily() {
                if (!!this._samplesAnalysis) {
                    this.family = {};
                    this.family.name = "FA-" + Math.floor(Math.random() * 10000) + 1;
                    this.family.description = "";
                    this.family.phenotypes = [];
                    this.family.members = [];
                    this.family.annotationSets = [];
                    this.family.attributes = {};
                    let _this = this;
                    this._samplesAnalysis.forEach((sample) => {
                        _this.family.members[sample.id] = {
                            father: undefined,
                            mother: undefined,
                            phenotypes: [],
                            parentalConsanguinity: false
                        }
                    });
                }
            }

            familyFormatter(familyEditor, randomString) {
                if (familyEditor) {
                    return '<button data-toggle="modal" id="' + this.prefix + 'Editor' + randomString + '" role="button" type="button" class="btn btn-sm btn-success" data-target="#' + this.prefix + 'FamilyEditor" ><i class="fa fa-cog" aria-hidden="true"></i>&nbsp;Edit</button>';
                } else { // Is not a family analysis -> a family cannot be edited
                    return '<button data-toggle="modal" id="' + this.prefix + 'Editor' + randomString + '" role="button" type="button" class="btn btn-sm btn-success disabled" disabled data-target="#' + this.prefix + 'FamilyEditor"><i class="fa fa-cog" aria-hidden="true"></i>&nbsp;Edit</button>';
                }
            }

            familyChange(e) { // Event fired by opencga-family-editor web component
                this.family = e.detail._family;
                this._samplesAnalysis = e.detail._samples;
            }

            checkFamily(e) {
                e.preventDefault();

                let _this = this;
                let selectedRow = this.selectedRow;
                let family = this.family;
                let samples = this._samplesAnalysis
                let checkFamilyValidate = true;
                let messageErrorFamily = [];
                if (UtilsNew.isUndefinedOrNull(this.family.name) || UtilsNew.isEmpty(this.family.name)) {
                    checkFamilyValidate = false;
                    messageErrorFamily.push("Name is required.");
                }

                if (UtilsNew.isUndefinedOrNull(this.family.members) || UtilsNew.isEmptyArray(this.family.members)) {
                    checkFamilyValidate = false;
                    messageErrorFamily.push("Members are required.");
                }

                if (checkFamilyValidate) {
                    // We have to do this before updateRow to get the last selectedValue in member select. Instead we will get the first value of the all options
                    let subjectSelected = PolymerUtils.getValue(this.prefix + "selectedSubject" + this.currentAnalysis.analysisIDinternal);
                    let diseaseSelected = PolymerUtils.getValue(this.prefix + "selectedDisease" + this.currentAnalysis.analysisIDinternal);
                    $(PolymerUtils.getElementById(this.prefix + "tableAnalysis")).bootstrapTable('updateRow', {
                        index: selectedRow, row: {
                            family: family,
                            samples: samples
                        }
                    });
                    // $(PolymerUtils.getElementById(this.prefix + "tableAnalysis")).bootstrapTable("updateCell",{ index: selectedRow, field: "subjectSelected", value: _this.subjectFormatter(this.currentAnalysis.analysisIDinternal,samples, subjectSelected)});
                    // $(PolymerUtils.getElementById(this.prefix + "tableAnalysis")).bootstrapTable("updateCell",{ index: selectedRow, field: "diseaseSelected", value: _this.diseaseFormatter(this.currentAnalysis.analysisIDinternal, samples, family.phenotypes , diseaseSelected)});
                    PolymerUtils.getElementById(this.prefix + 'selectedSubject' + this.currentAnalysis.analysisIDinternal).addEventListener('change', e => this.selectSubject(e));
                    PolymerUtils.removeAttribute(this.prefix + "Save" + this.currentAnalysis.analysisIDinternal, "disabled");
                    PolymerUtils.removeClass(this.prefix + "Save" + this.currentAnalysis.analysisIDinternal, "disabled");
                    $(PolymerUtils.getElementById(this.prefix + "FamilyEditor")).modal('hide');
                }

                this.messageErrorFamily = messageErrorFamily.slice();
            }
        }

        customElements.define(VariantClinicalSamples.is, VariantClinicalSamples);
    </script>
</dom-module>
