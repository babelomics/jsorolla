<link rel="import" href="../opencga-message-dialog.html">

<dom-module id="clinical-family-relations-editor">
    <template>
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Edit family relations</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- main body -->
                    <template is="dom-if" if="[[!individuals.length]]">
                        <div class="alert alert-warning" role="alert">
                            <h4>No individual selected, please select some individuals.</h4>
                        </div>
                    </template>
                    <template is="dom-if" if="[[individuals.length]]">
                        <template is="dom-repeat" items="{{messageError}}" as="message">
                            <div class="alert alert-danger" role="alert">
                                [[message]]
                            </div>
                        </template>
                        <div class="col-md-12">
                            <form class="form-inline">
                                <div class="form-group">
                                    <label>
                                        ID
                                        <input type="text" class="form-control" placeholder="" maxlength="50" type="number" value="{{newDiseaseId::input}}">
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label>
                                        Name
                                        <input type="text" class="form-control" placeholder="" maxlength="100" type="text" value="{{newDiseaseName::input}}">
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label>
                                        Source
                                        <input type="text" class="form-control" placeholder="" maxlength="100" type="text" value="{{newDiseaseSource::input}}">
                                    </label>
                                </div>
                                <button  class="btn btn-secondary" type="button" disabled="[[!isAddDiseaseButtonEnabled]]" on-click="addDisease">Add disease</button>
                            </form>
                            <div class="col-md-12">
                                <div class="row">
                                    <ul class="list-group">
                                        <template is="dom-repeat" items="[[diseases]]" as="disease">
                                            <li class="list-group-item">[[disease.name]]([[disease.id]])</li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <table class="table hover">
                                <thead>
                                    <tr class="active">
                                        <th>Individual ID</th>
                                        <th>Father</th>
                                        <th>Mother</th>
                                        <th>Phenotypes</th>
                                        <th>Deceased</th>
                                        <th>Parental Consanguinity</th>
                                        <th>Sex</th>
                                    </tr>
                                </thead>

                                <tbody>
                                <template is="dom-repeat" items="{{individuals}}" as="individual">
                                    <tr>
                                        <td>[[individual.name]]</td>
                                        <td>
                                            <template is="dom-if" if="{{showSelectParents}}">
                                                <div class="dropdown">
                                                    <select class="form-control"
                                                            data-individual-id$="[[individual.id]]"
                                                            data-is-father="true"
                                                            on-change="selectParent">
                                                        <option value="none">Select an individual...</option>
                                                        <template is="dom-repeat" items="{{getPotentialFathersFor(individual, potentialParents)}}" as="individualFather">
                                                            <option value="[[individualFather.id]]" selected$="[[isSelectedParent(0, individualFather.id, individual.id)}}">
                                                                [[individualFather.name]]
                                                            </option>
                                                        </template>
                                                    </select>
                                                </div>
                                            </template>
                                            <template is="dom-if" if="{{!showSelectParents}}">
                                                <span>Unknown</span>
                                            </template>
                                        </td>
                                        <td>
                                            <template is="dom-if" if="{{showSelectParents}}">
                                                <div class="dropdown">
                                                    <select class="form-control"
                                                            data-individual-id$="[[individual.id]]"
                                                            data-is-mother="true"
                                                            on-change="selectParent">
                                                        <option value="none">Select an individual...</option>
                                                        <template is="dom-repeat" items="{{getPotentialMothersFor(individual, potentialParents)}}" as="individualMother">
                                                            <option value="[[individualMother.id]]" selected$="[[isSelectedParent(1, individualMother.id, individual.id)]]">
                                                                [[individualMother.name]]
                                                            </option>
                                                        </template>
                                                    </select>
                                                </div>
                                            </template>
                                            <template is="dom-if" if="{{!showSelectParents}}">
                                                <span>Unknown</span>
                                            </template>
                                        </td>

                                        <td style="width: 150px;">
                                            <template is="dom-repeat" items="{{diseases}}" as="disease">
                                                <input data-individual-id$="{{individual.id}}"
                                                    data-disease-id$="{{disease.id}}"
                                                    checked$="{{isCheckedDisease(individual.id, disease.id)}}"
                                                    type="checkbox" on-change="onDiseasedChanged">
                                                {{disease.id}}
                                                <br>
                                            </template>
                                        </td>
                                        <td>
                                            <input type="checkbox"
                                                    on-change="onDeceasedChanged"
                                                    checked$="[[isCheckedDeceased(individual.id)]]"
                                                    data-individual-id$="[[individual.id]]">
                                        </td>
                                        <td>
                                            <input type="checkbox" on-change="selectParentalConsanguinity"
                                                checked$="[[individual.parentalConsanguinity]]"
                                                data-individual-id$="{{individual.id}}">
                                        </td>
                                        <td>
                                            <span>[[individual.sex]]</span>
                                        </td>
                                    </tr>
                                </template>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-12">
                            <div id="[[prefix]]PedigreeView"></div>
                        </div>

                        <opencga-message-dialog
                                opencga-client="{{opencgaClient}}"
                                show-message-modal="{{showMessageModal}}"
                                settings-message-modal="{{settingsMessageModal}}">
                        </opencga-message-dialog>
                    </template>
                    <!-- end of main body -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" on-click="onSaveAndClose">OK</button>
            </div>
        </div>
    </template>

    <script>
        class ClinicalFamilyRelationsEditor extends Polymer.Element {

            /*
            we should update the pedigree render whenever changes
            father.id, mother.id, phenotypes, lifeStatus, parentalConsanguinity
            */

            static get is() {
                return 'clinical-family-relations-editor';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object,
                        observer: 'onSamplesChanged',
                    },
                    opencgaClient: {
                        type: Object
                    },
                    samples: {
                        type: Array,
                        observer: 'onSamplesChanged',
                    },
                    individuals: {
                        type: Array,
                        value: [],
                        observer: 'onIndividualsChanged',
                    },
                    potentialParents: {
                        type: Object,
                        observer: 'onPotentialParentsChange',
                        value: {a: 0},
                    },
                    // disease form (should be an independent component)
                    diseases: {
                        type: Array,
                        value: () => [],
                    },
                    newDiseaseId: {
                        type: String,
                        value: () => "",
                        observer: "onNewDiseaseChanged",
                    },
                    newDiseaseName: {
                        type: String,
                        value: () => "",
                        observer: "onNewDiseaseChanged",
                    },
                    newDiseaseSource: {
                        type: String,
                        value: () => "",
                    },
                    isAddDiseaseButtonEnabled: {
                        type: Boolean,
                        value: false,
                    },
                    showSelectParents: {
                        type: Boolean,
                        computed: 'computeShowSelectParents(individuals)',
                    },
                    prefix: {
                        type: String,
                        readOnly: true,
                    },
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            clear() {
                this.newDiseaseId = "";
                this.newDiseaseName = "";
                this.newDiseaseSource = "";
                this.diseases = [];
            }

            constructor() {
                super();
                this.clear();
                this._setPrefix(`FamEditor${Utils.randomString(6)}`);
            }

            populateDiseases() {
                this.diseases = (this.individuals || [])
                    .map(individual => (!!individual.phenotypes && individual.phenotypes) || [])
                    .filter(phenotypes => phenotypes.length > 0)
                    .reduce((phenotypes, newPhenotypes) => phenotypes.concat(
                        newPhenotypes.filter(phenotype => !phenotypes.some(disease => disease.id === phenotype.id))
                        ), []);
            }

            addDisease(e) {
                if (!!this.newDiseaseId && !!this.newDiseaseName && !this.diseases.some(disease => disease.id === this.newDiseaseId)) {
                    const disease = { id: this.newDiseaseId, name: this.newDiseaseName, source: this.newDiseaseSource };
                    this.push('diseases', disease);
                    this.newDiseaseId = "";
                    this.newDiseaseName = "";
                    this.newDiseaseSource = "";
                }
            }

            removeDisease(e) {
                const diseaseToRemove = JSON.parse(e.target.getAttribute("data-selected-term"));
                if (!!diseaseToRemove.id)  return;

                // remove the disease from the individuals
                for (let idx=0; idx<this.individuals.length; ++idx) {
                    const individual = this.individuals[idx];
                    if ((individual.phenotypes || []).some(disease => disease.id === diseaseToRemove.id)) {
                        this.set(`individuals.${idx}.phenotypes`, individual.phenotypes.filter(disease => (disease.id !== diseaseToRemove.id)));
                    }
                }
                this.set('diseases', this.diseases.filter(disease => (disease.id !== diseaseToRemove.id)));
            }

            computeShowSelectParents() {
                return !!this.individuals && (this.individuals.length > 1);
            }

            getIndividual(individualId) {
                return !individualId || !this.individuals ? null : this.individuals.find(individual => individual.id === individualId);
            }

            isCheckedDisease(individualId, diseaseId) {
                const individual = this.getIndividual(individualId);
                return (!!individual && !!individual.phenotypes)
                    ? individual.phenotypes.some(disease => (disease.id === diseaseId))
                    : false;
            }

            isCheckedParentalConsanguinity(individualId) {
                const individual = this.getIndividual(individualId);
                return !!individual && !!individual.parentalConsanguinity;
            }

            isCheckedDeceased(individualId) {
                const individualSelected = this.getIndividual(individualId);
                return !!individualSelected && individualSelected.lifeStatus === "DECEASED";
            }

            isSelectedParent(isMother, parentId, individualId) {
                const individual = this.getIndividual(individualId);
                const individualParent = this.getIndividualParent(individual, isMother);
                return (individualParent && individualParent.id == parentId);
            }

            getIndividualParent(individual, mother) {
                return !!mother
                    ? !!individual && !!individual.mother && !!individual.mother.id && this.getIndividual(individual.mother.id)
                    : !!individual && !!individual.father && !!individual.father.id && this.getIndividual(individual.father.id);
            }

            isAncestor(ancestor, descendant) {
                // TODO: fix case of previously existing cycles
                if (!ancestor || !descendant || ancestor === descendant)    return false;
                const descendantMother = this.getIndividualParent(descendant, true);
                const descendantFather = this.getIndividualParent(descendant, false);
                return (!!descendantMother && descendantMother.id === ancestor.id)
                    || (!!descendantFather && descendantFather.id === ancestor.id)
                    || (!!descendantMother && this.isAncestor(ancestor, descendantMother))
                    || (!!descendantFather && this.isAncestor(ancestor, descendantFather));
            }

            getPotentialFathersFor(individual, potentialParents) {
                return this.individuals.filter(s => (s !== individual && (s.sex === 'MALE') && !this.isAncestor(individual, s)));
            }

            getPotentialMothersFor(individual, potentialParents) {
                return this.individuals.filter(s => (s !== individual && (s.sex === 'FEMALE') && !this.isAncestor(individual, s)));
            }

            onPotentialParentsChange() {
            }

            invalidatePotentialParents() {
                this.potentialParents = Object.assign({}, this.potentialParents, {a: this.potentialParents.a+1});
            }

            isDisabledParent(isMother, parentId, individualId) {
                const individualSelected = this.getIndividual(individualId);
                const individualCurrentParent = this.getIndividual(parentId);
                let parentSelected = false;

                const gender = isMother ? "FEMALE" : "MALE";
                if(!!individualSelected && !!individualCurrentParent && !!individualCurrentParent.name) {
                        parentSelected = (individualSelected.id === individualCurrentParent.id || individualCurrentParent.sex !== gender);
                }

                parentSelected = parentSelected || this.isAncestor(individualSelected, individualCurrentParent);

                return parentSelected;
            }

            onDiseasedChanged(e) {
                const individualId = parseInt(e.target.getAttribute("data-individual-id"));
                const diseaseId = e.target.getAttribute("data-disease-id");
                const individual = this.getIndividual(individualId);
                if (!!individual) {
                    const isDiseased = (individual.phenotypes || []).some(disease => (disease.id === diseaseId));
                    if (isDiseased) {
                        individual.phenotypes = (individual.phenotypes || []).filter(disease => (disease.id !== diseaseId));
                    } else {
                        const disease = this.diseases.find(disease => (diseaseId === disease.id));
                        individual.phenotypes.push(disease);
                    }
                }
            }

            onDeceasedChanged(e) {
                const status = !!e && !!e.target && !!e.target.checked ? 'DECEASED' : 'UNKNOWN';
                const individualId = parseInt(!!e && !!e.target && e.target.getAttribute("data-individual-id"));
                const individual = this.getIndividual(individualId);
                if(!!individual) {
                    individual.lifeStatus = (e.target.checked ? 'DECEASED' : 'UNKNOWN');
                }
            }

            selectParentalConsanguinity(e) {
                const consanguinity = !!e && !!e.target && !!e.target.checked;
                const individualId = parseInt(!!e && !!e.target && e.target.getAttribute("data-individual-id"));
                const individual = this.getIndividual(individualId);
                if(!!individual) {
                    individual.parentalConsanguinity = consanguinity;
                }
            }

            selectParent(e) {
                const individualId = e.target.getAttribute("data-individual-id");
                const parentId = ("none" === e.target.value ? null : parseInt(e.target.value));
                const isFather = (e.target.getAttribute("data-is-father") === "true");
                const isMother = (e.target.getAttribute("data-is-mother") === "true");
                const individual = this.getIndividual(individualId);
                if (!!individual) {
                    const parent = this.getIndividual(parentId);
                    // TODO: why are we setting individual's sex here???
                    individual.sex = individual.sex || "UNKNOWN";
                    if (!!parent) {
                        parent.sex = (isMother ? 'FEMALE' : (isFather? 'MALE' : "UNKNOWN"));
                    }
                    if (isMother || isFather) {
                        const parentProxy = !!parent ? {id: parent.id, name: parent.name, sex: parent.sex } : null;
                        individual[isMother ? "mother" : "father"] = parentProxy;
                    }
                    this.invalidatePotentialParents();
                }
            }

            fillParentNames() {
                for (const individual of (this.individuals || [])) {
                    const relations = ["father", "mother"];
                    for (const relation of relations) {
                        if (!!individual[relation] && !!individual[relation].id && individual[relation].id>0) {
                            const parentId = individual[relation].id;
                            const parent = this.getIndividual(parentId);
                            if (!!parent) {
                                individual[relation].name = parent.name;
                            }
                        }
                    }
                }
            }

            renderPedigree() {
                if (!this.showSelectParents)    return;

                const pedigreeView = PolymerUtils.getElementById(this.prefix + "PedigreeView");
                if (!pedigreeView) return;

                if (!!this.svg) {
                    pedigreeView.removeChild(this.svg);
                }

                // const members = Object.assign({}, this.samples.members);
                // const body = Object.assign({}, this.family);

                // Render new Pedigree
                // const pedigree = new Pedigree(body, { selectShowSampleNames: true });
                // this.svg = pedigree.pedigreeFromFamily(pedigree.pedigree);
                // this.svg.style = "display: block; margin: auto";
                // pedigreeView.appendChild(this.svg);
            }

            onSamplesChanged() {
                this.readIndividualsFromServer();
            }

            readIndividualsFromServer() {
                if (!this.samples)  return;

                const individualIds = this.samples
                    .filter(sample => !!sample.individual && !!sample.individual.id && sample.individual.id>0)
                    .map(sample => sample.individual.id)
                    .reduce((acc, id) => acc.includes(id) ? acc : [...acc, id], []);
                const params = { study: this.opencgaSession.study.alias };
                const pthis = this;
                const updatePromises = individualIds.map(individualId => (
                    this.opencgaClient.individuals().info(individualId, params, {method: "GET"}).then(response => (
                        response.response[0].numResults > 0 ? response.response[0].result[0] : null
                    ))
                ));

                Promise.all(updatePromises).then(individuals => {
                    pthis.individuals = individuals.filter(individual => !!individual);
                }).catch(response => {
                    pthis.settingsMessageModal = {
                        messageHeader: "Error",
                        messageBody: [ response.error ],
                        type: "danger",
                        height: "100px",
                        width: "500px"
                    };
                    pthis.showMessageModal = true;
                    pthis.set('settingsMessageModal', pthis.settingsMessageModal);
                    pthis.individuals = [];
                });
            }

            saveIndividual(individual) {
                if (!individual.id) return Promise.resolve();
                else {
                    const individualToSave = {
                        // id: individual.id,
                        // name: individual.name,
                        sex: individual.sex,
                        phenotypes: individual.phenotypes,
                        parentalConsanguinity: !!individual.parentalConsanguinity,
                        lifeStatus: individual.lifeStatus,
                    };
                    if (!!individual.mother && !!individual.mother.id && individual.mother.id>0) {
                        individualToSave.mother = { id: individual.mother.id, name: individual.mother.name };
                    }
                    if (!!individual.father && !!individual.father.id && individual.father.id>0) {
                        individualToSave.father = { id: individual.father.id, name: individual.father.name };
                    }
                    const params = {
                        study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias
                    };
                    return this.opencgaClient.individuals().update(individual.id, params, individualToSave, {"method": "POST"});
                }
            }

            onIndividualsChanged() {
                this.fillParentNames();
                this.populateDiseases();

                this.newDiseaseId = "";
                this.newDiseaseName = "";
                this.newDiseaseSource = "";
            }

            onNewDiseaseChanged() {
                this.isAddDiseaseButtonEnabled = !!this.newDiseaseId && !!this.newDiseaseName && !this.diseases.some(disease => disease.id === this.newDiseaseId.trim());
            }

            onSaveAndClose(e) {
                e.preventDefault();

                // save our changed
                const promises = this.individuals.map(individual => this.saveIndividual(individual));
                const pthis = this;
                Promise.all(promises).then(response => {
                    const params = { detail: {}, bubbles: true, composed: true };
                    pthis.dispatchEvent(new CustomEvent("close", params));
                }).catch(response => {
                    pthis.settingsMessageModal = {
                        messageHeader: "Error",
                        messageBody: [ response.error ],
                        type: "danger",
                        height: "100px",
                        width: "500px"
                    };
                    pthis.showMessageModal = true;
                    pthis.set('settingsMessageModal', pthis.settingsMessageModal);
                    // pthis.individuals = [];
                    const params = { detail: {}, bubbles: true, composed: true };
                    pthis.dispatchEvent(new CustomEvent("close", params));
                });
            }
        }

        customElements.define(ClinicalFamilyRelationsEditor.is, ClinicalFamilyRelationsEditor);
    </script>
</dom-module>